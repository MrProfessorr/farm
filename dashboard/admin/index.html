<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Farm Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{
      --btn:#1668dc; --btnH:#3c89e8; --btnA:#1554ad;
      --bg:#070b16; --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:#eaf1ff; --muted:rgba(234,241,255,.7);
      --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
      background:#000;
      min-height:100vh;
    }

    header{
      height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 16px;
      position:sticky; top:0; z-index:50;
      background:#001529;
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke);
    }
    .right{display:flex; align-items:center; gap:5px}
    .btn-delete{
      border: 1px solid rgb(196 19 19); 
      border-radius:6px; padding: 8px 10px; cursor:pointer;
      background: rgb(0 0 0 / 0%);
      color:#f52020; font-weight:400;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      font-size: 14px;height: 32px;
      transition: all 0.2s;
    }
    .btn-edit{
      border: 1px solid rgba(22, 104, 220, .45); 
      border-radius:6px; padding: 8px 10px; cursor:pointer;
      background: rgba(22, 104, 220, .18); 
      color:white; font-weight:400;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      font-size: 14px;height: 32px;
      transition: all 0.2s;
    }
    .btn-modal{
      border:0; border-radius:6px;padding: 0px 15px; cursor:pointer;
      background:#141414; color:#008000; border:1px solid #424242;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      height: 32px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-modal:hover{border: 1px solid #3c89e8;}
    .walletBtn:hover .walletIcon{color:#3c89e8;}
    .btn-modal:active{border: 1px solid #1554ad;}
    .walletBtn:active .walletIcon{color:#1554ad;}
    .walletBtn{
      display:flex;
      align-items:center;
      gap:8px;
      transition: all 0.2s;
    }
    .walletIcon{
     display:flex;
     align-items:center;
     transition: all 0.2s;
     color: white;
    }
    .btn-view{
      border: 1px solid var(--stroke); border-radius:6px; padding: 8px 10px; cursor:pointer;
      background:var(--btn); color:white; font-weight:400;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      font-size: 14px;height: 32px;
      transition: all 0.2s;
    }
    .btn-view:hover{background:#3c89e8;}
    .btn-view:active{background:#1554ad;}
    .btn-user{
      border:0; border-radius:6px;padding: 0px 15px; cursor:pointer;
      background:#141414; color:white; border:1px solid #424242;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      height: 32px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-user:hover{border: 1px solid #3c89e8;color:#3c89e8;}
    .btn-user:active{border: 1px solid #1554ad;color:#1554ad;}
    .btn-logout{
      border:0; border-radius:6px; padding:0px 15px; cursor:pointer;
      background:#d11f3a; color:white;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      transition: all 0.2s;
      font-size: 14px;height: 32px;
    }
    .btn-logout:hover{background:#e2445b;}
    .btn-logout:active{background:#b31930;}
    .btn{
      border:0; border-radius:6px; padding: 0px 15px; cursor:pointer;
      background:var(--btn); color:white; font-weight:400;
      transition:.15s transform, .15s background;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      font-size: 14px;height: 32px;
      transition: all 0.2s;
    }
    .btn:hover{background:var(--btnH)}
    .btn:active{background:var(--btnA); transform: translateY(1px)}
    .btn.ghost{
      background:rgba(255,255,255,.06); border:1px solid var(--stroke); color:var(--txt);
    }
    .btn.ghost:hover{background:rgba(255,255,255,.10)}
    .pill {
     padding: 0px 15px;
     border: 1px solid #303030;
     background: #141414;
     border-radius: 6px;
     color: var(--muted);
     font-size: 14px;
     height: 32px;
     text-align: center;
     align-content: center;
     font-weight:600;
    }
    .container{width:min(1200px,100%); margin:16px auto; padding:0 16px 24px}
    .topRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin:14px 0 12px;
    }
    .tabs{display:flex; gap:5px; align-items:center}
    .tab {
    border: 1px solid var(--stroke);
    background: rgba(255, 255, 255, .06);
    color: rgba(255, 255, 255, .85);
    border-radius: 999px;
    padding: 0px 15px;
    cursor: pointer;
    height: 32px;
    align-items: center;
    font-size: 14px;
    }
    .tab.active{background:rgba(22,104,220,.18); color:var(--txt); border-color:rgba(22,104,220,.45)}
    .actions{display:flex; gap:5px; align-items:center; flex-wrap:wrap}
    .hint{color:var(--muted); font-size:12px; line-height:1.4}

    .grid{display:grid; gap:12px}
    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: #1f1f1f;
    }
    .title{
      font-weight:700; font-size:16px; margin:0;
    }
    .sub{margin-top:4px; color:rgba(255,255,255,.85); font-size:11px;}
    .vaultBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .cardBody{padding:12px 14px 14px}

    /* Excel-like table */
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); text-align: center;;}
    th{
      position:sticky; top:0;
      background:#1d1d1d;
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      font-size:12px; letter-spacing:.2px;
      color:rgba(255, 255, 255, 0.85);
      z-index:1;
      font-weight:600;
      font-size:14px;
      text-align: center;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    .tblWrap{max-height:360px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:14px}
    .num{font-variant-numeric: tabular-nums}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:0px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px; font-weight:600;
      white-space:nowrap;
    }
    .tag.in{border-color:rgba(34,197,94,.35); color:rgba(186,255,214,.95); background:rgba(34,197,94,.12)}
    .tag.out{border-color:rgba(239,68,68,.35); color:rgba(255,204,204,.95); background:rgba(239,68,68,.12)}
    .tag.buy{border-color:rgba(245,158,11,.35); color:rgba(255,229,191,.95); background:rgba(245,158,11,.12)}
    .tag.sell{border-color:rgba(34,197,94,.35); color:rgba(186,255,214,.95); background:rgba(34,197,94,.12)}
    .profit.good{color:rgb(255 191 0);}
    .profit.bad{color:rgb(255 0 0);}

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:100;
    }
    .modal{
      width:min(640px,100%);
      background:#1f1f1f;
      border:1px solid #303030;
      border-radius:12px;
      box-shadow: 0 24px 90px rgba(0,0,0,.6);
      overflow:hidden;
      transition: all 0.2s;
    }
    .modalHead{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead .x{
      border:none;
      background:transparent;
      color:rgba(255,255,255,.85);
      cursor:pointer;
      display:grid; place-items:center;
      transition: all 0.2s;
    }
    .x:hover{color:#fff;}
    .x:active{transform:translateY(1px);color:rgba(255,255,255,.65);}
    .modalBody{padding:12px 14px 14px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    label{display:block; margin:10px 0 6px; color:var(--muted); font-weight:400; font-size:12px}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:8px;
      border:1px solid rgba(255,255,255,.12);
      background:#141414;
      color:rgba(255,255,255,.85);
      outline:none;
      transition: all 0.2s;
    }
    input:focus,select:focus,textarea:focus{border-color:#1668dc;}
    input:hover,select:hover,textarea:hover{border-color:#3c89e8;}
    textarea{min-height:84px; resize:vertical}
    .modalFoot{
      display:flex; justify-content:flex-end; gap:10px;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
    }
    .danger{background:#d11f3a}
    .danger:hover{background:#e2445b}
    .danger:active{background:#b31930}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.78); color:var(--txt);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; display:none;
      max-width:min(720px,92vw);
      z-index:999;
    }
    .hr{height:1px;background:rgba(255,255,255,.10); margin:12px 0}
    .kpiRow{display:flex; gap:10px; flex-wrap:wrap}
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      padding:10px 12px; border-radius:10px;
      min-width: 133px;background: #141414;
    }
    .kpi .k{font-size:12px; color:var(--muted); font-weight:500}
    .kpi .v{margin-top:6px; font-weight:500; font-size:14px}
    .hide{display:none !important}
    .amtNeg{ color:red; }
    .good{ color:#008000;}
    .bad{ color:red;}
    /* ===== TABLE WRAP: boleh scroll kiri/kanan + atas/bawah ===== */
.tblWrap{
  width:100%;
  overflow-x:auto;     /* scroll kanan kiri */
  overflow-y:auto;     /* scroll atas bawah (kalau tinggi) */
  -webkit-overflow-scrolling: touch;
  border-radius: 14px;
}

/* Paksa table tak wrap, supaya tak turun line */
.tblWrap table{
  width:100%;
  min-width: 980px;          /* penting: kalau screen kecil, dia akan scroll */
  border-collapse: collapse;
  table-layout: auto;
  background:#141414;
  font-size:14px;
  color:rgba(255, 255, 255, 0.85);
}

/* Semua cell jangan wrap */
.tblWrap th,
.tblWrap td{
  white-space: nowrap;       /* ini yang buat text & button tak turun */
}

/* Kalau kau nak Description masih boleh panjang tanpa wrap, tapi ada ellipsis */
.tblWrap td:nth-child(2){
  max-width: 420px;          /* adjust ikut suka */
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Actions jangan turun & spacing kemas */
.tblWrap td:last-child > div{
  flex-wrap: nowrap !important;
}

/* ===== Scrollbar style (grey, clean) ===== */
/* Chrome/Edge/Safari */
.tblWrap::-webkit-scrollbar{
  height: 10px;  /* horizontal */
  width: 10px;   /* vertical */
}
.tblWrap::-webkit-scrollbar-track{
  background: rgba(255,255,255,.06);
  border-radius: 999px;
}
.tblWrap::-webkit-scrollbar-thumb{
  background: rgba(160,160,160,.45); /* grey */
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.25);
}
.tblWrap::-webkit-scrollbar-thumb:hover{
  background: rgba(190,190,190,.65);
}

/* Firefox */
.tblWrap{
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.25) rgba(253, 253, 253, 0.12);
}
/* ===== CUSTOM SELECT (Replace browser <select>) ===== */
select.native-select {
  position:absolute !important;
  opacity:0 !important;
  pointer-events:none !important;
  width:0 !important;
  height:0 !important;
}

/* wrapper auto created by JS */
.cs {
  position: relative;
  width: 100%;
  user-select: none;
}
.cs__btn{
  width: 100%;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor:pointer;
  background: #141414;
  border: 1px solid #303030;
  color:#1668dc;
  outline:none;
  transition: all 0.2s;
}
.cs__btn:hover{border-color:#3c89e8;}.cs__btn:focus{border-color:#1668dc;}

.cs__value{
  font-weight: 700;
  letter-spacing:.2px;
}

.cs__arrow{
  opacity:.9;
  font-size: 12px;
  color: #1668dc;
  transform: translateY(-1px);
}

/* dropdown menu */
.cs__menu{
  position:absolute;
  left:0;
  top: calc(100% + 6px);
  width:100%;
  z-index: 99999;
  border-radius: 12px;
  overflow: hidden;
  background: #141414;
  border: 1px solid #303030;
  box-shadow: 0 16px 40px rgba(0,0,0,.45);
  display:none;
}

.cs.open .cs__menu{ display:block; }

.cs__opt{
  padding: 10px 12px;
  cursor:pointer;
  color:#1668dc;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap:10px;
}

.cs__opt:hover{ background: rgba(255, 255, 255, .03); }
.cs__opt[aria-selected="true"]{
  background: rgba(255,255,255,.10);
}

.cs__hint{
  font-size: 12px;
  opacity:.65;
}
/* Buang arrow (spinner) untuk input number - Chrome/Edge/Safari */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{
  -webkit-appearance: none;
  margin: 0;
}

/* Buang arrow (spinner) untuk Firefox */
input[type="number"]{
  -moz-appearance: textfield;
  appearance: textfield;
}
/* ===== KPI TABLE (BUY LEFT / SELL RIGHT) ===== */
.kpiSplit{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin:12px 0 10px;
  font-size:14px;
}
@media (max-width: 900px){
  .kpiSplit{ grid-template-columns: 1fr; } /* phone: kanan turun bawah */
}

.kpiTableCard{
  background:#141414;                 /* match theme kau */
  border:1px solid #303030;
  border-radius:8px 8px 0 0;
  overflow:hidden;
}

.kpiTableHead{
  padding:12px 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.85);
  border-bottom: 1px solid #303030;
  background:#1d1d1d;
  text-align: center;
}

.kpiTable{
  width:100%;
  border-collapse:collapse;
}

.kpiTable td{
  padding:10px 14px;
  border-bottom: 1px solid #303030;
}

.kpiTable tr:last-child td{ border-bottom:0; }
.kpiTable td:first-child{
  text-align:left;
  color:rgba(255, 255, 255, 0.85);
  font-weight:400;
  border-right: 1px solid #303030;
}
.kpiTable td:last-child{
  text-align:right;
  font-variant-numeric: tabular-nums;
  font-weight:400;
  color:#008000;
}

/* guna class .good/.bad kau yang memang dah ada */
.kpiTable .kpiGood{ color:#008000!important; }
.kpiTable .kpiBad{ color:red!important; }
/* ===== USER DROPDOWN ===== */
.userDrop{ position:relative; }

.btn-user{
  display:inline-flex;
  align-items:center;
  gap:8px;
}

.btn-user .caret{ opacity:.8; font-size:12px; transform: translateY(-1px); }

.userMenu{
  position:absolute;
  right:0;
  top: calc(100% + 8px);
  min-width: 200px;
  background: #1f1f1f;
  border: 1px solid #303030;
  border-radius: 6px;
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  padding: 8px;
  display:none;
  z-index: 999999;
}

.userDrop.open .userMenu{ display:block; }

.userMenuItem{
  width:100%;
  border:1px solid #303030;
  background: #141414;
  color: rgba(255,255,255,.85);
  border-radius: 6px;
  padding: 0px 15px;
  cursor:pointer;
  display:grid;
  grid-template-columns: 24px 1fr 24px; /* icon kiri, text center, spacer */
  align-items:center;
  gap:10px;
  transition: .15s background, .15s border-color;
  height:32px;
  font-size:14px;
  transition: all 0.2s;
}
.userMenuItem:hover{border-color: #3c89e8;color:#3c89e8;}
.userMenuItem:active{border-color: #1554ad;color:#1554ad;}

.userMenuItem .miIcon{ display:grid; place-items:center; opacity:.95; }
.userMenuItem .miText{ text-align:center;}
.rangeBar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0 14px;flex-wrap:wrap}
.rangeLeft{flex:1 1 260px;min-width:220px}
.dateRangeInput{
  width:100%;
  background:#141414;
  border:1px solid #303030;
  border-radius:8px;
  padding:0px 15px;
  outline:0;
  color:rgba(255, 255, 255, 0.85);
  letter-spacing:.2px;
  text-align: center;
  height:32px;
  transition: all 0.2s;
}
.dateRangeInput:hover{border-color: #3c89e8;}.dateRangeInput:focus{border-color:#1668dc!important;}
.rangeRight{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pbtn{background:transparent;color:rgba(255, 255, 255, 0.85);padding:0px 15px;border:none;cursor:pointer;white-space:nowrap;font-size:14px;transition: all 0.2s;}
.pbtn:hover{color:#3c89e8}.pbtn:active{color:#1554ad}
.pbtn.active{color:#1668dc;}
@media (max-width:520px){.rangeRight{justify-content:flex-start}.pbtn{font-size:12px;padding:7px 9px}}
  @media (max-width: 520px){
  .flatpickr-calendar{
    left: 50% !important;
    right: auto !important;
    transform: translateX(-50%) !important;
    max-width: calc(100vw - 16px) !important;
    z-index: 999999 !important;
  }
}
.iconBtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background:transparent;
  border:none;
  cursor:pointer;
  transition: all 0.2s;
}

.icoRefresh{
  fill:#e9ecff;
  transition: fill .2s ease, transform .2s ease;
}
.icoRefresh:hover{fill:#3c89e8;}.icoRefresh:active{fill:#1554ad;}
.iconBtn.spinning .icoRefresh{
  animation: spin360 .7s linear infinite;
}
@keyframes spin360{
  to{ transform:rotate(360deg); }
}
.txTimeRow{
  display:flex;
  gap:10px;
  align-items:center;
}
.txTimeRow input{ flex:1; min-width:0; }
.txTimeRow .btn{ white-space:nowrap; }

@media (max-width:520px){
  .txTimeRow{ flex-direction:column; align-items:stretch; }
  .txTimeRow .btn{ width:100%; }
}

  </style>
</head>

<body>
<header>
  <div class="pill" id="rolePill">loading...</div>
  <div class="right">
  <button class="btn-modal walletBtn" id="btnBalance">
  <span class="walletIcon" aria-hidden="true">
    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
      <path d="M5 19V5zm0 2q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h14q.825 0 1.413.588T21 5v2.5h-2V5H5v14h14v-2.5h2V19q0 .825-.587 1.413T19 21zm8-4q-.825 0-1.412-.587T11 15V9q0-.825.588-1.412T13 7h7q.825 0 1.413.588T22 9v6q0 .825-.587 1.413T20 17zm7-2V9h-7v6zm-4-1.5q.625 0 1.063-.437T17.5 12t-.437-1.062T16 10.5t-1.062.438T14.5 12t.438 1.063T16 13.5"/>
    </svg>
  </span>

  <span class="num" id="balanceText">0.00</span>
</button>
  <!-- USER DROPDOWN -->
  <div class="userDrop" id="userDrop">
    <button class="btn-user" id="btnUser" type="button" aria-haspopup="menu" aria-expanded="false">
      <span class="userIcon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
          <path d="M12 12a4 4 0 1 0-4-4a4 4 0 0 0 4 4zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5z"/>
        </svg>
      </span>
      <span id="usernameText">user</span>
      <span class="caret" aria-hidden="true">‚ñæ</span>
    </button>

    <div class="userMenu" id="userMenu" role="menu">
      <button class="userMenuItem" id="btnLogout" type="button" role="menuitem">
        <span class="miIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
            <path d="M3 21V3h9v2H5v14h7v2zm13-4l-1.375-1.45l2.55-2.55H9v-2h8.175l-2.55-2.55L16 7l5 5z"/>
          </svg>
        </span>
        <span class="miText">Logout</span>
      </button>
    </div>
  </div>

  <button id="btnRefresh" class="iconBtn" type="button" title="Refresh" aria-label="Refresh">
  <svg class="icoRefresh" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <path d="m21.897 13.404.008-.057v.002c.024-.178.044-.357.058-.537.024-.302-.189-.811-.749-.811-.391 0-.715.3-.747.69-.018.221-.044.44-.078.656-.645 4.051-4.158 7.153-8.391 7.153-3.037 0-5.704-1.597-7.206-3.995l1.991-.005c.414 0 .75-.336.75-.75s-.336-.75-.75-.75h-4.033c-.414 0-.75.336-.75.75v4.049c0 .414.336.75.75.75s.75-.335.75-.75l.003-2.525c1.765 2.836 4.911 4.726 8.495 4.726 5.042 0 9.217-3.741 9.899-8.596zm-19.774-2.974-.009.056v-.002c-.035.233-.063.469-.082.708-.024.302.189.811.749.811.391 0 .715-.3.747-.69.022-.28.058-.556.107-.827.716-3.968 4.189-6.982 8.362-6.982 3.037 0 5.704 1.597 7.206 3.995l-1.991.005c-.414 0-.75.336-.75.75s.336.75.75.75h4.033c.414 0 .75-.336.75-.75v-4.049c0-.414-.336-.75-.75-.75s-.75.335-.75.75l-.003 2.525c-1.765-2.836-4.911-4.726-8.495-4.726-4.984 0-9.12 3.654-9.874 8.426z"/>
  </svg>
</button>
    
  </div>
</header>

<div class="container">
  <div class="topRow">
    <div class="tabs">
      <button class="tab active" id="tabOpen">Open Vault</button>
      <button class="tab" id="tabHistory">History</button>
    </div>

    <div class="actions">
      <button class="btn" id="btnAddPoint">Add Point</button>
      <button class="btn" id="btnNewVault">Open New Vault</button>
    </div>
  </div>

  <!-- OPEN -->
  <div id="viewOpen" class="grid"></div>
  <div id="viewHistory" class="grid hide"></div>
</div>

<div class="toast" id="toast"></div>

<!-- MODALS -->
<div class="modalBack" id="mBalance">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">My Wallet</div>
        <div class="sub">Balance ini digunakan untuk Cash Transfer, Buy dan Sell.</div>
      </div>
      <button class="x" data-close="mBalance">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="kpiRow">
        <div class="kpi">
          <div class="k">Current Balance</div>
          <div class="v num" id="balanceBig">0.00</div>
        </div>
        <div class="kpi">
          <div class="k">Last Update</div>
          <div class="v num" id="balanceUpdated">-</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="hint">Balance disimpan di path: <b>finance/balance</b>. Ledger log disimpan di <b>finance/ledger</b>.</div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mBalance">Close</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mAddPoint">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Add Point (Modal In/Out)</div>
        <div class="sub">Admin sahaja boleh buat ini.</div>
      </div>
      <button class="x" data-close="mAddPoint">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Type</label>
      <select id="apType" class="js-custom-select">
        <option value="in">In</option>
        <option value="out">Out</option>
      </select>

      <div class="row">
        <div>
          <label>Amount</label>
          <input id="apAmount" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label>Note</label>
          <input id="apNote" />
        </div>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mAddPoint">Cancel</button>
      <button class="btn" id="apSave">Save</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mNewVault">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Open New Vault</div>
        <div class="sub">Isi title contoh: ‚ÄúFeb 2026‚Äù, ‚ÄúLot A‚Äù, ‚ÄúBatch 01‚Äù.</div>
      </div>
      <button class="x" data-close="mNewVault">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Title</label>
      <input id="nvTitle" />

      <label>Note (optional)</label>
      <textarea id="nvNote"></textarea>

      <!-- ‚úÖ NEW: Transaction Time -->
      <label>* Transaction Time</label>
      <div class="txTimeRow">
        <input id="txTime_newVault" type="datetime-local" />
        <button id="txTimeToggle_newVault" type="button" class="btn ghost">Unlock</button>
      </div>
      <div class="hint">Jika Lock, masa akan ikut masa sekarang.</div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mNewVault">Cancel</button>
      <button class="btn" id="nvCreate">Create</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mCash">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Cash Transfer</div>
        <div class="sub" id="cashVaultTitle">-</div>
      </div>
      <button class="x" data-close="mCash">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Type</label>
      <select id="cashType" class="js-custom-select">
        <option value="cash_in">Cash-In</option>
        <option value="cash_out">Cash-Out</option>
      </select>

      <div class="row">
        <div>
          <label>Amount</label>
          <input id="cashAmount" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label>Note</label>
          <input id="cashNote" />
        </div>
      </div>

      <!-- ‚úÖ NEW: Transaction Time -->
      <label>* Transaction Time</label>
      <div class="txTimeRow">
        <input id="txTime_cash" type="datetime-local" />
        <button id="txTimeToggle_cash" type="button" class="btn ghost">Unlock</button>
      </div>
      <div class="hint">Jika Lock, masa akan ikut masa sekarang.</div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mCash">Cancel</button>
      <button class="btn" id="cashSave">Save</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mBuy">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Buy</div>
        <div class="sub" id="buyVaultTitle">-</div>
      </div>
      <button class="x" data-close="mBuy">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Category</label>
      <select id="buyCat" class="js-custom-select">
        <option value="baby_pig">Pets</option>
        <option value="feed">Food</option>
        <option value="other">Other</option>
      </select>

      <div class="row">
        <div>
          <label>Quantity</label>
          <input id="buyQty" type="number" min="0" step="1" />
        </div>
        <div>
          <label>Price Quantity</label>
          <input id="buyPrice" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Total Price</label>
          <input id="buyTotal" type="number" min="0" step="0.01" />
          <div class="hint" id="buyBalanceHint"></div>
        </div>
        <div>
          <label>Note</label>
          <input id="buyNote" />
        </div>
      </div>

      <!-- ‚úÖ NEW: Transaction Time -->
      <label>* Transaction Time</label>
      <div class="txTimeRow">
        <input id="txTime_buy" type="datetime-local" />
        <button id="txTimeToggle_buy" type="button" class="btn ghost">Unlock</button>
      </div>
      <div class="hint">Jika Lock, masa akan ikut masa sekarang.</div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mBuy">Cancel</button>
      <button class="btn" id="buySave">Save</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mSell">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Selling</div>
        <div class="sub" id="sellVaultTitle">-</div>
      </div>
      <button class="x" data-close="mSell">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <div>
          <label>Price Quantity</label>
          <input id="sellPriceKg" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label>Total Kg</label>
          <input id="sellKg" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Total Quantity</label>
          <input id="sellEkor" type="number" min="0" step="1" />
          <div class="hint" id="sellEkorHint"></div>
        </div>

        <div>
          <label>Death Pets</label>
          <input id="sellMissing" type="number" disabled placeholder="auto" />
        </div>

        <div>
          <label>Total Amount</label>
          <input id="sellTotal" type="number" min="0" step="0.01" />
        </div>
      </div>

      <label>Note</label>
      <input id="sellNote" />

      <!-- ‚úÖ NEW: Transaction Time -->
      <label>* Transaction Time</label>
      <div class="txTimeRow">
        <input id="txTime_sell" type="datetime-local" />
        <button id="txTimeToggle_sell" type="button" class="btn ghost">Unlock</button>
      </div>
      <div class="hint">Jika Lock, masa akan ikut masa sekarang.</div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mSell">Cancel</button>
      <button class="btn" id="sellSave">Save</button>
    </div>
  </div>
</div>
  
<div class="modalBack" id="mMissing">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Death Pets</div>
        <div class="sub" id="missingVaultTitle">-</div>
      </div>
      <button class="x" data-close="mMissing">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="row">
        <div>
          <label>Quantity Death</label>
          <input id="missQty" type="number" min="0" step="1" />
        </div>
        <div>
          <label>Price Quantity</label>
          <input id="missPrice" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Total Amount</label>
          <input id="missTotal" type="number" disabled placeholder="auto" />
        </div>
        <div>
          <label>Note</label>
          <input id="missNote" />
        </div>
      </div>

      <!-- ‚úÖ NEW: Transaction Time -->
      <label>* Transaction Time</label>
      <div class="txTimeRow">
        <input id="txTime_missing" type="datetime-local" />
        <button id="txTimeToggle_missing" type="button" class="btn ghost">Unlock</button>
      </div>
      <div class="hint">Jika Lock, masa akan ikut masa sekarang.</div>

      <div class="hint">Make sure then Submit.</div>
    </div>

    <div class="modalFoot">
      <button class="btn ghost" data-close="mMissing">Cancel</button>
      <button class="btn" id="missSave">Save</button>
    </div>
  </div>
</div>

<!-- VIEW NOTE MODAL -->
<div class="modalBack" id="mViewNote" style="display:none;">
  <div class="modal" style="max-width:520px;">
    <div class="modalHead" style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-weight:800;">Note</div>
      <button class="btn ghost" data-close="mViewNote" type="button" aria-label="Close">‚úï</button>
    </div>

    <div class="modalBody">
      <div id="viewNoteText" class="hint" style="white-space:pre-wrap;line-height:1.45;"></div>
    </div>

    <div class="modalFoot" style="display:flex;justify-content:flex-end;gap:10px;">
      <button class="btn ghost" data-close="mViewNote" type="button">Close</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getDatabase, ref, get, set, push, update, remove, onValue,
  serverTimestamp, query, orderByChild, limitToLast, runTransaction
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // === CONFIG KAU ===
  const firebaseConfig = {
    apiKey: "AIzaSyCXGxdJOEbcotIXRWyDGHNNCbcmFev-qZY",
    authDomain: "farm-a9071.firebaseapp.com",
    databaseURL: "https://farm-a9071-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "farm-a9071",
    storageBucket: "farm-a9071.firebasestorage.app",
    messagingSenderId: "979250293394",
    appId: "1:979250293394:web:af419dd2b325017a41944b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const $ = (id)=>document.getElementById(id);
  function vaultRefOpen(){
  return ref(db, "vaults/open");
}
function vaultRefHist(){
  return ref(db, "vaults/history");
}
  // ===== CUSTOM SELECT BUILDER =====
function initCustomSelects(root=document){
  const selects = Array.from(root.querySelectorAll("select.js-custom-select"));
  selects.forEach(sel => makeCustomSelect(sel));
}

function makeCustomSelect(selectEl){
  if(selectEl.dataset.csBuilt === "1") return;
  selectEl.dataset.csBuilt = "1";
  selectEl.classList.add("native-select");

  const wrap = document.createElement("div");
  wrap.className = "cs";
  wrap.tabIndex = 0;
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "cs__btn";

  const value = document.createElement("span");
  value.className = "cs__value";

  const arrow = document.createElement("span");
  arrow.className = "cs__arrow";
  arrow.textContent = "‚ñæ";

  btn.appendChild(value);
  btn.appendChild(arrow);

  const menu = document.createElement("div");
  menu.className = "cs__menu";

  function renderValue(){
    const opt = selectEl.options[selectEl.selectedIndex];
    value.textContent = opt ? opt.textContent : "Select...";
  }

  function rebuildOptions(){
    menu.innerHTML = "";
    Array.from(selectEl.options).forEach((o, idx)=>{
      const item = document.createElement("div");
      item.className = "cs__opt";
      item.setAttribute("role","option");
      item.dataset.value = o.value;
      item.dataset.index = String(idx);
      item.textContent = o.textContent;
      item.setAttribute("aria-selected", o.selected ? "true":"false");
      item.addEventListener("click", ()=>{
        
        selectEl.selectedIndex = idx;
        renderValue();
        
        menu.querySelectorAll(".cs__opt").forEach(x=>x.setAttribute("aria-selected","false"));
        item.setAttribute("aria-selected","true");
    
        selectEl.dispatchEvent(new Event("change",{bubbles:true}));
        selectEl.dispatchEvent(new Event("input",{bubbles:true}));

        closeAllCustomSelects();
      });

      menu.appendChild(item);
    });
  }

  function open(){
    closeAllCustomSelects();
    wrap.classList.add("open");
  }
  function close(){
    wrap.classList.remove("open");
  }
  function toggle(){
    wrap.classList.contains("open") ? close() : open();
  }

  btn.addEventListener("click", (e)=>{
    e.preventDefault();
    toggle();
  });
  wrap.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") close();
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      toggle();
    }
  });
  selectEl.parentNode.insertBefore(wrap, selectEl);
  wrap.appendChild(btn);
  wrap.appendChild(selectEl);
  wrap.appendChild(menu);
  rebuildOptions();
  renderValue();
  selectEl.addEventListener("change", ()=>{
    menu.querySelectorAll(".cs__opt").forEach(x=>{
      x.setAttribute("aria-selected", x.dataset.value === selectEl.value ? "true":"false");
    });
    renderValue();
  });

  wrap._csRebuild = rebuildOptions;
}

function closeAllCustomSelects(){
  document.querySelectorAll(".cs.open").forEach(x=>x.classList.remove("open"));
}

document.addEventListener("click", (e)=>{
  if(!e.target.closest(".cs")) closeAllCustomSelects();
});

  const toast = (msg)=>{
    const el = $("toast");
    el.textContent = msg;
    el.style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> el.style.display="none", 2600);
  };

  const fmt = (n)=> (Number(n||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtDT = (ms)=>{
   if(!ms) return "-";
   const d = new Date(ms);
   const pad = (n)=> String(n).padStart(2,"0");
   const day   = pad(d.getDate());
   const month = pad(d.getMonth() + 1);
   const year  = d.getFullYear();
   const hour  = pad(d.getHours());
   const min   = pad(d.getMinutes());
   const sec   = pad(d.getSeconds());
  return `${day}/${month}/${year} ${hour}:${min}:${sec}`;
 };
// TX TIME (admin lock/unlock)
function toLocalInputValue(ms = Date.now()){
  const d = new Date(ms);
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function parseDatetimeLocalToMs(v){
  const s = String(v||"").trim();
  if(!s) return NaN;
  const ms = Date.parse(s);
  return Number.isFinite(ms) ? ms : NaN;
}

function txSettingRef(kind){
  return ref(db, `settings/txTime/allowManual/${kind}`);
}

function initTxTimeControl({ kind, inputId, toggleId }){
  const input = $(inputId);
  const btn = $(toggleId);
  if(!input) return;

  input.value = toLocalInputValue(Date.now());

  if(btn && !me.isAdmin) btn.style.display = "none";

  onValue(txSettingRef(kind), (snap)=>{
    const allow = snap.exists() ? !!snap.val() : false;
    input.disabled = !allow;

    if(btn && me.isAdmin){
      btn.textContent = allow ? "Lock" : "Unlock";
      btn.dataset.allow = String(allow);
    }
  });

  if(btn && me.isAdmin){
    btn.addEventListener("click", async ()=>{
      await runTransaction(txSettingRef(kind), (cur)=> !cur);
    });
  }
}

async function getAtMsFromControl(kind, inputId){
  const allowSnap = await get(txSettingRef(kind));
  const allow = allowSnap.exists() ? !!allowSnap.val() : false;

  if(!allow) return Date.now();

  const ms = parseDatetimeLocalToMs($(inputId)?.value);
  return Number.isFinite(ms) ? ms : Date.now();
}

function resetTxTimeInput(inputId){
  const input = $(inputId);
  if(input) input.value = toLocalInputValue(Date.now());
}

const startOfDayMs = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0).getTime();
const endOfDayMs   = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999).getTime();

const WEEK_START = 1; // Monday
function startOfWeekMs(d){
  const x = new Date(d);
  const day = x.getDay();
  const diff = (day - WEEK_START + 7) % 7;
  x.setDate(x.getDate() - diff);
  return startOfDayMs(x);
}
function endOfWeekMs(d){
  const s = new Date(startOfWeekMs(d));
  const e = new Date(s);
  e.setDate(e.getDate()+6);
  return endOfDayMs(e);
}
function startOfMonthMs(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0).getTime(); }
function endOfMonthMs(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999).getTime(); }

function presetRangeMs(key){
  const now = new Date();
  if(key==="today") return { startMs:startOfDayMs(now), endMs:endOfDayMs(now) };
  if(key==="yesterday"){
    const y = new Date(now); y.setDate(y.getDate()-1);
    return { startMs:startOfDayMs(y), endMs:endOfDayMs(y) };
  }
  if(key==="thisWeek")  return { startMs:startOfWeekMs(now), endMs:endOfWeekMs(now) };
  if(key==="lastWeek"){
    const lw = new Date(now); lw.setDate(lw.getDate()-7);
    return { startMs:startOfWeekMs(lw), endMs:endOfWeekMs(lw) };
  }
  if(key==="thisMonth") return { startMs:startOfMonthMs(now), endMs:endOfMonthMs(now) };
  if(key==="lastMonth"){
    const lm = new Date(now.getFullYear(), now.getMonth()-1, 1);
    return { startMs:startOfMonthMs(lm), endMs:endOfMonthMs(lm) };
  }
  return null;
}

function setActivePreset(vaultId, key){
  const g = document.querySelector(`[data-presets="${vaultId}"]`);
  if(!g) return;
  g.querySelectorAll(".pbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.preset===key);
  });
}
function clearActivePreset(vaultId){
  const g = document.querySelector(`[data-presets="${vaultId}"]`);
  if(!g) return;
  g.querySelectorAll(".pbtn").forEach(b=> b.classList.remove("active"));
}
function ymd(ms){
  const d = new Date(ms);
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
  let me = { uid:null, username:null, isAdmin:false };
  let currentBalance = 0;
  const WALLET_ID = "main";
  let buyTotalManual = false;

  // UI state
  let activeView = "open";
  let ctxVaultId = null; 
  let ctxAvailablePig = 0;
  let ctxMissingPig = 0;
  let ctxEdit = null; 
  const vaultFilters = {};   // { [vaultId]: { startMs, endMs } }
  const vaultPickers = {};   // { [vaultId]: flatpickrInstance }
  const vaultTxCache = {}; 
  const vaultTxUnsubs = {};
  // ===== MODAL helper =====
  function openModal(id){ $(id).style.display="flex"; }
function closeModal(id){
  $(id).style.display="none";
  if(id==="mCash" || id==="mBuy" || id==="mMissing" || id==="mSell"){
    ctxEdit = null;
  }
  if(id==="mNewVault") resetTxTimeInput("txTime_newVault");
  if(id==="mCash")    resetTxTimeInput("txTime_cash");
  if(id==="mBuy")     resetTxTimeInput("txTime_buy");
  if(id==="mMissing") resetTxTimeInput("txTime_missing");
  if(id==="mSell")    resetTxTimeInput("txTime_sell");
}
  document.addEventListener("click",(e)=>{
    const t = e.target;
    if(t?.dataset?.close) closeModal(t.dataset.close);
    if(t.classList.contains("modalBack")) t.style.display="none";
  });

  // ===== ROLE =====
  async function loadRole(uid){
    const r = await get(ref(db, `roles/${uid}`));
    const role = r.exists() ? r.val() : {};
    me.isAdmin = role?.isAdmin === true;
    me.username = role?.username || me.username || "user";
    $("rolePill").textContent = me.isAdmin ? "Admin" : "Client";
    $("usernameText").textContent = me.username;

    // permission UI
    $("btnAddPoint").classList.toggle("hide", !me.isAdmin);
  }

  // ===== BALANCE =====
function wireBalanceListener(){
  const balPath = `finance/balance/${WALLET_ID}`;
  onValue(ref(db, balPath), (snap)=>{
    const v = snap.val() || {};
    currentBalance = Number(v.amount||0);

    const txt = fmt(currentBalance);
    const isNeg = currentBalance < 0;

    const elSmall = $("balanceText");
    const elBig   = $("balanceBig");

    elSmall.textContent = txt;
    elBig.textContent   = txt;
    elSmall.classList.remove("good","bad");
    elBig.classList.remove("good","bad");
    if(isNeg){
      elSmall.classList.add("bad");
      elBig.classList.add("bad");
    }else{
      elSmall.classList.add("good");
      elBig.classList.add("good");
    }
    $("balanceUpdated").textContent = v.updatedAtMs ? fmtDT(v.updatedAtMs) : "-";
  });
}

async function changeBalance(delta, meta, atMsOverride){
  const now = Number(atMsOverride || Date.now());

  const balPath = `finance/balance/${WALLET_ID}`;               // ‚úÖ global
  const ledRef  = push(ref(db, `finance/ledger/${WALLET_ID}`)); // ‚úÖ global ledger

  const newAmount = currentBalance + delta;

  const updates = {};

  updates[balPath] = {
    amount: newAmount,
    updatedAt: serverTimestamp(),
    updatedAtMs: now,
    byUid: me.uid,
    byUser: me.username
  };

  updates[`finance/ledger/${WALLET_ID}/${ledRef.key}`] = {
    ...(meta||{}),
    delta,
    balanceAfter: newAmount,
    at: serverTimestamp(),
    atMs: now,
    byUid: me.uid,
    byUser: me.username
  };

  await update(ref(db), updates);
}

  // ===== VAULTS =====
async function createVault(title, note, createdAtMs){
  const now = Number(createdAtMs || Date.now());
  const vRef = push(vaultRefOpen());
  await set(vRef, {
    title: String(title||"").trim(),
    note: String(note||"").trim(),
    status: "open",
    createdAt: serverTimestamp(),
    createdAtMs: now,
    createdByUid: me.uid,
    createdBy: me.username,
    summary: { totalCost:0, totalKg:0, totalEkor:0, totalRevenue:0, profit:0 }
  });
}
async function addTx(vaultId, tx, atMsOverride){
  const now = Number(atMsOverride || Date.now());
  const txRef = push(ref(db, `vaults/${activeView==="open" ? "open":"history"}/${vaultId}/transactions`));
  await set(txRef, { ...tx, at: serverTimestamp(), atMs: now, byUid: me.uid, byUser: me.username });
  await recomputeVaultSummary(vaultId, activeView==="open" ? "open":"history");
}

async function recomputeVaultSummary(vaultId, bucket){
  const snap = await get(ref(db, `vaults/${bucket}/${vaultId}/transactions`));
  const txs = snap.exists() ? snap.val() : {};

  let totalCost=0, totalKg=0, totalEkor=0, totalRevenue=0;
  let missingQty = 0;

  let sellKgSum = 0;
  let sellPriceKgWeighted = 0;

  let babyQty = 0;
  let babyTotal = 0;
  let babyPriceSum = 0;

  for(const k of Object.keys(txs)){
    const t = txs[k];

    if(t.kind==="missing"){
      missingQty += Number(t.qty||0);
    }

    if(t.kind==="buy"){
      const tTotal = Number(t.total||0);
      totalCost += tTotal;

      if(t.category === "baby_pig"){
        const q = Number(t.qty||0);
        const p = Number(t.price||0);
        babyQty += q;
        babyTotal += tTotal;
        babyPriceSum += (q * p);
      }
    }

    if(t.kind==="sell"){
      const kg = Number(t.kg||0);
      const pk = Number(t.priceKg||0);

      totalRevenue += Number(t.total||0);
      totalKg += kg;
      totalEkor += Number(t.ekor||0);

      if(kg > 0 && pk > 0){
        sellKgSum += kg;
        sellPriceKgWeighted += (pk * kg);
      }
    }
  } // ‚úÖ INI YANG KAU TAK ADA TADI (tutup for)

  const profit = totalRevenue - totalCost;
  const babyAvgPrice = babyQty > 0 ? (babyPriceSum / babyQty) : 0;
  const avgPriceKg = sellKgSum > 0 ? (sellPriceKgWeighted / sellKgSum) : 0;

  await update(ref(db, `vaults/${bucket}/${vaultId}`), {
    summary: {
      totalCost, totalKg, totalEkor, totalRevenue, profit,
      babyPig: { qty:babyQty, avgPrice:babyAvgPrice, total:babyTotal },
      missing: { qty: missingQty },
      sell: { avgPriceKg },
      availablePig: Math.max(0, babyQty - missingQty - totalEkor)
    },
    updatedAt: serverTimestamp(),
    updatedAtMs: Date.now()
  });
}

  async function closeVault(vaultId){
    // move open -> history (multi update)
    const openSnap = await get(ref(db, `vaults/open/${vaultId}`));
    if(!openSnap.exists()) return;

    const data = openSnap.val();
    const now = Date.now();

    const updates = {};
    updates[`vaults/history/${vaultId}`] = {
      ...data,
      status: "closed",
      closedAt: serverTimestamp(),
      closedAtMs: now,
      closedByUid: me.uid,
      closedBy: me.username
    };
    updates[`vaults/open/${vaultId}`] = null;
    await update(ref(db), updates);
  }
async function uncloseVault(vaultId){
  const histPath = `vaults/history/${vaultId}`;
  const openPath = `vaults/open/${vaultId}`;

  const histSnap = await get(ref(db, histPath));
  if(!histSnap.exists()) return;

  const data = histSnap.val() || {};
  const now = Date.now();

  const { closedAt, closedAtMs, closedBy, closedByUid, ...rest } = data;

  const openData = {
    ...rest,
    status: "open",
    reopenedAt: serverTimestamp(),
    reopenedAtMs: now,
    reopenedByUid: me.uid,
    reopenedBy: me.username,
    updatedAt: serverTimestamp(),
    updatedAtMs: now
  };

  // üî• IMPORTANT: multi-location update supaya listener trigger betul
  const updates = {};
  updates[openPath] = openData;
  updates[histPath] = null;

  await update(ref(db), updates);
}
  // ===== RENDER =====
  function setView(v){
    activeView = v;
    $("tabOpen").classList.toggle("active", v==="open");
    $("tabHistory").classList.toggle("active", v==="history");
    $("viewOpen").classList.toggle("hide", v!=="open");
    $("viewHistory").classList.toggle("hide", v!=="history");
  }

function vaultCardHTML(vaultId, v, bucket){
  const s = v.summary || { totalCost:0,totalKg:0,totalEkor:0,totalRevenue:0,profit:0 };
  const bp = (s.babyPig || { qty:0, avgPrice:0, total:0 });

  const missingQty = Number(s.missing?.qty || 0);
  const totalEkor  = Number(s.totalEkor || 0);

  const availablePig = Number(
    s.availablePig ?? Math.max(0, Number(bp.qty||0) - missingQty - totalEkor)
  );

  const avgPriceKg = Number(s.sell?.avgPriceKg || 0);

  const profitVal   = Number(s.profit || 0);
  const profitClass = profitVal >= 0 ? "kpiGood" : "kpiBad";

  const SALES_RATE  = 0.40;
  const salesValue  = profitVal * SALES_RATE;
  const salesClass  = salesValue >= 0 ? "kpiGood" : "kpiBad";

  const created = v.createdAtMs ? fmtDT(v.createdAtMs) : "-";
  const updated = v.updatedAtMs ? fmtDT(v.updatedAtMs) : "-";
  const closed  = v.closedAtMs  ? fmtDT(v.closedAtMs)  : "-";

  const canEdit = me.isAdmin;
  const isHistory = bucket === "history";
  const ownerUid = v?.createdByUid || null;
  const isOwner = ownerUid && ownerUid === me.uid;
  const canOperateOpen = !isHistory && (me.isAdmin || isOwner);

  return `
    <div class="card" data-vid="${vaultId}" data-bucket="${bucket}">
      <div class="cardHead">
        <div>
          <div class="title">${escapeHtml(v.title || "Untitled Vault")}</div>
          <div class="sub">
            Created: <span class="num">${created}</span>
            ${isHistory ? ` ‚Ä¢ Closed: <span class="num">${closed}</span>` : ``}
            <br>Updated: <span class="num">${updated}</span>
          </div>
        </div>

        <div class="vaultBtns">
${!isHistory ? `
  ${canOperateOpen ? `
    <button class="btn ghost" data-act="cash" data-id="${vaultId}">Cash Transfer</button>
    <button class="btn ghost" data-act="buy" data-id="${vaultId}">Buy</button>
    <button class="btn ghost" data-act="missing" data-id="${vaultId}">Missing</button>
    <button class="btn ghost" data-act="sell" data-id="${vaultId}">Sell</button>
    <button class="btn danger" data-act="close" data-id="${vaultId}">Closing</button>
  ` : `<div class="hint">No access (not your vault).</div>`}
` : `
  ${canEdit ? `<button class="btn ghost" data-act="histEdit" data-id="${vaultId}">Edit Title</button>` : ``}
`}
        </div>
      </div>

      <div class="cardBody">

        <!-- KPI BUY kiri + SELL kanan -->
        <div class="kpiSplit">

          <!-- LEFT: BUY -->
          <div class="kpiTableCard">
            <div class="kpiTableHead">Total Buyed</div>
            <table class="kpiTable">
              <tr><td>Total Cash Out</td><td class="kpiGood" data-kpi="cashOut">0.00</td></tr>
              <tr><td>Total Expenses</td><td class="kpiGood" data-kpi="buyCost">${fmt(s.totalCost)}</td></tr>
              <tr><td>Total Pets</td><td data-kpi="buyQty">${Number((s.babyPig?.qty||0)).toLocaleString()}</td></tr>
              <tr><td>Total Price Quantity</td><td class="kpiGood" data-kpi="buyAvg">${fmt((s.babyPig?.avgPrice||0))}</td></tr>
              <tr><td>Total Price</td><td class="kpiGood" data-kpi="buyTotal">${fmt((s.babyPig?.total||0))}</td></tr>
              <tr><td>Total Feeding</td><td class="kpiGood" data-kpi="feedTotal">0.00</td></tr>
              <tr><td>Total Other</td><td class="kpiGood" data-kpi="otherTotal">0.00</td></tr>
              <tr><td>Total Cash In/Out</td><td class="kpiGood" data-kpi="cashNet">0.00</td></tr>
              <tr><td>Total Sales</td><td class="${salesClass}" data-kpi="sales">${fmt(salesValue)}</td></tr>
            </table>
          </div>

          <!-- RIGHT: SELL -->
          <div class="kpiTableCard">
            <div class="kpiTableHead">Total Sell</div>
            <table class="kpiTable">
              <tr><td>Total Cash In</td><td class="kpiGood" data-kpi="cashIn">0.00</td></tr>
              <tr><td>Total Seller</td><td class="kpiGood" data-kpi="sellRevenue">${fmt(s.totalRevenue)}</td></tr>
              <tr><td>Total Quantity KG</td><td class="kpiGood" data-kpi="sellAvgKg">${fmt((s.sell?.avgPriceKg||0))}</td></tr>
              <tr><td>Total KG</td><td class="kpiGood" data-kpi="sellKg">${fmt(s.totalKg)}</td></tr>
              <tr><td>Total Quantity</td><td class="kpiGood" data-kpi="sellEkor">${Number(s.totalEkor||0).toLocaleString()}</td></tr>
              <tr><td>Total Death</td><td class="kpiBad" data-kpi="missingQty">${Number(s.missing?.qty||0).toLocaleString()}</td></tr>
              <tr><td>Total Price Death</td><td class="kpiGood" data-kpi="missingTotal">0.00</td></tr>
              <tr><td>Total Pets Available</td><td class="kpiGood" data-kpi="availablePig">${availablePig.toLocaleString()}</td></tr>
              <tr><td>Total Profit</td><td class="${profitClass}" data-kpi="profit">${fmt(profitVal)}</td></tr>
            </table>
          </div>

        </div>

        <div class="hr"></div>
        <div class="rangeBar" data-rangebar="${vaultId}">
  <div class="rangeLeft">
      <input class="dateRangeInput" data-range="${vaultId}" type="text" readonly>
  </div>

  <div class="rangeRight" data-presets="${vaultId}">
    <button class="pbtn" data-preset="today"     data-vid="${vaultId}">Today</button>
    <button class="pbtn" data-preset="yesterday" data-vid="${vaultId}">Yesterday</button>
    <button class="pbtn" data-preset="thisWeek"  data-vid="${vaultId}">This Week</button>
    <button class="pbtn" data-preset="lastWeek"  data-vid="${vaultId}">Last Week</button>
    <button class="pbtn" data-preset="thisMonth" data-vid="${vaultId}">This Month</button>
    <button class="pbtn" data-preset="lastMonth" data-vid="${vaultId}">Last Month</button>
  </div>
</div>

        <div class="tblWrap">
          <table>
            <thead>
              <tr>
                <th style="width:120px">Type</th>
                <th>Transaction</th>
                <th style="width:120px">Quantity</th>
                <th style="width:150px">Price Quantity</th>
                <th style="width:150px">Total Amount</th>
                <th style="width:180px">Date & Time</th>
                <th style="width:180px">Actions</th>
              </tr>
            </thead>
            <tbody data-tbody="${vaultId}">
              <tr><td colspan="7" class="hint">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        ${v.note ? `<div class="hr"></div><div class="hint"><b>Note:</b> ${escapeHtml(v.note)}</div>` : ``}

<div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px">
  ${
    (!isHistory)
      ? `
        ${
          (me.isAdmin || isOwner)
            ? `<button class="btn danger" data-act="vaultDel" data-id="${vaultId}" data-b="open">Delete Vault</button>`
            : ``
        }
      `
      : `
        ${(() => {
          const isOwnerUnclose =
            me.isAdmin ||
            (v?.createdByUid && v.createdByUid === me.uid) ||
            (v?.closedByUid && v.closedByUid === me.uid);

          return isOwnerUnclose
            ? `<button class="btn ghost" data-act="vaultUnclose" data-id="${vaultId}">Unclosing</button>`
            : ``;
        })()}
        ${me.isAdmin ? `<button class="btn danger" data-act="vaultDel" data-id="${vaultId}" data-b="history">Delete Vault</button>` : ``}
      `
  }
</div>

      </div>
    </div>
  `;
}

function txRowHTML(vaultId, txId, t, bucket){
  const at = t.atMs ? fmtDT(t.atMs) : "-";

  let typeTag = `<span class="tag">TX</span>`;
  if(t.kind==="cash") typeTag = `<span class="tag ${t.direction==="in"?"in":"out"}">${t.direction==="in"?"CASH-IN":"CASH-OUT"}</span>`;
  if(t.kind==="buy")  typeTag = `<span class="tag buy">BUY</span>`;
  if(t.kind==="sell") typeTag = `<span class="tag sell">SELL</span>`;
  if(t.kind==="missing") typeTag = `<span class="tag out">MISSING</span>`;

  // Amount
  let amount = Number(t.total||t.amount||0);
  if(t.kind==="missing") amount = -Math.abs(amount); // display negatif
  const amountText = fmt(amount);
  const amtClass = amount < 0 ? "amtNeg" : "";

  // === NEW: qty (ekor) & unit price column ===
  let qtyEkor = "";
  let unitPrice = "";

  if(t.kind==="buy"){
    qtyEkor = Number(t.qty||0) ? String(Number(t.qty||0).toLocaleString()) : "";
    unitPrice = Number(t.price||0) ? fmt(t.price||0) : "";
  }else if(t.kind==="missing"){
    qtyEkor = Number(t.qty||0) ? String(Number(t.qty||0).toLocaleString()) : "";
    unitPrice = Number(t.price||0) ? fmt(t.price||0) : "";
}else if(t.kind==="sell"){
  qtyEkor = Number(t.ekor||0) ? String(Number(t.ekor||0).toLocaleString()) : "";
  unitPrice = Number(t.priceKg||0) ? fmt(t.priceKg||0) : "";
  }else{
    qtyEkor = "";
    unitPrice = "";
  }

  // Description (dah tak ada "qty @ ...")
  const desc = buildTxDesc(t);

const vaultOwnerUid = window.__vaultOwner?.[vaultId]; // kita isi nanti masa render
const isOwner = (vaultOwnerUid && vaultOwnerUid === me.uid);
const showActions = (bucket === "open")
  ? (me.isAdmin || isOwner)
  : me.isAdmin;

  const hasNote = String(t.note||"").trim().length > 0;

  return `
    <tr data-txid="${txId}">
      <td>${typeTag}</td>
      <td>${escapeHtml(desc)}</td>

      <td class="num">${escapeHtml(qtyEkor || "-")}</td>
      <td class="num">${escapeHtml(unitPrice || "-")}</td>

      <td class="num ${amtClass}">${amountText}</td>
      <td class="num">${at}</td>
      <td>
        ${showActions ? `
          <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap">
            ${hasNote ? `
              <button class="btn-view" style="padding:8px 10px"
                data-act="txView" data-note="${escapeHtml(t.note)}">
                View
              </button>
            ` : ``}
            <button class="btn-edit" style="padding:8px 10px"
              data-act="txEdit" data-v="${vaultId}" data-b="${bucket}" data-t="${txId}">
              Edit
            </button>
            <button class="btn-delete" style="padding:8px 10px"
              data-act="txDel" data-v="${vaultId}" data-b="${bucket}" data-t="${txId}">
              Delete
            </button>
          </div>
        ` : `<span class="hint">-</span>`}
      </td>
    </tr>
  `;
}

function buildTxDesc(t){
  if(t.kind==="cash"){
    return t.direction==="in" ? "Cash In" : "Cash Out";
  }

  if(t.kind==="buy"){
    return t.category==="baby_pig" ? "Pets"
         : (t.category==="feed" ? "Feed" : "Other");
  }

  if(t.kind==="missing"){
    return "Death Pets";
  }

  if(t.kind==="sell"){
    return `${fmt(t.kg||0)} kg`;
  }

  return "Transaction";
}

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function txBalanceEffect(t){
  if(!t) return 0;

  if(t.kind === "cash"){
    const amt = Number(t.amount || t.total || 0);
    return (t.direction === "in") ? amt : -amt;
  }

  if(t.kind === "buy"){
    return -Math.abs(Number(t.total || 0));
  }

  if(t.kind === "sell"){
    return Math.abs(Number(t.total || 0));
  }

  // missing memang tak sentuh balance
  return 0;
}
async function adjustBalanceForTxDelete({ bucket, vaultId, txId, txObj }) {
  // txObj boleh pass terus (kalau dah ada), kalau tak kita get dari DB
  let t = txObj;

  if(!t){
    const snap = await get(ref(db, `vaults/${bucket}/${vaultId}/transactions/${txId}`));
    if(!snap.exists()) return;
    t = snap.val();
  }

  const eff = txBalanceEffect(t); // cash/buy/sell effect
  if(eff === 0) return; // missing tak sentuh balance

  // reverse effect bila delete
  const delta = -eff;

  // guna masa tx asal kalau ada (lebih cun dalam ledger)
  const atMs = Number(t.atMs || Date.now());

  await changeBalance(delta, {
    kind: "tx_delete_adjust",
    txKind: t.kind,
    vaultId,
    txId,
    note: "Delete tx rollback"
  }, atMs);
}
function openViewNote(noteText){
  const txt = String(noteText || "").trim();
  $("viewNoteText").textContent = txt ? txt : "No note.";
  openModal("mViewNote");
}
function renderVaultList(targetId, data, bucket){
  const el = $(targetId);
  const entries = Object.entries(data||{});
    window.__vaultOwner = window.__vaultOwner || {};
  for(const [id,v] of entries){
    window.__vaultOwner[id] = v?.createdByUid || null;
  }

  // sort: latest createdAtMs desc
  entries.sort((a,b)=> (Number(b[1]?.createdAtMs||0) - Number(a[1]?.createdAtMs||0)));

  if(entries.length===0){
    el.innerHTML = `<div class="card"><div class="cardBody"><div class="hint">No vault yet.</div></div></div>`;
    return;
  }

  el.innerHTML = entries.map(([id,v]) => vaultCardHTML(id,v,bucket)).join("");

  // init daterange UI once per vault card rendered
  for(const [id] of entries){
    initVaultDateRangeUI(id);
  }

  // ‚úÖ bind tx listeners per vault (NO DOUBLE LISTENER)
  for(const [id] of entries){
    const txPath = `vaults/${bucket}/${id}/transactions`;

    // ‚úÖ remove old listener for same vaultId (if exist)
    if(vaultTxUnsubs[id]){
      vaultTxUnsubs[id]();
      delete vaultTxUnsubs[id];
    }

    // ‚úÖ attach new listener + store unsubscribe
    vaultTxUnsubs[id] = onValue(ref(db, txPath), (snap)=>{
      const txs = snap.exists()? snap.val() : {};
      const tbody = document.querySelector(`[data-tbody="${id}"]`);
      if(!tbody) return;

      const rows = Object.entries(txs);
      rows.sort((a,b)=> Number(b[1]?.atMs||0) - Number(a[1]?.atMs||0));

      if(rows.length===0){
      vaultTxCache[id] = { bucket, rows: [] };
      rerenderVaultTbody(id);                
      return;
      }

      vaultTxCache[id] = { bucket, rows };
      rerenderVaultTbody(id);
    });
  }
}
function rerenderVaultTbody(vaultId){
  const cache = vaultTxCache[vaultId];
  const tbody = document.querySelector(`[data-tbody="${vaultId}"]`);
  if(!tbody || !cache) return;

  const { bucket, rows } = cache;
  const f = vaultFilters[vaultId];

  let use = rows;
  if(f){
    use = rows.filter(([txId,t])=>{
      const ms = Number(t?.atMs||0);
      return ms >= f.startMs && ms <= f.endMs;
    });
  }

  // ‚úÖ IMPORTANT: KPI kena update walaupun table kosong
  updateVaultKpiFromFiltered(vaultId);

  if(use.length===0){
    tbody.innerHTML = `<tr><td colspan="7" class="hint">No transaction in this date range.</td></tr>`;
    return;
  }

  tbody.innerHTML = use.map(([txId,t]) => txRowHTML(vaultId, txId, t, bucket)).join("");
}

function initVaultDateRangeUI(vaultId){
  const input = document.querySelector(`.dateRangeInput[data-range="${vaultId}"]`);
  if(!input) return;
  const def = vaultFilters[vaultId] || presetRangeMs("thisMonth");
  vaultFilters[vaultId] = def;
  const existing = vaultPickers[vaultId];
  if(existing){
    if(existing.input !== input){
      try{ existing.destroy(); }catch(_){}
      delete vaultPickers[vaultId];
    }else{
      input.value = `${ymd(def.startMs)} ‚Üí ${ymd(def.endMs)}`;
      return;
    }
  }
  input.value = `${ymd(def.startMs)} ‚Üí ${ymd(def.endMs)}`;

  vaultPickers[vaultId] = flatpickr(input, {
    mode: "range",
    dateFormat: "Y-m-d",
    showMonths: 2,
    closeOnSelect: false,
    defaultDate: [new Date(def.startMs), new Date(def.endMs)],

    onReady: ()=> {
      input.value = `${ymd(def.startMs)} ‚Üí ${ymd(def.endMs)}`;
      clearActivePreset(vaultId);
      setTimeout(()=>{ input.value = `${ymd(def.startMs)} ‚Üí ${ymd(def.endMs)}`; }, 0);
    },

    onOpen: ()=> {
      const f = vaultFilters[vaultId] || def;
      if(!input.value.trim()){
        input.value = `${ymd(f.startMs)} ‚Üí ${ymd(f.endMs)}`;
      }
    },

    onChange: (dates)=>{
      if(dates.length === 2){
        const startMs = startOfDayMs(dates[0]);
        const endMs   = endOfDayMs(dates[1]);
        vaultFilters[vaultId] = { startMs, endMs };

        input.value = `${ymd(startMs)} ‚Üí ${ymd(endMs)}`;
        clearActivePreset(vaultId);
        rerenderVaultTbody(vaultId);
      }
    },

    onClose: (dates)=>{
      if(dates.length === 0){
        const f = vaultFilters[vaultId] || def;
        input.value = `${ymd(f.startMs)} ‚Üí ${ymd(f.endMs)}`;
        return;
      }
      if(dates.length === 1){
        const startMs = startOfDayMs(dates[0]);
        const endMs   = endOfDayMs(dates[0]);
        vaultFilters[vaultId] = { startMs, endMs };

        input.value = `${ymd(startMs)} ‚Üí ${ymd(endMs)}`;
        clearActivePreset(vaultId);
        rerenderVaultTbody(vaultId);
      }
    }
  });
}
function updateVaultKpiFromFiltered(vaultId){
  const cache = vaultTxCache[vaultId];
  if(!cache) return;

  const { rows } = cache; // rows = [[txId, txObj], ...]
  const f = vaultFilters[vaultId];

  // apply filter
  let use = rows;
  if(f){
    use = rows.filter(([_,t])=>{
      const ms = Number(t?.atMs||0);
      return ms >= f.startMs && ms <= f.endMs;
    });
  }

  // compute KPI from filtered tx
  let buyCost = 0;
  let babyQty = 0, babyTotal = 0, babyPriceSum = 0;
  let feedTotal = 0;
  let otherTotal = 0; 
  let sellRevenue = 0;
  let sellKg = 0;
  let sellEkor = 0;
  let sellKgSum = 0, sellPriceKgWeighted = 0;
  let missingQty = 0;
  let missingTotal = 0;

  // ‚úÖ NEW: cash in/out totals
  let cashIn = 0;
  let cashOut = 0;

  for(const [txId, t] of use){
    if(!t || !t.kind) continue;

    // ‚úÖ cash summary
    if(t.kind === "cash"){
      const amt = Number(t.amount || t.total || 0);
      if(t.direction === "in") cashIn += amt;
      else cashOut += amt;
    }
if(t.kind === "buy"){
  const total = Number(t.total||0);
  buyCost += total;

  if(t.category === "baby_pig"){
    const q = Number(t.qty||0);
    const p = Number(t.price||0);
    babyQty += q;
    babyTotal += total;
    babyPriceSum += (q * p);
  } else if(t.category === "feed"){
    feedTotal += total; 
  } else {
    otherTotal += total;
  }
}

    if(t.kind === "sell"){
      const total = Number(t.total||0);
      const kg = Number(t.kg||0);
      const ekor = Number(t.ekor||0);
      const pk = Number(t.priceKg||0);

      sellRevenue += total;
      sellKg += kg;
      sellEkor += ekor;

      if(kg > 0 && pk > 0){
        sellKgSum += kg;
        sellPriceKgWeighted += (pk * kg);
      }
    }

if(t.kind === "missing"){
  missingQty += Number(t.qty||0);
  missingTotal += Number(t.total || t.amount || 0); // ‚úÖ jumlah harga mati
}
  }

  const profit = sellRevenue - buyCost;
  const SALES_RATE = 0.40;
  const sales = profit * SALES_RATE;

  const buyAvg = babyQty > 0 ? (babyPriceSum / babyQty) : 0;
  const sellAvgKg = sellKgSum > 0 ? (sellPriceKgWeighted / sellKgSum) : 0;

  const availablePig = Math.max(0, babyQty - missingQty - sellEkor);

  // helper: update text in this vault card only
  const card = document.querySelector(`.card[data-vid="${vaultId}"]`);
  if(!card) return;

  const setKpi = (key, text)=>{
    const el = card.querySelector(`[data-kpi="${key}"]`);
    if(el) el.textContent = text;
  };

  // ‚úÖ update CASH IN/OUT
  setKpi("cashIn", fmt(cashIn));

const cashOutEl = card.querySelector(`[data-kpi="cashOut"]`);
if(cashOutEl){
  cashOutEl.textContent = fmt(cashOut);
  cashOutEl.classList.remove("kpiBad");
  cashOutEl.classList.add("kpiGood");
}
  // update BUY
  setKpi("buyCost", fmt(buyCost));
  setKpi("buyQty", babyQty.toLocaleString());
  setKpi("buyAvg", fmt(buyAvg));
  setKpi("buyTotal", fmt(babyTotal));
  setKpi("feedTotal", fmt(feedTotal));
  setKpi("otherTotal", fmt(otherTotal));

  // update PROFIT & SALES + color
  const profitEl = card.querySelector(`[data-kpi="profit"]`);
  if(profitEl){
    profitEl.textContent = fmt(profit);
    profitEl.classList.toggle("kpiGood", profit >= 0);
    profitEl.classList.toggle("kpiBad", profit < 0);
  }

  const salesEl = card.querySelector(`[data-kpi="sales"]`);
  if(salesEl){
    salesEl.textContent = fmt(sales);
    salesEl.classList.toggle("kpiGood", sales >= 0);
    salesEl.classList.toggle("kpiBad", sales < 0);
  }
 // ===== CASH IN/OUT NET =====
const cashNet = cashIn - cashOut;  // duit masuk tolak duit keluar

const cashNetEl = card.querySelector(`[data-kpi="cashNet"]`);
if(cashNetEl){
  cashNetEl.textContent = fmt(cashNet);
  cashNetEl.classList.toggle("kpiGood", cashNet >= 0);
  cashNetEl.classList.toggle("kpiBad",  cashNet < 0);
}
  // update SELL
  setKpi("sellRevenue", fmt(sellRevenue));
  setKpi("sellAvgKg", fmt(sellAvgKg));
  setKpi("sellKg", fmt(sellKg));
  setKpi("sellEkor", sellEkor.toLocaleString());

  // missing & available
const missQtyEl = card.querySelector(`[data-kpi="missingQty"]`);
if(missQtyEl){
  missQtyEl.textContent = missingQty.toLocaleString();
  missQtyEl.classList.toggle("kpiGood", missingQty === 0);
  missQtyEl.classList.toggle("kpiBad",  missingQty > 0);
}

// missing total (0.00 hijau, ada -> merah & negatif)
const missTotalEl = card.querySelector(`[data-kpi="missingTotal"]`);
if(missTotalEl){
  const showVal = (missingTotal > 0) ? -missingTotal : 0; // ‚úÖ negatif bila ada
  missTotalEl.textContent = fmt(showVal);

  missTotalEl.classList.toggle("kpiGood", missingTotal === 0);
  missTotalEl.classList.toggle("kpiBad",  missingTotal > 0);
}

setKpi("availablePig", availablePig.toLocaleString());
}
  function wireVaultListeners(){
    // Open vaults
    onValue(query(vaultRefOpen(), orderByChild("createdAtMs"), limitToLast(80)), (snap)=>{
      const data = snap.exists()? snap.val() : {};
      renderVaultList("viewOpen", data, "open");
    });

    // History vaults
    onValue(query(vaultRefHist(), orderByChild("createdAtMs"), limitToLast(120)), (snap)=>{
      const data = snap.exists()? snap.val() : {};
      renderVaultList("viewHistory", data, "history");
    });
  }
 async function assertCanOperateOpenVault(vaultId){
  if(me.isAdmin) return true;
  const s = await get(ref(db, `vaults/open/${vaultId}/createdByUid`));
  const owner = s.exists() ? s.val() : null;
  return owner === me.uid;
}
  // ===== EVENTS =====
  $("btnBalance").addEventListener("click", ()=> openModal("mBalance"));
// ===== USER DROPDOWN TOGGLE =====
const userDrop = $("userDrop");
const userBtn  = $("btnUser");
const userMenu = $("userMenu");

function closeUserMenu(){
  userDrop.classList.remove("open");
  userBtn.setAttribute("aria-expanded", "false");
}

function toggleUserMenu(){
  const open = userDrop.classList.toggle("open");
  userBtn.setAttribute("aria-expanded", open ? "true" : "false");
}

userBtn.addEventListener("click", (e)=>{
  e.preventDefault();
  toggleUserMenu();
});

// click luar -> close
document.addEventListener("click", (e)=>{
  if(!e.target.closest("#userDrop")) closeUserMenu();
});

// optional: ESC close
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeUserMenu();
});

// Logout (kekal fungsi asal)
$("btnLogout").addEventListener("click", async ()=>{
  closeUserMenu();
  await signOut(auth);
  location.replace("../login/");
});

  $("tabOpen").addEventListener("click", ()=> setView("open"));
  $("tabHistory").addEventListener("click", ()=> setView("history"));

  $("btnAddPoint").addEventListener("click", ()=>{
    if(!me.isAdmin){ toast("Limited user: tiada akses Add Point."); return; }
    $("apType").value="in"; $("apAmount").value=""; $("apNote").value="";
    openModal("mAddPoint");
  });

  $("btnNewVault").addEventListener("click", ()=>{
    $("nvTitle").value=""; $("nvNote").value="";
    resetTxTimeInput("txTime_newVault");
    openModal("mNewVault");
  });

  $("apSave").addEventListener("click", async ()=>{
    if(!me.isAdmin){ toast("No access."); return; }
    const type = $("apType").value;
    const amount = Number($("apAmount").value||0);
    const note = $("apNote").value.trim();
    if(amount<=0){ toast("Amount mesti > 0"); return; }

    const delta = (type==="in") ? amount : -amount;

    try{
      await changeBalance(delta, { kind:"add_point", direction:type, amount, note });
      closeModal("mAddPoint");
      toast("Balance updated.");
    }catch(e){
      console.error(e);
      toast(e?.message || "Failed");
    }
  });

$("nvCreate").addEventListener("click", async ()=>{
  const title = $("nvTitle").value.trim();
  const note  = $("nvNote").value.trim();
  if(!title){ toast("Title wajib isi."); return; }
  try{
    const createdAtMs = await getAtMsFromControl("newVault", "txTime_newVault");
    await createVault(title, note, createdAtMs);

    closeModal("mNewVault");
    toast("Vault created.");
    setView("open");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed");
  }
});

  // table button actions (event delegation)
  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest("[data-act]");
    if(!btn) return;

    const act = btn.dataset.act;
    const vid = btn.dataset.id;

    if(act==="cash"){
      ctxVaultId = vid;
      const vSnap = await get(ref(db, `vaults/open/${vid}`));
      $("cashVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";
      $("cashType").value="cash_in"; $("cashAmount").value=""; $("cashNote").value="";
      resetTxTimeInput("txTime_cash");
      if(!(await assertCanOperateOpenVault(vid))){
      toast("No access: this vault is not yours.");
      return;
      }
      openModal("mCash");
    }

    if(act==="buy"){
      ctxVaultId = vid;
      const vSnap = await get(ref(db, `vaults/open/${vid}`));
      $("buyVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";
      $("buyCat").value="baby_pig";
      $("buyQty").value=""; $("buyPrice").value=""; $("buyTotal").value="";
      $("buyNote").value="";
      $("buyBalanceHint").textContent = `Current balance: ${fmt(currentBalance)}`;
      if(!(await assertCanOperateOpenVault(vid))){
      toast("No access: this vault is not yours.");
      return;
      }
      buyTotalManual = false;
      calcBuy();
      openModal("mBuy");
    }
    if(act==="missing"){
  ctxVaultId = vid;
  const vSnap = await get(ref(db, `vaults/open/${vid}`));
  $("missingVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";

  $("missQty").value="";
  $("missPrice").value="";
  $("missTotal").value="";
  $("missNote").value="";
  if(!(await assertCanOperateOpenVault(vid))){
  toast("No access: this vault is not yours.");
  return;
  }
  openModal("mMissing");
}

if(act==="sell"){
  ctxVaultId = vid;
  const vSnap = await get(ref(db, `vaults/open/${vid}`));
  $("sellVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";

  const s = (vSnap.exists() ? (vSnap.val().summary || {}) : {});
  const babyQty = Number(s.babyPig?.qty || 0);
  const missQty = Number(s.missing?.qty || 0);

  ctxMissingPig = missQty;
  ctxAvailablePig = Math.max(0, babyQty - missQty);

  $("sellMissing").value = String(ctxMissingPig);
  $("sellEkorHint").textContent = `Available Quantity: ${ctxAvailablePig}`;

  $("sellPriceKg").value=""; $("sellKg").value="";
  $("sellEkor").value=""; $("sellTotal").value="";
  $("sellNote").value="";

  // reset border
  $("sellEkor").style.borderColor = "rgba(255,255,255,.12)";
  if(!(await assertCanOperateOpenVault(vid))){
  toast("No access: this vault is not yours.");
  return;
  }
  openModal("mSell");
}

if(act==="close"){
  if(!(await assertCanOperateOpenVault(vid))){
    toast("No access: this vault is not yours.");
    return;
  }

  if(!confirm("Closing vault? Vault akan dipindah ke History.")) return;

  try{
    await closeVault(vid);
    toast("Vault closed ‚Üí History.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed");
  }
}
    if(act==="txEdit"){
  const vaultId = btn.dataset.v;
  const bucket  = btn.dataset.b;
  const txId    = btn.dataset.t;

  const txSnap = await get(ref(db, `vaults/${bucket}/${vaultId}/transactions/${txId}`));
  if(!txSnap.exists()){ toast("TX not found"); return; }

  const t = txSnap.val();

  ctxVaultId = vaultId;
  ctxEdit = { vaultId, bucket, txId, oldTx: t };

  // Open modal ikut jenis
  if(t.kind==="cash"){
    $("cashVaultTitle").textContent = `Edit Cash ‚Ä¢ Vault: ${vaultId}`;
    $("cashType").value = (t.direction==="in") ? "cash_in" : "cash_out";
    $("cashAmount").value = String(t.amount ?? t.total ?? "");
    $("cashNote").value = String(t.note||"");
    openModal("mCash");
  }

  if(t.kind==="buy"){
    $("buyVaultTitle").textContent = `Edit Buy ‚Ä¢ Vault: ${vaultId}`;
    $("buyCat").value = t.category || "baby_pig";
    $("buyQty").value = String(t.qty ?? "");
    $("buyPrice").value = String(t.price ?? "");
    $("buyTotal").value = String(t.total ?? "");
    $("buyNote").value = String(t.note||"");
    $("buyBalanceHint").textContent = `Current balance: ${fmt(currentBalance)}`;
    buyTotalManual = false;
    calcBuy();
    openModal("mBuy");
    calcBuy();
  }

  if(t.kind==="missing"){
    $("missingVaultTitle").textContent = `Edit Missing ‚Ä¢ Vault: ${vaultId}`;
    $("missQty").value = String(t.qty ?? "");
    $("missPrice").value = String(t.price ?? "");
    $("missTotal").value = String(t.total ?? "");
    $("missNote").value = String(t.note||"");
    openModal("mMissing");
    calcMissing();
  }

  if(t.kind==="sell"){
    $("sellVaultTitle").textContent = `Edit Sell ‚Ä¢ Vault: ${vaultId}`;

    // update context available (biar limit ekor masih ikut summary)
    const vSnap = await get(ref(db, `vaults/open/${vaultId}`));
    const s = (vSnap.exists() ? (vSnap.val().summary || {}) : {});
    const babyQty = Number(s.babyPig?.qty || 0);
    const missQty = Number(s.missing?.qty || 0);
    ctxMissingPig = missQty;
    ctxAvailablePig = Math.max(0, babyQty - missQty);

    $("sellMissing").value = String(ctxMissingPig);
    $("sellEkorHint").textContent = `Available Quantity: ${ctxAvailablePig}`;

    $("sellPriceKg").value = String(t.priceKg ?? "");
    $("sellKg").value = String(t.kg ?? "");
    $("sellEkor").value = String(t.ekor ?? "");
    $("sellTotal").value = String(t.total ?? "");
    $("sellNote").value = String(t.note||"");

    $("sellEkor").style.borderColor = "rgba(255,255,255,.12)";
    openModal("mSell");
    calcSell();
    validateSellEkor();
  }

  return;
}
  if(act==="txView"){
  const note = decodeURIComponent(btn.dataset.note || "");
  openViewNote(note);
  return;
}
if(act==="txDel"){
  const vaultId = btn.dataset.v;
  const bucket  = btn.dataset.b;
  const txId    = btn.dataset.t;

  if(bucket==="history" && !me.isAdmin){
    toast("Limited user: tiada akses delete history.");
    return;
  }
  if(!confirm("Delete transaction?")) return;

  try{
    const txPath = `vaults/${bucket}/${vaultId}/transactions/${txId}`;

    // 1) ambil tx dulu utk rollback kira delta (sbb lepas remove dah hilang)
    const txSnap = await get(ref(db, txPath));
    if(!txSnap.exists()){ toast("TX not found."); return; }
    const t = txSnap.val();

    // 2) REMOVE dulu ‚Äî kalau permission denied dia akan throw kat sini
    await remove(ref(db, txPath));

    // 3) recompute dulu
    await recomputeVaultSummary(vaultId, bucket);

    // 4) BARU adjust wallet (open sahaja)
    if(bucket === "open"){
      await adjustBalanceForTxDelete({ bucket, vaultId, txId, txObj: t });
    }

    toast("Deleted.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed");
  }
}

    if(act==="histEdit"){
      if(!me.isAdmin){ toast("No access."); return; }
      const newTitle = prompt("New title?");
      if(!newTitle) return;
      try{
        await update(ref(db, `vaults/history/${vid}`), { title: newTitle.trim(), updatedAt: serverTimestamp(), updatedAtMs: Date.now() });
        toast("Updated title.");
      }catch(e){
        console.error(e);
        toast(e?.message || "Failed");
      }
    }
if(act==="vaultDel"){
  const bucket = btn.dataset.b || "open";

  if(bucket==="history" && !me.isAdmin){
    toast("Admin sahaja boleh delete vault history.");
    return;
  }

  const msg = bucket==="history"
    ? "Delete vault HISTORY ini? Semua data akan hilang (tak boleh undo)."
    : "Delete vault ini? Semua transaksi dalam vault akan hilang.";

  if(!confirm(msg)) return;

  try{
    // 1) ambil semua tx dalam vault
    const txSnap = await get(ref(db, `vaults/${bucket}/${vid}/transactions`));
    const txs = txSnap.exists() ? txSnap.val() : {};

    // 2) kira total effect (cash/buy/sell)
    let sumEff = 0;
    for(const k of Object.keys(txs)){
      sumEff += txBalanceEffect(txs[k]);
    }

    // 3) reverse sekali jalan (lebih kemas)
   if(bucket === "open" && sumEff !== 0){
    await changeBalance(-sumEff, {
      kind:"vault_delete_adjust",
      bucket,
      vaultId: vid,
      note:"Delete vault rollback all tx"
    }, Date.now());
  }

    // 4) delete vault node
    await remove(ref(db, `vaults/${bucket}/${vid}`));

    toast("Vault deleted.");
  }catch(e){
    console.error(e);
    toast("Failed delete vault.");
  }
}
if(act==="vaultUnclose"){
  // ambil data history untuk check owner
  const hs = await get(ref(db, `vaults/history/${vid}`));
  if(!hs.exists()){
    toast("Vault history not found.");
    return;
  }
  const v = hs.val() || {};

  const isOwnerUnclose =
    me.isAdmin ||
    (v.createdByUid && v.createdByUid === me.uid) ||
    (v.closedByUid && v.closedByUid === me.uid);

  if(!isOwnerUnclose){
    toast("You only can unclose vault you created/closed.");
    return;
  }

  if(!confirm("Unclosing vault ini? Vault akan balik ke Open Vault.")) return;

  try{
    await uncloseVault(vid);
    toast("Vault moved back to Open Vault.");
    setView("open");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed unclosing.");
  }
}
  });

// CASH SAVE (CREATE + EDIT)
$("cashSave").addEventListener("click", async ()=>{
  const type = $("cashType").value;
  const amount = Number($("cashAmount").value||0);
  const note = $("cashNote").value.trim();
  if(amount<=0){ toast("Amount mesti > 0"); return; }

  const direction = (type==="cash_in") ? "in" : "out";
  const delta = (direction==="in") ? amount : -amount;

  const newTx = { kind:"cash", direction, amount, total: amount, note };

  try{
    const atMs = await getAtMsFromControl("cash", "txTime_cash");

    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      const old = ctxEdit.oldTx;

      const oldEff = txBalanceEffect(old);
      const newEff = txBalanceEffect(newTx);
      const diff = newEff - oldEff;

      if(diff !== 0){
        await changeBalance(diff, {
          kind:"tx_edit_adjust",
          txKind:"cash",
          vaultId: ctxEdit.vaultId,
          txId: ctxEdit.txId,
          note:"Edit cash"
        }, atMs);
      }

      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        atMs,
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });
      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);
      ctxEdit = null;
      closeModal("mCash");
      toast("Cash updated.");
      return;
    }
    // ===== CREATE MODE =====
    await changeBalance(delta, { kind:"cash_transfer", direction, amount, note, vaultId: ctxVaultId }, atMs);
    await addTx(ctxVaultId, newTx, atMs);

    closeModal("mCash");
    toast("Cash transfer saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed (maybe limited user no access).");
  }
});
// BUY AUTO CALC
function calcBuy(){
  const qty   = Number($("buyQty").value||0);
  const price = Number($("buyPrice").value||0);
  const autoTotal = (qty > 0 && price > 0) ? (qty * price) : 0;
  if(!buyTotalManual){
    $("buyTotal").value = autoTotal ? autoTotal.toFixed(2) : "";
  }

  const total = Number($("buyTotal").value||0);
  const enough = total <= currentBalance;
  $("buyTotal").style.borderColor = enough ? "rgba(255,255,255,.12)" : "rgba(239,68,68,.65)";
  $("buyBalanceHint").textContent = enough
    ? `Balance: ${fmt(currentBalance - total)}`
    : `Insufficient balance: ${fmt(total)} (Balance: ${fmt(currentBalance)})`;
}
["buyQty","buyPrice"].forEach(id=> $(id).addEventListener("input", ()=>{
  buyTotalManual = false;   // bila qty/price berubah -> auto balik
  calcBuy();
}));

$("buyTotal").addEventListener("input", ()=>{
  buyTotalManual = true;    // bila user sentuh total -> jadi manual
  calcBuy();
});

// BUY SAVE (CREATE + EDIT)
$("buySave").addEventListener("click", async ()=>{
  const category = $("buyCat").value;
  const qty = Number($("buyQty").value||0);
  const price = Number($("buyPrice").value||0);
  const total = Number($("buyTotal").value||0) || (qty*price);
  const note = $("buyNote").value.trim();

  if(total<=0){ toast("Total mesti > 0"); return; }

  try{
    const atMs = await getAtMsFromControl("buy", "txTime_buy"); // ‚úÖ MANUAL TIME
    const newTx = { kind:"buy", category, qty, price, total, note };

    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      const old = ctxEdit.oldTx;

      const oldEff = txBalanceEffect(old);
      const newEff = txBalanceEffect(newTx);
      const diff = newEff - oldEff; // buy negatif

      // kalau tambah cost (diff negatif) pastikan balance cukup
      if(diff < 0 && Math.abs(diff) > currentBalance){
        toast("Balance tak cukup untuk edit buy (tambahan cost).");
        return;
      }

      // adjust balance ikut beza
      if(diff !== 0){
        await changeBalance(diff, {
          kind:"tx_edit_adjust",
          txKind:"buy",
          vaultId: ctxEdit.vaultId,
          txId: ctxEdit.txId,
          note:"Edit buy"
        }, atMs);
      }

      // update tx (atMs ikut manual)
      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        atMs, // ‚úÖ ikut manual time
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });

      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);

      ctxEdit = null;
      closeModal("mBuy");
      toast("Buy updated.");
      return;
    }

    // ===== CREATE MODE =====
    if(total > currentBalance){
      toast("Modal tak cukup untuk buy.");
      return;
    }

    await changeBalance(-total, { kind:"buy", category, qty, price, total, note, vaultId: ctxVaultId }, atMs);
    await addTx(ctxVaultId, newTx, atMs);

    closeModal("mBuy");
    toast("Buy saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed (maybe limited user no access).");
  }
});

// MISSING AUTO CALC
function calcMissing(){
  const q = Number($("missQty").value||0);
  const p = Number($("missPrice").value||0);
  const t = q*p;
  $("missTotal").value = t ? t.toFixed(2) : "";
}
["missQty","missPrice"].forEach(id=> $(id).addEventListener("input", calcMissing));

// MISSING SAVE (CREATE + EDIT)
$("missSave").addEventListener("click", async ()=>{
  const qty = Number($("missQty").value||0);
  const price = Number($("missPrice").value||0);
  const total = qty * price;
  const note = $("missNote").value.trim();

  if(qty<=0 || price<=0){ toast("Missing & harga mesti > 0"); return; }

  try{
    const atMs = await getAtMsFromControl("missing", "txTime_missing"); // ‚úÖ MANUAL TIME
    const newTx = { kind:"missing", qty, price, total, note };

    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        atMs, // ‚úÖ ikut manual time
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });

      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);

      ctxEdit = null;
      closeModal("mMissing");
      toast("Missing updated.");
      return;
    }

    // ===== CREATE MODE =====
    await addTx(ctxVaultId, newTx, atMs);
    closeModal("mMissing");
    toast("Missing saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed");
  }
});

// SELL AUTO CALC
function calcSell(){
  const priceKg = Number($("sellPriceKg").value||0);
  const kg = Number($("sellKg").value||0);
  const total = priceKg * kg;
  $("sellTotal").value = total ? total.toFixed(2) : "";
}
["sellPriceKg","sellKg"].forEach(id=> $(id).addEventListener("input", calcSell));

// SELL SAVE (CREATE + EDIT)
$("sellSave").addEventListener("click", async ()=>{
  const priceKg = Number($("sellPriceKg").value||0);
  const kg = Number($("sellKg").value||0);
  const ekor = Number($("sellEkor").value||0);
  const total = Number($("sellTotal").value||0) || (priceKg*kg);
  const note = $("sellNote").value.trim();

  if(total<=0 || kg<=0){ toast("Price/Kg dan Kg mesti isi."); return; }
  if(ekor > ctxAvailablePig){
    toast(`Total ekor tak boleh lebih dari tersedia (${ctxAvailablePig}).`);
    $("sellEkor").focus();
    return;
  }

  try{
    const atMs = await getAtMsFromControl("sell", "txTime_sell"); // ‚úÖ MANUAL TIME
    const newTx = { kind:"sell", priceKg, kg, ekor, total, note };

    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      const old = ctxEdit.oldTx;

      const oldEff = txBalanceEffect(old);
      const newEff = txBalanceEffect(newTx);
      const diff = newEff - oldEff;

      // kalau diff negatif (kena tolak balik), check balance cukup
      if(diff < 0 && Math.abs(diff) > currentBalance){
        toast("Balance tak cukup untuk edit sell (kena tolak balik).");
        return;
      }

      if(diff !== 0){
        await changeBalance(diff, {
          kind:"tx_edit_adjust",
          txKind:"sell",
          vaultId: ctxEdit.vaultId,
          txId: ctxEdit.txId,
          note:"Edit sell"
        }, atMs);
      }

      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        atMs, // ‚úÖ ikut manual time
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });

      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);

      ctxEdit = null;
      closeModal("mSell");
      toast("Sell updated.");
      return;
    }

    // ===== CREATE MODE =====
    await changeBalance(+total, { kind:"sell", priceKg, kg, ekor, total, note, vaultId: ctxVaultId }, atMs);
    await addTx(ctxVaultId, newTx, atMs);

    closeModal("mSell");
    toast("Sell saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed (maybe limited user no access).");
  }
});
// VALIDATE EKOR INPUT
function validateSellEkor(){
  const ekor = Number($("sellEkor").value||0);
  const ok = ekor <= ctxAvailablePig;

  $("sellEkor").style.borderColor = ok ? "rgba(255,255,255,.12)" : "rgba(239,68,68,.85)";
  $("sellEkorHint").textContent = ok
    ? `Available Quantity: ${ctxAvailablePig}`
    : `Maximal Available: ${ctxAvailablePig} Not Available ${ekor}`;

  return ok;
}
$("sellEkor").addEventListener("input", validateSellEkor);

document.addEventListener("click", (e)=>{
  const btn = e.target.closest(".pbtn[data-preset][data-vid]");
  if(!btn) return;

  const vaultId = btn.dataset.vid;
  const key = btn.dataset.preset;

  const r = presetRangeMs(key);
  if(!r) return;

  vaultFilters[vaultId] = r;

  const fp = vaultPickers[vaultId];
  if(fp){
    fp.setDate([new Date(r.startMs), new Date(r.endMs)], true); // auto trigger render
  }else{
    rerenderVaultTbody(vaultId);
  }

  setActivePreset(vaultId, key);
});
  // ===== AUTH BOOT =====
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.replace("../login/"); return; }

  me.uid = user.uid;

  const p = await get(ref(db, `profiles/${me.uid}`));
  me.username = p.exists() ? (p.val().username || "user") : "user";
  $("usernameText").textContent = me.username;

  await loadRole(me.uid);
  initTxTimeControl({ kind:"newVault", inputId:"txTime_newVault", toggleId:"txTimeToggle_newVault" });
  initTxTimeControl({ kind:"cash",    inputId:"txTime_cash",    toggleId:"txTimeToggle_cash" });
  initTxTimeControl({ kind:"buy",     inputId:"txTime_buy",     toggleId:"txTimeToggle_buy" });
  initTxTimeControl({ kind:"missing", inputId:"txTime_missing", toggleId:"txTimeToggle_missing" });
  initTxTimeControl({ kind:"sell",    inputId:"txTime_sell",    toggleId:"txTimeToggle_sell" });

  wireBalanceListener();
  wireVaultListeners();
  setView("open");
  initCustomSelects();
    // üîÑ REFRESH BUTTON
  const btnRefresh = document.getElementById("btnRefresh");
  if(btnRefresh){
    btnRefresh.addEventListener("click", ()=>{
      btnRefresh.classList.add("spinning");
      setTimeout(()=> location.reload(), 250);
    });
  }
  toast("Ready.");
});
</script>
</body>
</html>
