<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Farm Admin</title>
  <style>
    :root{
      --btn:#1668dc; --btnH:#3c89e8; --btnA:#1554ad;
      --bg:#070b16; --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:#eaf1ff; --muted:rgba(234,241,255,.7);
      --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1000px 700px at 15% 15%, rgba(22,104,220,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 25%, rgba(60,137,232,.16), transparent 60%),
        linear-gradient(180deg,#050815,#070b16 55%,#040612);
      min-height:100vh;
    }

    header{
      height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 16px;
      position:sticky; top:0; z-index:50;
      background:#001529;
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke);
    }
    .brand{display:flex; gap:10px; align-items:center; font-weight:900; letter-spacing:.4px}
    .brand .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg,var(--btn),#5fb1ff);
      box-shadow: 0 14px 28px rgba(22,104,220,.24);
    }
    .right{display:flex; align-items:center; gap:10px}
    .btn-modal{
      border:0; border-radius:6px;padding: 0px 15px; cursor:pointer;
      background:#141414; color:white; border:1px solid #424242;
      transition:.15s transform, .15s background;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      height: 32px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-user{
      border:0; border-radius:6px;padding: 0px 15px; cursor:pointer;
      background:#141414; color:white; border:1px solid #424242;
      transition:.15s transform, .15s background;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      height: 32px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-logout{
      border:0; border-radius:6px; padding:0px 15px; cursor:pointer;
      background:#d11f3a; color:white;
      transition:.15s transform, .15s background;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      transition: all 0.2s;
      font-size: 14px;height: 32px;
    }
    .btn-logout:hover{background:#e2445b;}
    .btn-logout:active{background:#b31930;}
    .btn{
      border:0; border-radius:6px; padding: 0px 15px; cursor:pointer;
      background:var(--btn); color:white; font-weight:400;
      transition:.15s transform, .15s background;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      font-size: 14px;height: 32px;
      transition: all 0.2s;
    }
    .btn:hover{background:var(--btnH)}
    .btn:active{background:var(--btnA); transform: translateY(1px)}
    .btn.ghost{
      background:rgba(255,255,255,.06); border:1px solid var(--stroke); color:var(--txt);
    }
    .btn.ghost:hover{background:rgba(255,255,255,.10)}
    .pill{
      padding:8px 10px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      border-radius:999px; color:var(--muted); font-weight:800; font-size:12px;
    }

    .container{width:min(1200px,100%); margin:16px auto; padding:0 16px 24px}
    .topRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin:14px 0 12px;
    }
    .tabs{display:flex; gap:10px; align-items:center}
    .tab {
    border: 1px solid var(--stroke);
    background: rgba(255, 255, 255, .06);
    color: var(--muted);
    border-radius: 999px;
    padding: 0px 15px;
    cursor: pointer;
    height: 32px;
    align-items: center;
    font-size: 14px;
    }
    .tab.active{background:rgba(22,104,220,.18); color:var(--txt); border-color:rgba(22,104,220,.45)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .hint{color:var(--muted); font-size:12px; line-height:1.4}

    .grid{display:grid; gap:12px}
    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .title{
      font-weight:1000; font-size:16px; margin:0;
    }
    .sub{margin-top:4px; color:var(--muted); font-size:12px; font-weight:700}
    .vaultBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .cardBody{padding:12px 14px 14px}

    /* Excel-like table */
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top}
    th{
      position:sticky; top:0;
      background:rgba(10,14,28,.7);
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      font-size:12px; letter-spacing:.2px;
      color:var(--muted);
      z-index:1;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    .tblWrap{max-height:360px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:14px}
    .num{font-variant-numeric: tabular-nums}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 8px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px; font-weight:900;
      white-space:nowrap;
    }
    .tag.in{border-color:rgba(34,197,94,.35); color:rgba(186,255,214,.95); background:rgba(34,197,94,.12)}
    .tag.out{border-color:rgba(239,68,68,.35); color:rgba(255,204,204,.95); background:rgba(239,68,68,.12)}
    .tag.buy{border-color:rgba(245,158,11,.35); color:rgba(255,229,191,.95); background:rgba(245,158,11,.12)}
    .tag.sell{border-color:rgba(34,197,94,.35); color:rgba(186,255,214,.95); background:rgba(34,197,94,.12)}
    .profit.good{color:rgba(186,255,214,.95); font-weight:1000}
    .profit.bad{color:rgba(255,204,204,.95); font-weight:1000}

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:100;
    }
    .modal{
      width:min(640px,100%);
      background:rgba(10,14,28,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow: 0 24px 90px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead .x{
      width:38px; height:38px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:1000;
    }
    .modalBody{padding:12px 14px 14px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    label{display:block; margin:10px 0 6px; color:var(--muted); font-weight:800; font-size:12px}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(22,104,220,.7); box-shadow: 0 0 0 4px rgba(22,104,220,.18)
    }
    textarea{min-height:84px; resize:vertical}
    .modalFoot{
      display:flex; justify-content:flex-end; gap:10px;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
    }
    .danger{background:#d11f3a}
    .danger:hover{background:#e2445b}
    .danger:active{background:#b31930}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.78); color:var(--txt);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; display:none;
      max-width:min(720px,92vw);
      z-index:999;
    }
    .hr{height:1px;background:rgba(255,255,255,.10); margin:12px 0}
    .kpiRow{display:flex; gap:10px; flex-wrap:wrap}
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      padding:10px 12px; border-radius:10px;
      min-width: 133px;
    }
    .kpi .k{font-size:12px; color:var(--muted); font-weight:500}
    .kpi .v{margin-top:6px; font-weight:500; font-size:14px}
    .hide{display:none !important}
    .amtNeg{ color: rgba(255, 204, 204, .95); font-weight: 1000; }
    .good{ color:#41d37e; font-weight:900; }
    .bad{ color:#ff6b6b; font-weight:900; }
    /* ===== TABLE WRAP: boleh scroll kiri/kanan + atas/bawah ===== */
.tblWrap{
  width:100%;
  overflow-x:auto;     /* scroll kanan kiri */
  overflow-y:auto;     /* scroll atas bawah (kalau tinggi) */
  -webkit-overflow-scrolling: touch;
  border-radius: 14px;
}

/* Paksa table tak wrap, supaya tak turun line */
.tblWrap table{
  width:100%;
  min-width: 980px;          /* penting: kalau screen kecil, dia akan scroll */
  border-collapse: collapse;
  table-layout: auto;
}

/* Semua cell jangan wrap */
.tblWrap th,
.tblWrap td{
  white-space: nowrap;       /* ini yang buat text & button tak turun */
}

/* Kalau kau nak Description masih boleh panjang tanpa wrap, tapi ada ellipsis */
.tblWrap td:nth-child(2){
  max-width: 420px;          /* adjust ikut suka */
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Actions jangan turun & spacing kemas */
.tblWrap td:last-child > div{
  flex-wrap: nowrap !important;
}

/* ===== Scrollbar style (grey, clean) ===== */
/* Chrome/Edge/Safari */
.tblWrap::-webkit-scrollbar{
  height: 10px;  /* horizontal */
  width: 10px;   /* vertical */
}
.tblWrap::-webkit-scrollbar-track{
  background: rgba(255,255,255,.06);
  border-radius: 999px;
}
.tblWrap::-webkit-scrollbar-thumb{
  background: rgba(160,160,160,.45); /* grey */
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.25);
}
.tblWrap::-webkit-scrollbar-thumb:hover{
  background: rgba(190,190,190,.65);
}

/* Firefox */
.tblWrap{
  scrollbar-width: thin;
  scrollbar-color: rgba(170,170,170,.55) rgba(255,255,255,.06);
}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      FARM VAULT <span class="pill" id="rolePill">loading...</span>
      <div class="hint" style="margin-top:2px">Realtime ‚Ä¢ Secure ‚Ä¢ Cloud</div>
    </div>
  </div>

  <div class="right">
    <button class="btn-modal" id="btnBalance">Wallet: <span class="num" id="balanceText">0.00</span></button>
    <button class="btn-user" id="btnUser">üë§ <span id="usernameText">...</span></button>
    <button class="btn-logout" id="btnLogout">Logout</button>
  </div>
</header>

<div class="container">
  <div class="topRow">
    <div class="tabs">
      <button class="tab active" id="tabOpen">Open Vault</button>
      <button class="tab" id="tabHistory">History</button>
    </div>

    <div class="actions">
      <button class="btn" id="btnAddPoint">‚ûï Add Point</button>
      <button class="btn" id="btnNewVault">üìÅ Open New Vault</button>
    </div>
  </div>

  <!-- OPEN -->
  <div id="viewOpen" class="grid"></div>

  <!-- HISTORY -->
  <div id="viewHistory" class="grid hide"></div>
</div>

<div class="toast" id="toast"></div>

<!-- MODALS -->
<div class="modalBack" id="mBalance">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Modal Saya</div>
        <div class="sub">Balance ini digunakan untuk Cash Transfer, Buy dan Sell.</div>
      </div>
      <button class="x" data-close="mBalance">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="kpiRow">
        <div class="kpi">
          <div class="k">Current Balance</div>
          <div class="v num" id="balanceBig">0.00</div>
        </div>
        <div class="kpi">
          <div class="k">Last Update</div>
          <div class="v num" id="balanceUpdated">-</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="hint">Balance disimpan di path: <b>finance/balance</b>. Ledger log disimpan di <b>finance/ledger</b>.</div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mBalance">Close</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mAddPoint">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Add Point (Modal In/Out)</div>
        <div class="sub">Admin sahaja boleh buat ini.</div>
      </div>
      <button class="x" data-close="mAddPoint">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Type</label>
      <select id="apType">
        <option value="in">IN (Tambah Modal)</option>
        <option value="out">OUT (Tolak Modal)</option>
      </select>

      <div class="row">
        <div>
          <label>Amount</label>
          <input id="apAmount" type="number" min="0" step="0.01" placeholder="contoh 100000" />
        </div>
        <div>
          <label>Note</label>
          <input id="apNote" placeholder="contoh: topup / keluarkan modal" />
        </div>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mAddPoint">Cancel</button>
      <button class="btn" id="apSave">Save</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mNewVault">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Open New Vault</div>
        <div class="sub">Isi title contoh: ‚ÄúFeb 2026‚Äù, ‚ÄúLot A‚Äù, ‚ÄúBatch 01‚Äù.</div>
      </div>
      <button class="x" data-close="mNewVault">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Title</label>
      <input id="nvTitle" placeholder="contoh: FEB 2026" />
      <label>Note (optional)</label>
      <textarea id="nvNote" placeholder="catatan vault..."></textarea>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mNewVault">Cancel</button>
      <button class="btn" id="nvCreate">Create</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mCash">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Cash Transfer</div>
        <div class="sub" id="cashVaultTitle">-</div>
      </div>
      <button class="x" data-close="mCash">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Type</label>
      <select id="cashType">
        <option value="cash_in">Cash-IN (Tambah Balance)</option>
        <option value="cash_out">Cash-OUT (Tolak Balance)</option>
      </select>

      <div class="row">
        <div>
          <label>Amount</label>
          <input id="cashAmount" type="number" min="0" step="0.01" placeholder="contoh 1000" />
        </div>
        <div>
          <label>Note</label>
          <input id="cashNote" placeholder="contoh: cash keluar/masuk" />
        </div>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mCash">Cancel</button>
      <button class="btn" id="cashSave">Save</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mBuy">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Buy</div>
        <div class="sub" id="buyVaultTitle">-</div>
      </div>
      <button class="x" data-close="mBuy">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Category</label>
      <select id="buyCat">
        <option value="baby_pig">Bayi Babi</option>
        <option value="feed">Pakan Babi</option>
        <option value="other">Other</option>
      </select>

      <div class="row">
        <div>
          <label>Qty (ekor / unit)</label>
          <input id="buyQty" type="number" min="0" step="1" placeholder="contoh 10" />
        </div>
        <div>
          <label>Price per Unit</label>
          <input id="buyPrice" type="number" min="0" step="0.01" placeholder="contoh 250" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Total Price</label>
          <input id="buyTotal" type="number" min="0" step="0.01" placeholder="auto kira" />
          <div class="hint" id="buyBalanceHint"></div>
        </div>
        <div>
          <label>Note</label>
          <input id="buyNote" placeholder="contoh: batch A / supplier ..." />
        </div>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mBuy">Cancel</button>
      <button class="btn" id="buySave">Save</button>
    </div>
  </div>
</div>

<div class="modalBack" id="mSell">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Sell</div>
        <div class="sub" id="sellVaultTitle">-</div>
      </div>
      <button class="x" data-close="mSell">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <div>
          <label>Price per Kg</label>
          <input id="sellPriceKg" type="number" min="0" step="0.01" placeholder="contoh 12.50" />
        </div>
        <div>
          <label>Total Kg</label>
          <input id="sellKg" type="number" min="0" step="0.01" placeholder="contoh 350" />
        </div>
      </div>
<div class="row">
  <div>
    <label>Total Ekor</label>
    <input id="sellEkor" type="number" min="0" step="1" placeholder="contoh 20" />
    <div class="hint" id="sellEkorHint"></div>
  </div>

  <div>
    <label>Missing (auto)</label>
    <input id="sellMissing" type="number" disabled placeholder="auto" />
  </div>

  <div>
    <label>Total Hasil (auto)</label>
    <input id="sellTotal" type="number" min="0" step="0.01" placeholder="auto kira" />
  </div>
</div>
      <label>Note</label>
      <input id="sellNote" placeholder="contoh: buyer / invoice ..." />
    </div>
    <div class="modalFoot">
      <button class="btn ghost" data-close="mSell">Cancel</button>
      <button class="btn" id="sellSave">Save</button>
    </div>
  </div>
</div>
<div class="modalBack" id="mMissing">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="title">Missing</div>
        <div class="sub" id="missingVaultTitle">-</div>
      </div>
      <button class="x" data-close="mMissing">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="row">
        <div>
          <label>Missing (ekor)</label>
          <input id="missQty" type="number" min="0" step="1" placeholder="contoh 2" />
        </div>
        <div>
          <label>Harga per-Ekor</label>
          <input id="missPrice" type="number" min="0" step="0.01" placeholder="contoh 25000" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Total (auto)</label>
          <input id="missTotal" type="number" disabled placeholder="auto kira" />
        </div>
        <div>
          <label>Note</label>
          <input id="missNote" placeholder="contoh: missing sebab sakit / hilang" />
        </div>
      </div>

      <div class="hint">Ini catatan sahaja. Tak tambah/tolak modal dan tak masuk Total Buy.</div>
    </div>

    <div class="modalFoot">
      <button class="btn ghost" data-close="mMissing">Cancel</button>
      <button class="btn" id="missSave">Save</button>
    </div>
  </div>
</div>

<!-- VIEW NOTE MODAL -->
<div class="modalBack" id="mViewNote" style="display:none;">
  <div class="modal" style="max-width:520px;">
    <div class="modalHead" style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-weight:800;">Note</div>
      <button class="btn ghost" data-close="mViewNote" type="button" aria-label="Close">‚úï</button>
    </div>

    <div class="modalBody">
      <div id="viewNoteText" class="hint" style="white-space:pre-wrap;line-height:1.45;"></div>
    </div>

    <div class="modalFoot" style="display:flex;justify-content:flex-end;gap:10px;">
      <button class="btn ghost" data-close="mViewNote" type="button">Close</button>
    </div>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getDatabase, ref, get, set, push, update, remove, onValue,
    serverTimestamp, query, orderByChild, limitToLast
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // === CONFIG KAU ===
  const firebaseConfig = {
    apiKey: "AIzaSyCXGxdJOEbcotIXRWyDGHNNCbcmFev-qZY",
    authDomain: "farm-a9071.firebaseapp.com",
    databaseURL: "https://farm-a9071-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "farm-a9071",
    storageBucket: "farm-a9071.firebasestorage.app",
    messagingSenderId: "979250293394",
    appId: "1:979250293394:web:af419dd2b325017a41944b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{
    const el = $("toast");
    el.textContent = msg;
    el.style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> el.style.display="none", 2600);
  };

  const fmt = (n)=> (Number(n||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtDT = (ms)=> {
    if(!ms) return "-";
    const d = new Date(ms);
    return d.toLocaleString();
  };

  let me = { uid:null, username:null, isAdmin:false };
  let currentBalance = 0;

  // UI state
  let activeView = "open"; // open | history
  let ctxVaultId = null;   // modal context
  let ctxAvailablePig = 0;
  let ctxMissingPig = 0;
  let ctxEdit = null; 

  // ===== MODAL helper =====
  function openModal(id){ $(id).style.display="flex"; }
  function closeModal(id){
  $(id).style.display="none";

  if(id==="mCash" || id==="mBuy" || id==="mMissing" || id==="mSell"){
    ctxEdit = null;
  }
}
  document.addEventListener("click",(e)=>{
    const t = e.target;
    if(t?.dataset?.close) closeModal(t.dataset.close);
    if(t.classList.contains("modalBack")) t.style.display="none";
  });

  // ===== ROLE =====
  async function loadRole(uid){
    const r = await get(ref(db, `roles/${uid}`));
    const role = r.exists() ? r.val() : {};
    me.isAdmin = role?.isAdmin === true;
    me.username = role?.username || me.username || "user";
    $("rolePill").textContent = me.isAdmin ? "ADMIN" : "LIMITED";
    $("usernameText").textContent = me.username;

    // permission UI
    $("btnAddPoint").classList.toggle("hide", !me.isAdmin);
  }

  // ===== BALANCE =====
  function wireBalanceListener(){
    onValue(ref(db,"finance/balance"), (snap)=>{
      const v = snap.val() || {};
      currentBalance = Number(v.amount||0);
      $("balanceText").textContent = fmt(currentBalance);
      $("balanceBig").textContent  = fmt(currentBalance);
      $("balanceUpdated").textContent = v.updatedAtMs ? fmtDT(v.updatedAtMs) : "-";
    });
  }

  async function changeBalance(delta, meta){
    // only admin should call (rules enforce)
    const now = Date.now();
    const ledRef = push(ref(db,"finance/ledger"));
    const newAmount = currentBalance + delta;

    const updates = {};
    updates["finance/balance"] = {
      amount: newAmount,
      updatedAt: serverTimestamp(),
      updatedAtMs: now,
      byUid: me.uid,
      byUser: me.username
    };
    updates[`finance/ledger/${ledRef.key}`] = {
      ...meta,
      delta,
      balanceAfter: newAmount,
      at: serverTimestamp(),
      atMs: now,
      byUid: me.uid,
      byUser: me.username
    };
    await update(ref(db), updates);
  }

  // ===== VAULTS =====
  function vaultRefOpen(){ return ref(db, "vaults/open"); }
  function vaultRefHist(){ return ref(db, "vaults/history"); }

  async function createVault(title, note){
    const now = Date.now();
    const vRef = push(vaultRefOpen());
    await set(vRef, {
      title: String(title||"").trim(),
      note: String(note||"").trim(),
      status: "open",
      createdAt: serverTimestamp(),
      createdAtMs: now,
      createdByUid: me.uid,
      createdBy: me.username,
      summary: { totalCost:0, totalKg:0, totalEkor:0, totalRevenue:0, profit:0 }
    });
  }

  async function addTx(vaultId, tx){
    const now = Date.now();
    const txRef = push(ref(db, `vaults/${activeView==="open" ? "open":"history"}/${vaultId}/transactions`));
    await set(txRef, { ...tx, at: serverTimestamp(), atMs: now, byUid: me.uid, byUser: me.username });
    await recomputeVaultSummary(vaultId, activeView==="open" ? "open":"history");
  }

async function recomputeVaultSummary(vaultId, bucket){
  const snap = await get(ref(db, `vaults/${bucket}/${vaultId}/transactions`));
  const txs = snap.exists() ? snap.val() : {};

  let totalCost=0, totalKg=0, totalEkor=0, totalRevenue=0;
  let missingQty = 0;

  let sellKgSum = 0;
  let sellPriceKgWeighted = 0;

  let babyQty = 0;
  let babyTotal = 0;
  let babyPriceSum = 0;

  for(const k of Object.keys(txs)){
    const t = txs[k];

    if(t.kind==="missing"){
      missingQty += Number(t.qty||0);
    }

    if(t.kind==="buy"){
      const tTotal = Number(t.total||0);
      totalCost += tTotal;

      if(t.category === "baby_pig"){
        const q = Number(t.qty||0);
        const p = Number(t.price||0);
        babyQty += q;
        babyTotal += tTotal;
        babyPriceSum += (q * p);
      }
    }

    if(t.kind==="sell"){
      const kg = Number(t.kg||0);
      const pk = Number(t.priceKg||0);

      totalRevenue += Number(t.total||0);
      totalKg += kg;
      totalEkor += Number(t.ekor||0);

      if(kg > 0 && pk > 0){
        sellKgSum += kg;
        sellPriceKgWeighted += (pk * kg);
      }
    }
  } // ‚úÖ INI YANG KAU TAK ADA TADI (tutup for)

  const profit = totalRevenue - totalCost;
  const babyAvgPrice = babyQty > 0 ? (babyPriceSum / babyQty) : 0;
  const avgPriceKg = sellKgSum > 0 ? (sellPriceKgWeighted / sellKgSum) : 0;

  await update(ref(db, `vaults/${bucket}/${vaultId}`), {
    summary: {
      totalCost, totalKg, totalEkor, totalRevenue, profit,
      babyPig: { qty:babyQty, avgPrice:babyAvgPrice, total:babyTotal },
      missing: { qty: missingQty },
      sell: { avgPriceKg },
      availablePig: Math.max(0, babyQty - missingQty - totalEkor)
    },
    updatedAt: serverTimestamp(),
    updatedAtMs: Date.now()
  });
}

  async function closeVault(vaultId){
    // move open -> history (multi update)
    const openSnap = await get(ref(db, `vaults/open/${vaultId}`));
    if(!openSnap.exists()) return;

    const data = openSnap.val();
    const now = Date.now();

    const updates = {};
    updates[`vaults/history/${vaultId}`] = {
      ...data,
      status: "closed",
      closedAt: serverTimestamp(),
      closedAtMs: now,
      closedByUid: me.uid,
      closedBy: me.username
    };
    updates[`vaults/open/${vaultId}`] = null;
    await update(ref(db), updates);
  }
async function uncloseVault(vaultId){
  const histSnap = await get(ref(db, `vaults/history/${vaultId}`));
  if(!histSnap.exists()) return;

  const data = histSnap.val();
  const now = Date.now();

  // buang field closing dari history supaya open jadi "clean"
  const {
    closedAt, closedAtMs, closedBy, closedByUid,
    ...rest
  } = data || {};

  const openData = {
    ...rest,
    status: "open",
    reopenedAt: serverTimestamp(),
    reopenedAtMs: now,
    reopenedByUid: me.uid,
    reopenedBy: me.username,
  };

  // 1) letak balik ke OPEN
  await set(ref(db, `vaults/open/${vaultId}`), openData);

  // 2) buang dari HISTORY
  await remove(ref(db, `vaults/history/${vaultId}`));
}
  // ===== RENDER =====
  function setView(v){
    activeView = v;
    $("tabOpen").classList.toggle("active", v==="open");
    $("tabHistory").classList.toggle("active", v==="history");
    $("viewOpen").classList.toggle("hide", v!=="open");
    $("viewHistory").classList.toggle("hide", v!=="history");
  }

  function vaultCardHTML(vaultId, v, bucket){
    const s = v.summary || { totalCost:0,totalKg:0,totalEkor:0,totalRevenue:0,profit:0 };
    const bp = (s.babyPig || { qty:0, avgPrice:0, total:0 });
    const availablePig = Number(s.availablePig ?? Math.max(0, Number(bp.qty||0) - Number(s.missing?.qty||0) - Number(s.totalEkor||0)));
    const avgPriceKg = Number(s.sell?.avgPriceKg || 0);
    const profitClass = (s.profit||0) >= 0 ? "good" : "bad";
    const salesValue = (Number(s.totalRevenue||0) > 0)
    ? (Number(s.totalRevenue||0) - Number(s.totalCost||0))
    : 0;
    const salesClass = salesValue >= 0 ? "good" : "bad";
    const created = v.createdAtMs ? fmtDT(v.createdAtMs) : "-";
    const updated = v.updatedAtMs ? fmtDT(v.updatedAtMs) : "-";
    const closed  = v.closedAtMs  ? fmtDT(v.closedAtMs)  : "-";

    const canEdit = me.isAdmin; // rule: farm88
    const isHistory = bucket === "history";

    return `
      <div class="card" data-vid="${vaultId}" data-bucket="${bucket}">
        <div class="cardHead">
          <div>
            <div class="title">${escapeHtml(v.title || "Untitled Vault")}</div>
            <div class="sub">
              Created: <span class="num">${created}</span>
              ${isHistory ? ` ‚Ä¢ Closed: <span class="num">${closed}</span>` : ``}
              <br>Updated: <span class="num">${updated}</span>
            </div>
          </div>
          <div class="vaultBtns">
            ${!isHistory ? `
              <button class="btn ghost" data-act="cash" data-id="${vaultId}">Cash Transfer</button>
              <button class="btn ghost" data-act="buy" data-id="${vaultId}">Buy</button>
              <button class="btn ghost" data-act="missing" data-id="${vaultId}">Missing</button>
              <button class="btn ghost" data-act="sell" data-id="${vaultId}">Sell</button>
              <button class="btn danger" data-act="close" data-id="${vaultId}">Closing</button>
            ` : `
              ${canEdit ? `<button class="btn ghost" data-act="histEdit" data-id="${vaultId}">Edit Title</button>` : ``}
            `}
          </div>
        </div>
        <div class="cardBody">
<div class="kpiRow" style="margin-bottom:10px">
  <div class="kpi">
    <div class="k">Total Buy (Cost)</div>
    <div class="v num">${fmt(s.totalCost)}</div>
  </div>
</div>

<!-- Tambah 3 box bawah Total Buy -->
<div class="kpiRow" style="margin-bottom:14px">
  <div class="kpi">
    <div class="k">Bayi Babi</div>
    <div class="v num">${Number(bp.qty||0).toLocaleString()}</div>
  </div>

  <div class="kpi">
    <div class="k">Harga per-Ekor</div>
    <div class="v num">${fmt(bp.avgPrice||0)}</div>
  </div>

  <div class="kpi">
    <div class="k">Total Harga</div>
    <div class="v num">${fmt(bp.total||0)}</div>
  </div>
</div>

<div class="kpiRow">
  <div class="kpi">
    <div class="k">Total Sell (Revenue)</div>
    <div class="v num">${fmt(s.totalRevenue)}</div>
  </div>

<div class="kpi">
  <div class="k">Harga per Kg</div>
  <div class="v num">${fmt(avgPriceKg)}</div>
</div>

  <div class="kpi">
    <div class="k">Total Kg</div>
    <div class="v num">${fmt(s.totalKg)}</div>
  </div>

  <div class="kpi">
    <div class="k">Total Ekor</div>
    <div class="v num">${Number(s.totalEkor||0).toLocaleString()}</div>
  </div>
  
 <div class="kpi">
  <div class="k">Missing</div>
  <div class="v num">${Number((s.missing?.qty)||0).toLocaleString()}</div>
</div>

<div class="kpi">
  <div class="k">Tersedia Babi</div>
  <div class="v num">${availablePig.toLocaleString()}</div>
</div>

  <div class="kpi">
    <div class="k">Profit / Loss</div>
    <div class="v num profit ${profitClass}">${fmt(s.profit)}</div>
  </div>

<div class="kpi">
  <div class="k">Sales</div>
  <div class="v num ${salesClass}">${fmt(salesValue)}</div>
</div>
</div>

          <div class="hr"></div>
          <div class="tblWrap">
            <table>
             <thead>
  <tr>
    <th style="width:120px">Type</th>
    <th>Description</th>

    <th style="width:120px">Berapa Ekor</th>
    <th style="width:150px">Harga Per-Ekor</th>

    <th style="width:150px">Amount</th>
    <th style="width:180px">Date & Time</th>
    <th style="width:180px">Actions</th>
  </tr>
</thead>
              <tbody data-tbody="${vaultId}"><tr><td colspan="5" class="hint">Loading...</td></tr></tbody>
            </table>
          </div>

${v.note ? `<div class="hr"></div><div class="hint"><b>Note:</b> ${escapeHtml(v.note)}</div>` : ``}

<div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px">
  ${
    (!isHistory)
      ? `<button class="btn danger" data-act="vaultDel" data-id="${vaultId}" data-b="open">Delete Vault</button>`
      : (
          me.isAdmin
            ? `
              <button class="btn ghost" data-act="vaultUnclose" data-id="${vaultId}">Unclosing</button>
              <button class="btn danger" data-act="vaultDel" data-id="${vaultId}" data-b="history">Delete Vault</button>
            `
            : ``
        )
  }
</div>
        </div>
      </div>
    `;
  }

function txRowHTML(vaultId, txId, t, bucket){
  const at = t.atMs ? fmtDT(t.atMs) : "-";

  let typeTag = `<span class="tag">TX</span>`;
  if(t.kind==="cash") typeTag = `<span class="tag ${t.direction==="in"?"in":"out"}">${t.direction==="in"?"CASH-IN":"CASH-OUT"}</span>`;
  if(t.kind==="buy")  typeTag = `<span class="tag buy">BUY</span>`;
  if(t.kind==="sell") typeTag = `<span class="tag sell">SELL</span>`;
  if(t.kind==="missing") typeTag = `<span class="tag out">MISSING</span>`;

  // Amount
  let amount = Number(t.total||t.amount||0);
  if(t.kind==="missing") amount = -Math.abs(amount); // display negatif
  const amountText = fmt(amount);
  const amtClass = amount < 0 ? "amtNeg" : "";

  // === NEW: qty (ekor) & unit price column ===
  let qtyEkor = "";
  let unitPrice = "";

  if(t.kind==="buy"){
    qtyEkor = Number(t.qty||0) ? String(Number(t.qty||0).toLocaleString()) : "";
    unitPrice = Number(t.price||0) ? fmt(t.price||0) : "";
  }else if(t.kind==="missing"){
    qtyEkor = Number(t.qty||0) ? String(Number(t.qty||0).toLocaleString()) : "";
    unitPrice = Number(t.price||0) ? fmt(t.price||0) : "";
  }else if(t.kind==="sell"){
    // sell pakai ekor + priceKg (kalau kau nak)
    qtyEkor = Number(t.ekor||0) ? String(Number(t.ekor||0).toLocaleString()) : "";
    // Kalau kau nak kolum ni khas ‚ÄúHarga Per-Ekor‚Äù, untuk sell memang tak sama.
    // Jadi aku letak kosong. Kalau kau nak letak Harga/Kg, uncomment bawah:
    // unitPrice = Number(t.priceKg||0) ? fmt(t.priceKg||0) : "";
    unitPrice = "";
  }else{
    qtyEkor = "";
    unitPrice = "";
  }

  // Description (dah tak ada "qty @ ...")
  const desc = buildTxDesc(t);

  // actions: open semua boleh, history admin sahaja
  const showActions = bucket==="open" ? true : me.isAdmin;

  const hasNote = String(t.note||"").trim().length > 0;

  return `
    <tr data-txid="${txId}">
      <td>${typeTag}</td>
      <td>${escapeHtml(desc)}</td>

      <td class="num">${escapeHtml(qtyEkor || "-")}</td>
      <td class="num">${escapeHtml(unitPrice || "-")}</td>

      <td class="num ${amtClass}">${amountText}</td>
      <td class="num">${at}</td>
      <td>
        ${showActions ? `
          <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap">
            ${hasNote ? `
              <button class="btn ghost" style="padding:8px 10px"
                data-act="txView" data-note="${escapeHtml(t.note)}">
                View
              </button>
            ` : ``}
            <button class="btn ghost" style="padding:8px 10px"
              data-act="txEdit" data-v="${vaultId}" data-b="${bucket}" data-t="${txId}">
              Edit
            </button>
            <button class="btn ghost" style="padding:8px 10px"
              data-act="txDel" data-v="${vaultId}" data-b="${bucket}" data-t="${txId}">
              Delete
            </button>
          </div>
        ` : `<span class="hint">-</span>`}
      </td>
    </tr>
  `;
}

function buildTxDesc(t){
  if(t.kind==="cash"){
    return t.direction==="in" ? "Cash In" : "Cash Out";
  }

  if(t.kind==="buy"){
    return t.category==="baby_pig" ? "Bayi Babi"
         : (t.category==="feed" ? "Pakan Babi" : "Other");
  }

  if(t.kind==="missing"){
    return "Missing";
  }

  if(t.kind==="sell"){
    return `${fmt(t.kg||0)} kg`;
  }

  return "Transaction";
}

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function txBalanceEffect(t){
  if(!t) return 0;

  if(t.kind === "cash"){
    const amt = Number(t.amount || t.total || 0);
    return (t.direction === "in") ? amt : -amt;
  }

  if(t.kind === "buy"){
    return -Math.abs(Number(t.total || 0));
  }

  if(t.kind === "sell"){
    return Math.abs(Number(t.total || 0));
  }

  // missing memang tak sentuh balance
  return 0;
}
function openViewNote(noteText){
  const txt = String(noteText || "").trim();
  $("viewNoteText").textContent = txt ? txt : "No note.";
  openModal("mViewNote");
}
  function renderVaultList(targetId, data, bucket){
    const el = $(targetId);
    const entries = Object.entries(data||{});

    // sort: latest createdAtMs desc
    entries.sort((a,b)=> (Number(b[1]?.createdAtMs||0) - Number(a[1]?.createdAtMs||0)));

    if(entries.length===0){
      el.innerHTML = `<div class="card"><div class="cardBody"><div class="hint">No vault yet.</div></div></div>`;
      return;
    }

    el.innerHTML = entries.map(([id,v]) => vaultCardHTML(id,v,bucket)).join("");

    // now bind tx listeners per vault
    for(const [id] of entries){
      const txPath = `vaults/${bucket}/${id}/transactions`;
      onValue(ref(db, txPath), (snap)=>{
        const txs = snap.exists()? snap.val() : {};
        const tbody = document.querySelector(`[data-tbody="${id}"]`);
        if(!tbody) return;

        const rows = Object.entries(txs);
        rows.sort((a,b)=> Number(a[1]?.atMs||0) - Number(b[1]?.atMs||0)); // ascending
        if(rows.length===0){
          tbody.innerHTML = `<tr><td colspan="5" class="hint">No transaction yet.</td></tr>`;
          return;
        }
        tbody.innerHTML = rows.map(([txId,t]) => txRowHTML(id,txId,t,bucket)).join("");
      });
    }
  }

  function wireVaultListeners(){
    // Open vaults
    onValue(query(vaultRefOpen(), orderByChild("createdAtMs"), limitToLast(80)), (snap)=>{
      const data = snap.exists()? snap.val() : {};
      renderVaultList("viewOpen", data, "open");
    });

    // History vaults
    onValue(query(vaultRefHist(), orderByChild("createdAtMs"), limitToLast(120)), (snap)=>{
      const data = snap.exists()? snap.val() : {};
      renderVaultList("viewHistory", data, "history");
    });
  }

  // ===== EVENTS =====
  $("btnBalance").addEventListener("click", ()=> openModal("mBalance"));
  $("btnUser").addEventListener("click", ()=> toast(`Login as: ${me.username}`));
  $("btnLogout").addEventListener("click", async ()=>{
    await signOut(auth);
    location.replace("../login/");
  });

  $("tabOpen").addEventListener("click", ()=> setView("open"));
  $("tabHistory").addEventListener("click", ()=> setView("history"));

  $("btnAddPoint").addEventListener("click", ()=>{
    if(!me.isAdmin){ toast("Limited user: tiada akses Add Point."); return; }
    $("apType").value="in"; $("apAmount").value=""; $("apNote").value="";
    openModal("mAddPoint");
  });

  $("btnNewVault").addEventListener("click", ()=>{
    $("nvTitle").value=""; $("nvNote").value="";
    openModal("mNewVault");
  });

  $("apSave").addEventListener("click", async ()=>{
    if(!me.isAdmin){ toast("No access."); return; }
    const type = $("apType").value;
    const amount = Number($("apAmount").value||0);
    const note = $("apNote").value.trim();
    if(amount<=0){ toast("Amount mesti > 0"); return; }

    const delta = (type==="in") ? amount : -amount;

    try{
      await changeBalance(delta, { kind:"add_point", direction:type, amount, note });
      closeModal("mAddPoint");
      toast("Balance updated.");
    }catch(e){
      console.error(e);
      toast(e?.message || "Failed");
    }
  });

  $("nvCreate").addEventListener("click", async ()=>{
    const title = $("nvTitle").value.trim();
    const note  = $("nvNote").value.trim();
    if(!title){ toast("Title wajib isi."); return; }
    try{
      await createVault(title, note);
      closeModal("mNewVault");
      toast("Vault created.");
      setView("open");
    }catch(e){
      console.error(e);
      toast(e?.message || "Failed");
    }
  });

  // table button actions (event delegation)
  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest("[data-act]");
    if(!btn) return;

    const act = btn.dataset.act;
    const vid = btn.dataset.id;

    if(act==="cash"){
      ctxVaultId = vid;
      const vSnap = await get(ref(db, `vaults/open/${vid}`));
      $("cashVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";
      $("cashType").value="cash_in"; $("cashAmount").value=""; $("cashNote").value="";
      openModal("mCash");
    }

    if(act==="buy"){
      ctxVaultId = vid;
      const vSnap = await get(ref(db, `vaults/open/${vid}`));
      $("buyVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";
      $("buyCat").value="baby_pig";
      $("buyQty").value=""; $("buyPrice").value=""; $("buyTotal").value="";
      $("buyNote").value="";
      $("buyBalanceHint").textContent = `Current balance: ${fmt(currentBalance)}`;
      openModal("mBuy");
    }
    if(act==="missing"){
  ctxVaultId = vid;
  const vSnap = await get(ref(db, `vaults/open/${vid}`));
  $("missingVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";

  $("missQty").value="";
  $("missPrice").value="";
  $("missTotal").value="";
  $("missNote").value="";
  openModal("mMissing");
}

if(act==="sell"){
  ctxVaultId = vid;
  const vSnap = await get(ref(db, `vaults/open/${vid}`));
  $("sellVaultTitle").textContent = vSnap.exists()? `Vault: ${vSnap.val().title}` : "Vault";

  const s = (vSnap.exists() ? (vSnap.val().summary || {}) : {});
  const babyQty = Number(s.babyPig?.qty || 0);
  const missQty = Number(s.missing?.qty || 0);

  ctxMissingPig = missQty;
  ctxAvailablePig = Math.max(0, babyQty - missQty);

  $("sellMissing").value = String(ctxMissingPig);
  $("sellEkorHint").textContent = `Tersedia untuk jual: ${ctxAvailablePig} ekor`;

  $("sellPriceKg").value=""; $("sellKg").value="";
  $("sellEkor").value=""; $("sellTotal").value="";
  $("sellNote").value="";

  // reset border
  $("sellEkor").style.borderColor = "rgba(255,255,255,.12)";

  openModal("mSell");
}

    if(act==="close"){
      if(!confirm("Closing vault? Vault akan dipindah ke History.")) return;
      try{
        await closeVault(vid);
        toast("Vault closed ‚Üí History.");
      }catch(e){
        console.error(e);
        toast(e?.message || "Failed");
      }
    }
    if(act==="txEdit"){
  const vaultId = btn.dataset.v;
  const bucket  = btn.dataset.b;
  const txId    = btn.dataset.t;

  const txSnap = await get(ref(db, `vaults/${bucket}/${vaultId}/transactions/${txId}`));
  if(!txSnap.exists()){ toast("TX not found"); return; }

  const t = txSnap.val();

  // Safety: edit BUY/SELL/CASH perlu admin sebab akan adjust balance
  if(!me.isAdmin && (t.kind==="buy" || t.kind==="sell" || t.kind==="cash")){
    toast("Edit BUY/SELL/CASH hanya admin boleh.");
    return;
  }

  ctxVaultId = vaultId;
  ctxEdit = { vaultId, bucket, txId, oldTx: t };

  // Open modal ikut jenis
  if(t.kind==="cash"){
    $("cashVaultTitle").textContent = `Edit Cash ‚Ä¢ Vault: ${vaultId}`;
    $("cashType").value = (t.direction==="in") ? "cash_in" : "cash_out";
    $("cashAmount").value = String(t.amount ?? t.total ?? "");
    $("cashNote").value = String(t.note||"");
    openModal("mCash");
  }

  if(t.kind==="buy"){
    $("buyVaultTitle").textContent = `Edit Buy ‚Ä¢ Vault: ${vaultId}`;
    $("buyCat").value = t.category || "baby_pig";
    $("buyQty").value = String(t.qty ?? "");
    $("buyPrice").value = String(t.price ?? "");
    $("buyTotal").value = String(t.total ?? "");
    $("buyNote").value = String(t.note||"");
    $("buyBalanceHint").textContent = `Current balance: ${fmt(currentBalance)}`;
    openModal("mBuy");
    calcBuy();
  }

  if(t.kind==="missing"){
    $("missingVaultTitle").textContent = `Edit Missing ‚Ä¢ Vault: ${vaultId}`;
    $("missQty").value = String(t.qty ?? "");
    $("missPrice").value = String(t.price ?? "");
    $("missTotal").value = String(t.total ?? "");
    $("missNote").value = String(t.note||"");
    openModal("mMissing");
    calcMissing();
  }

  if(t.kind==="sell"){
    $("sellVaultTitle").textContent = `Edit Sell ‚Ä¢ Vault: ${vaultId}`;

    // update context available (biar limit ekor masih ikut summary)
    const vSnap = await get(ref(db, `vaults/open/${vaultId}`));
    const s = (vSnap.exists() ? (vSnap.val().summary || {}) : {});
    const babyQty = Number(s.babyPig?.qty || 0);
    const missQty = Number(s.missing?.qty || 0);
    ctxMissingPig = missQty;
    ctxAvailablePig = Math.max(0, babyQty - missQty);

    $("sellMissing").value = String(ctxMissingPig);
    $("sellEkorHint").textContent = `Tersedia untuk jual: ${ctxAvailablePig} ekor`;

    $("sellPriceKg").value = String(t.priceKg ?? "");
    $("sellKg").value = String(t.kg ?? "");
    $("sellEkor").value = String(t.ekor ?? "");
    $("sellTotal").value = String(t.total ?? "");
    $("sellNote").value = String(t.note||"");

    $("sellEkor").style.borderColor = "rgba(255,255,255,.12)";
    openModal("mSell");
    calcSell();
    validateSellEkor();
  }

  return;
}
  if(act==="txView"){
  const note = decodeURIComponent(btn.dataset.note || "");
  openViewNote(note);
  return;
}
    if(act==="txDel"){
      const vaultId = btn.dataset.v;
      const bucket  = btn.dataset.b;
      const txId    = btn.dataset.t;

      // history delete only admin (UI already hides, but double guard)
      if(bucket==="history" && !me.isAdmin){
        toast("Limited user: tiada akses delete history.");
        return;
      }

      if(!confirm("Delete transaction?")) return;

      try{
        await remove(ref(db, `vaults/${bucket}/${vaultId}/transactions/${txId}`));
        await recomputeVaultSummary(vaultId, bucket);
        toast("Deleted.");
      }catch(e){
        console.error(e);
        toast(e?.message || "Failed");
      }
    }

    if(act==="histEdit"){
      if(!me.isAdmin){ toast("No access."); return; }
      const newTitle = prompt("New title?");
      if(!newTitle) return;
      try{
        await update(ref(db, `vaults/history/${vid}`), { title: newTitle.trim(), updatedAt: serverTimestamp(), updatedAtMs: Date.now() });
        toast("Updated title.");
      }catch(e){
        console.error(e);
        toast(e?.message || "Failed");
      }
    }
if(act==="vaultDel"){
  const bucket = btn.dataset.b || "open";

  // kalau history, admin sahaja boleh
  if(bucket==="history" && !me.isAdmin){
    toast("Admin sahaja boleh delete vault history.");
    return;
  }

  const msg = bucket==="history"
    ? "Delete vault HISTORY ini? Semua data akan hilang (tak boleh undo)."
    : "Delete vault ini? Semua transaksi dalam vault akan hilang.";

  if(!confirm(msg)) return;

  try{
    await remove(ref(db, `vaults/${bucket}/${vid}`));
    toast("Vault deleted.");
  }catch(e){
    console.error(e);
    toast("Failed delete vault.");
  }
}
if(act==="vaultUnclose"){
  if(!me.isAdmin){
    toast("Admin sahaja boleh Unclosing.");
    return;
  }
  if(!confirm("Unclosing vault ini? Vault akan balik ke Open Vault.")) return;

  try{
    await uncloseVault(vid);
    toast("Vault moved back to Open Vault.");
    setView("open"); // optional: auto pindah tab open
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed unclosing.");
  }
}
  });

 // =====================
// CASH SAVE (CREATE + EDIT)
// =====================
$("cashSave").addEventListener("click", async ()=>{
  const type = $("cashType").value;
  const amount = Number($("cashAmount").value||0);
  const note = $("cashNote").value.trim();
  if(amount<=0){ toast("Amount mesti > 0"); return; }

  const direction = (type==="cash_in") ? "in" : "out";
  const delta = (direction==="in") ? amount : -amount;

  const newTx = { kind:"cash", direction, amount, total: amount, note };

  try{
    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      const old = ctxEdit.oldTx;

      const oldEff = txBalanceEffect(old);
      const newEff = txBalanceEffect(newTx);
      const diff = newEff - oldEff;

      // adjust balance hanya beza
      if(diff !== 0){
        await changeBalance(diff, {
          kind:"tx_edit_adjust",
          txKind:"cash",
          vaultId: ctxEdit.vaultId,
          txId: ctxEdit.txId,
          note:"Edit cash"
        });
      }

      // update tx data
      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });

      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);

      ctxEdit = null;
      closeModal("mCash");
      toast("Cash updated.");
      return;
    }

    // ===== CREATE MODE =====
    await changeBalance(delta, { kind:"cash_transfer", direction, amount, note, vaultId: ctxVaultId });
    await addTx(ctxVaultId, newTx);

    closeModal("mCash");
    toast("Cash transfer saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed (maybe limited user no access).");
  }
});


// =====================
// BUY AUTO CALC
// =====================
function calcBuy(){
  const qty = Number($("buyQty").value||0);
  const price = Number($("buyPrice").value||0);
  const totalManual = Number($("buyTotal").value||0);

  const auto = qty>0 && price>0 ? qty*price : 0;
  const total = ($("buyTotal").value.trim()==="") ? auto : totalManual;

  const enough = total <= currentBalance;
  $("buyTotal").style.borderColor = enough ? "rgba(255,255,255,.12)" : "rgba(239,68,68,.65)";
  $("buyBalanceHint").textContent = enough
    ? `Balance OK. After buy: ${fmt(currentBalance - total)}`
    : `Balance tak cukup. Need: ${fmt(total)} (Balance: ${fmt(currentBalance)})`;
}
["buyQty","buyPrice","buyTotal"].forEach(id=> $(id).addEventListener("input", calcBuy));


// =====================
// BUY SAVE (CREATE + EDIT)
// =====================
$("buySave").addEventListener("click", async ()=>{
  const category = $("buyCat").value;
  const qty = Number($("buyQty").value||0);
  const price = Number($("buyPrice").value||0);
  const total = Number($("buyTotal").value||0) || (qty*price);
  const note = $("buyNote").value.trim();

  if(total<=0){ toast("Total mesti > 0"); return; }

  // kalau EDIT, jangan check balance pakai currentBalance bulat-bulat,
  // sebab diff boleh kecil. Tapi kita masih boleh guard simple:
  // jika tambah cost (diff negatif), pastikan cukup.
  try{
    const newTx = { kind:"buy", category, qty, price, total, note };

    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      const old = ctxEdit.oldTx;

      const oldEff = txBalanceEffect(old);
      const newEff = txBalanceEffect(newTx);
      const diff = newEff - oldEff; // buy negatif

      // kalau diff negatif (lebih banyak cost), pastikan cukup balance
      if(diff < 0 && Math.abs(diff) > currentBalance){
        toast("Balance tak cukup untuk edit buy (tambahan cost).");
        return;
      }

      if(diff !== 0){
        await changeBalance(diff, {
          kind:"tx_edit_adjust",
          txKind:"buy",
          vaultId: ctxEdit.vaultId,
          txId: ctxEdit.txId,
          note:"Edit buy"
        });
      }

      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });

      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);

      ctxEdit = null;
      closeModal("mBuy");
      toast("Buy updated.");
      return;
    }

    // ===== CREATE MODE =====
    if(total > currentBalance){
      toast("Modal tak cukup untuk buy.");
      return;
    }

    await changeBalance(-total, { kind:"buy", category, qty, price, total, note, vaultId: ctxVaultId });
    await addTx(ctxVaultId, newTx);

    closeModal("mBuy");
    toast("Buy saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed (maybe limited user no access).");
  }
});


// =====================
// MISSING AUTO CALC
// =====================
function calcMissing(){
  const q = Number($("missQty").value||0);
  const p = Number($("missPrice").value||0);
  const t = q*p;
  $("missTotal").value = t ? t.toFixed(2) : "";
}
["missQty","missPrice"].forEach(id=> $(id).addEventListener("input", calcMissing));


// =====================
// MISSING SAVE (CREATE + EDIT)
// =====================
$("missSave").addEventListener("click", async ()=>{
  const qty = Number($("missQty").value||0);
  const price = Number($("missPrice").value||0);
  const total = qty * price;
  const note = $("missNote").value.trim();

  if(qty<=0 || price<=0){ toast("Missing & harga mesti > 0"); return; }

  try{
    const newTx = { kind:"missing", qty, price, total, note };

    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });

      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);

      ctxEdit = null;
      closeModal("mMissing");
      toast("Missing updated.");
      return;
    }

    // ===== CREATE MODE =====
    await addTx(ctxVaultId, newTx);
    closeModal("mMissing");
    toast("Missing saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed");
  }
});


// =====================
// SELL AUTO CALC
// =====================
function calcSell(){
  const priceKg = Number($("sellPriceKg").value||0);
  const kg = Number($("sellKg").value||0);
  const total = priceKg * kg;
  $("sellTotal").value = total ? total.toFixed(2) : "";
}
["sellPriceKg","sellKg"].forEach(id=> $(id).addEventListener("input", calcSell));


// =====================
// SELL SAVE (CREATE + EDIT)
// =====================
$("sellSave").addEventListener("click", async ()=>{
  const priceKg = Number($("sellPriceKg").value||0);
  const kg = Number($("sellKg").value||0);
  const ekor = Number($("sellEkor").value||0);
  const total = Number($("sellTotal").value||0) || (priceKg*kg);
  const note = $("sellNote").value.trim();

  if(total<=0 || kg<=0){ toast("Price/Kg dan Kg mesti isi."); return; }
  if(ekor > ctxAvailablePig){
    toast(`Total ekor tak boleh lebih dari tersedia (${ctxAvailablePig}).`);
    $("sellEkor").focus();
    return;
  }

  try{
    const newTx = { kind:"sell", priceKg, kg, ekor, total, note };

    // ===== EDIT MODE =====
    if(ctxEdit && ctxEdit.txId){
      const old = ctxEdit.oldTx;

      const oldEff = txBalanceEffect(old);
      const newEff = txBalanceEffect(newTx);
      const diff = newEff - oldEff; // sell positif

      // kalau edit mengurangkan revenue (diff negatif), pastikan balance cukup untuk tolak balik
      if(diff < 0 && Math.abs(diff) > currentBalance){
        toast("Balance tak cukup untuk edit sell (kena tolak balik).");
        return;
      }

      if(diff !== 0){
        await changeBalance(diff, {
          kind:"tx_edit_adjust",
          txKind:"sell",
          vaultId: ctxEdit.vaultId,
          txId: ctxEdit.txId,
          note:"Edit sell"
        });
      }

      await update(ref(db, `vaults/${ctxEdit.bucket}/${ctxEdit.vaultId}/transactions/${ctxEdit.txId}`), {
        ...newTx,
        editedAt: serverTimestamp(),
        editedAtMs: Date.now(),
        editedByUid: me.uid,
        editedBy: me.username
      });

      await recomputeVaultSummary(ctxEdit.vaultId, ctxEdit.bucket);

      ctxEdit = null;
      closeModal("mSell");
      toast("Sell updated.");
      return;
    }

    // ===== CREATE MODE =====
    await changeBalance(+total, { kind:"sell", priceKg, kg, ekor, total, note, vaultId: ctxVaultId });
    await addTx(ctxVaultId, newTx);

    closeModal("mSell");
    toast("Sell saved.");
  }catch(e){
    console.error(e);
    toast(e?.message || "Failed (maybe limited user no access).");
  }
});


// =====================
// VALIDATE EKOR INPUT
// =====================
function validateSellEkor(){
  const ekor = Number($("sellEkor").value||0);
  const ok = ekor <= ctxAvailablePig;

  $("sellEkor").style.borderColor = ok ? "rgba(255,255,255,.12)" : "rgba(239,68,68,.85)";
  $("sellEkorHint").textContent = ok
    ? `Tersedia untuk jual: ${ctxAvailablePig} ekor`
    : `Maksimum boleh jual: ${ctxAvailablePig} ekor (kau isi ${ekor})`;

  return ok;
}
$("sellEkor").addEventListener("input", validateSellEkor);

  // ===== AUTH BOOT =====
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      location.replace("../login/");
      return;
    }
    me.uid = user.uid;

    // load profile username
    const p = await get(ref(db, `profiles/${me.uid}`));
    me.username = p.exists() ? (p.val().username || "user") : "user";
    $("usernameText").textContent = me.username;

    await loadRole(me.uid);

    // balance
    wireBalanceListener();

    // vault listeners
    wireVaultListeners();

    // default view
    setView("open");

    toast("Ready.");
  });
</script>
</body>
</html>
