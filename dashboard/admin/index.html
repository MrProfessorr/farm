<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Farm Admin (RTDB)</title>
<link rel="preconnect" href="https://www.gstatic.com">
<link rel="preconnect" href="https://identitytoolkit.googleapis.com">
<link rel="preconnect" href="https://firebasedatabase.app">
<link rel="dns-prefetch" href="https://www.gstatic.com">
<link rel="dns-prefetch" href="https://identitytoolkit.googleapis.com">
<link rel="dns-prefetch" href="https://firebasedatabase.app">
<style>
:root{
  --btn:#1668dc; --btnH:#3c89e8; --btnA:#1554ad;
  --bg:#070a16; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.10);
  --txt:#eaf2ff; --muted:rgba(234,242,255,.7);
  --good:#27d17f; --bad:#ff4d4d; --warn:#ffcc55;
  --shadow:0 18px 60px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--txt);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(22,104,220,.25), transparent 60%),
    radial-gradient(900px 600px at 80% 30%, rgba(60,137,232,.18), transparent 60%),
    linear-gradient(180deg, var(--bg), #000 70%, #0b1220);
  min-height:100vh;
}
header{
  height:64px; position:sticky; top:0; z-index:9999;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 16px; background:rgba(0,0,0,.55);
  border-bottom:1px solid var(--stroke);
  backdrop-filter: blur(10px);
}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.dot{width:10px;height:10px;border-radius:50%;background:var(--btn);box-shadow:0 0 0 4px rgba(22,104,220,.18)}
.hdrRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.btn{
  appearance:none;border:none;cursor:pointer;
  background:var(--btn);color:#fff;font-weight:800;
  padding:10px 12px;border-radius:12px;
  transition:.15s transform,.15s background;
  display:inline-flex;align-items:center;gap:8px
}
.btn:hover{background:var(--btnH)}
.btn:active{background:var(--btnA);transform:translateY(1px)}
.btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--txt)}
.btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
.btn.danger{background:rgba(255,77,77,.18);border:1px solid rgba(255,77,77,.35);color:var(--txt)}
.btn.warn{background:rgba(255,204,85,.16);border:1px solid rgba(255,204,85,.35);color:var(--txt)}
.btn.warn:hover{background:rgba(255,204,85,.26)}

.wrap{max-width:1200px;margin:0 auto;padding:16px}
.topBar{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:14px 0 10px}
.subInfo{color:var(--muted);font-size:12px;line-height:1.4}
.actionRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

.grid{display:grid;gap:12px}
.vault{
  background:var(--card);border:1px solid var(--stroke);
  border-radius:18px;box-shadow:var(--shadow);
  overflow:hidden;
}
.vaultHead{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px;border-bottom:1px solid var(--stroke);
  background:rgba(255,255,255,.03);gap:10px;flex-wrap:wrap
}
.vaultTitle{font-weight:900}
.meta{font-size:12px;color:var(--muted)}
.vaultBtns{display:flex;gap:8px;flex-wrap:wrap}
.vaultBody{padding:12px}

.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.04);
  font-size:12px;
}
.pill.good{border-color:rgba(39,209,127,.35)}
.pill.bad{border-color:rgba(255,77,77,.35)}
.pill.warn{border-color:rgba(255,204,85,.35)}
.neg{color:var(--bad);font-weight:900}
.pos{color:var(--good);font-weight:900}

.two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:760px){.two{grid-template-columns:1fr}}

table{
  width:100%;border-collapse:separate;border-spacing:0;
  border:1px solid var(--stroke);border-radius:14px;
  background:rgba(0,0,0,.25);overflow:hidden
}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;vertical-align:top}
th{background:rgba(255,255,255,.04);text-align:left;font-size:12px;letter-spacing:.3px}
tr:last-child td{border-bottom:none}
.right{text-align:right}

/* modal */
.mask{position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;padding:18px}
.mask.show{display:flex}
.modal{width:min(680px,100%);background:rgba(10,14,26,.92);border:1px solid var(--stroke);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
.mHead{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--stroke);background:rgba(255,255,255,.03)}
.mBody{padding:12px}
.mFoot{display:flex;justify-content:flex-end;gap:10px;padding:12px;border-top:1px solid var(--stroke);background:rgba(255,255,255,.02)}
.x{width:36px;height:36px;border-radius:12px;background:transparent;border:1px solid var(--stroke);color:var(--txt);cursor:pointer}
.x:hover{border-color:rgba(60,137,232,.55)}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--txt);outline:none}
input:focus,select:focus{border-color:rgba(60,137,232,.7);box-shadow:0 0 0 3px rgba(60,137,232,.18)}

.toast{position:fixed;left:16px;right:16px;bottom:16px;max-width:720px;margin:auto;padding:12px 14px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.6);display:none}
.toast.show{display:block}
.toast.good{border-color:rgba(39,209,127,.35)} .toast.bad{border-color:rgba(255,77,77,.35)}
</style>
</head>
<body>

<header>
  <div class="brand">
    <span class="dot"></span>
    <div>
      <div style="font-size:14px">FARM VAULT</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px" id="roleLine">Loading‚Ä¶</div>
    </div>
  </div>

  <div class="hdrRight">
    <button class="btn ghost" id="btnWallet">üí∞ Wallet</button>
    <button class="btn" id="btnUser">üë§ ‚Ä¶</button>
    <button class="btn danger small" id="btnLogout">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="topBar">
    <div class="subInfo">
      Vault terbaru akan muncul paling atas. Semua data simpan dalam RTDB.
    </div>

    <div class="actionRow">
      <button class="btn" id="btnAddPoint">‚ûï Add Point</button>
      <button class="btn" id="btnNewVault">üóÇÔ∏è Open New Vault</button>
      <a class="btn ghost" href="../history/" style="text-decoration:none">üìú History</a>
    </div>
  </div>

  <div class="grid" id="vaultList"></div>
</div>

<div class="toast" id="toast"></div>

<div class="mask" id="mask">
  <div class="modal">
    <div class="mHead">
      <div style="font-weight:900" id="mTitle">Modal</div>
      <button class="x" id="mx">‚úï</button>
    </div>
    <div class="mBody" id="mBody"></div>
    <div class="mFoot" id="mFoot"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getDatabase, ref, set, get, update, push, remove, onValue,
    runTransaction, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // ====== TUKAR CONFIG INI ======
const firebaseConfig = {
  apiKey: "AIzaSyCXGxdJOEbcotIXRWyDGHNNCbcmFev-qZY",
  authDomain: "farm-a9071.firebaseapp.com",
  databaseURL: "https://farm-a9071-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "farm-a9071",
  storageBucket: "farm-a9071.firebasestorage.app",
  messagingSenderId: "979250293394",
  appId: "1:979250293394:web:af419dd2b325017a41944b"
};
  // =============================

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const $ = (id)=>document.getElementById(id);
  const money = (n)=> (Number(n||0)).toLocaleString("en-MY",{minimumFractionDigits:2,maximumFractionDigits:2});
  const nowStr = (d=new Date())=>{
    const p=x=>String(x).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  };
  const toast=(msg, ok=true)=>{
    const t=$("toast");
    t.className="toast show "+(ok?"good":"bad");
    t.textContent=msg;
    clearTimeout(toast._tm);
    toast._tm=setTimeout(()=>t.className="toast",2600);
  };
  const esc=(s)=>String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

  // modal helpers
  const mask=$("mask");
  const openM=(title, bodyHtml, footHtml)=>{
    $("mTitle").textContent=title;
    $("mBody").innerHTML=bodyHtml;
    $("mFoot").innerHTML=footHtml||"";
    mask.classList.add("show");
  };
  const closeM=()=>mask.classList.remove("show");
  $("mx").onclick=closeM;
  mask.addEventListener("click",(e)=>{ if(e.target.id==="mask") closeM(); });

  // state
  let me=null;
  let isAdmin=false;
  let walletBalance=0;
  let vaultsCache={}; // vaultId -> vaultData
  let itemsUnsub={};  // vaultId -> flag

  const baseUser=(uid)=>`users/${uid}`;
  const r = (path)=>ref(db, path);

  async function readAdminFlag(uid){
    const snap = await get(r(`admins/${uid}`));
    return snap.exists() && snap.val() === true;
  }

  async function ensureProfile(uid, username){
    await update(r(`${baseUser(uid)}/profile`), {
      username,
      lastLoginText: nowStr(),
      lastLoginAt: Date.now()
    });
    // init wallet if missing
    const ws = await get(r(`${baseUser(uid)}/wallet/balance`));
    if(!ws.exists()){
      await set(r(`${baseUser(uid)}/wallet/balance`), 0);
    }
  }

  function setHeader(){
    $("btnUser").textContent = "üë§ " + (me?.username||"User");
    $("roleLine").textContent = isAdmin ? "Role: ADMIN (full access)" : "Role: STAFF (limited)";
    $("btnAddPoint").style.display = isAdmin ? "" : "none";
  }

  // realtime wallet
  function listenWallet(uid){
    onValue(r(`${baseUser(uid)}/wallet/balance`), (snap)=>{
      walletBalance = Number(snap.val()||0);
    });
  }

  function walletModal(){
    openM("My Wallet (Modal Uang)", `
      <div class="two">
        <div>
          <div class="pill warn" style="justify-content:space-between;width:100%">
            <span>Current Balance</span>
            <b>RM ${money(walletBalance)}</b>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.4">
            Wallet berubah bila Buy/Sell/Cash Transfer (dan Add Point untuk admin).
          </div>
        </div>
        <div>
          <div class="pill" style="justify-content:space-between;width:100%">
            <span>User UID</span>
            <b style="font-size:12px">${me?.uid||"-"}</b>
          </div>
          <div class="pill" style="justify-content:space-between;width:100%;margin-top:10px">
            <span>Username</span>
            <b style="font-size:12px">${me?.username||"-"}</b>
          </div>
        </div>
      </div>
    `, `<button class="btn ghost" id="wClose">Close</button>`);
    document.getElementById("wClose").onclick = closeM;
  }

  // ===== transactions on wallet =====
  async function walletAdd(amount){
    const balRef = r(`${baseUser(me.uid)}/wallet/balance`);
    const res = await runTransaction(balRef, (cur)=> (Number(cur||0) + Number(amount||0)));
    return Number(res.snapshot.val()||0);
  }
  async function walletSub(amount){
    const balRef = r(`${baseUser(me.uid)}/wallet/balance`);
    const amt = Number(amount||0);
    const res = await runTransaction(balRef, (cur)=>{
      const c = Number(cur||0);
      // prevent negative
      if(c - amt < 0) return; // abort
      return c - amt;
    });
    if(!res.committed) throw new Error("Wallet tidak cukup.");
    return Number(res.snapshot.val()||0);
  }

  // ===== Add Point (admin only) =====
  function addPointModal(){
    if(!isAdmin) return toast("Staff tak boleh guna Add Point.", false);

    openM("Add Point", `
      <label>Type</label>
      <select id="apType">
        <option value="in">IN (Tambah modal)</option>
        <option value="out">OUT (Tolak modal)</option>
      </select>
      <label>Amount (RM)</label>
      <input id="apAmt" type="number" inputmode="decimal" placeholder="contoh: 100000">
      <label>Note (optional)</label>
      <input id="apNote" placeholder="contoh: modal awal">
    `, `
      <button class="btn ghost" id="apCancel">Cancel</button>
      <button class="btn" id="apSave">Save</button>
    `);

    $("apCancel").onclick = closeM;
    $("apSave").onclick = async ()=>{
      const type = $("apType").value;
      const amt = Number($("apAmt").value||0);
      const note = ($("apNote").value||"").trim();
      if(amt<=0) return toast("Amount mesti > 0", false);

      try{
        const before = walletBalance;
        const after = type==="in" ? await walletAdd(amt) : await walletSub(amt);

        // log (admin-only path)
        const logRef = push(r(`${baseUser(me.uid)}/walletLogs`));
        await set(logRef, {
          kind:"add_point",
          type, amount:amt,
          before, after,
          note,
          createdAt: Date.now(),
          createdText: nowStr()
        });

        closeM();
        toast(`Wallet updated: RM ${money(before)} ‚Üí RM ${money(after)}`, true);
      }catch(err){
        toast(err?.message||String(err), false);
      }
    };
  }

  // ===== Create vault =====
  function newVaultModal(){
    openM("Open New Vault", `
      <label>Title</label>
      <input id="vTitle" placeholder="contoh: Feb 2026 / Vault 1">
      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        Vault terbaru akan di atas.
      </div>
    `, `
      <button class="btn ghost" id="vCancel">Cancel</button>
      <button class="btn" id="vCreate">Create</button>
    `);

    $("vCancel").onclick=closeM;
    $("vCreate").onclick=async ()=>{
      const title=($("vTitle").value||"").trim();
      if(!title) return toast("Title tak boleh kosong.", false);

      const vRef = push(r(`${baseUser(me.uid)}/vaults`));
      const id = vRef.key;

      await set(vRef, {
        id,
        title,
        status:"open",
        createdAt: Date.now(),
        createdText: nowStr(),
        updatedAt: Date.now(),
        updatedText: nowStr(),
        buyTotal: 0,
        sellTotal: 0,
        sellKg: 0,
        sellHead: 0
      });

      closeM();
      toast("Vault created.", true);
    };
  }

  // ===== Cash transfer =====
  function cashTransferModal(vaultId){
    openM("Cash Transfer", `
      <label>Type</label>
      <select id="ctType">
        <option value="in">CASH IN (Masuk duit)</option>
        <option value="out">CASH OUT (Keluar duit)</option>
      </select>
      <label>Amount (RM)</label>
      <input id="ctAmt" type="number" inputmode="decimal" placeholder="contoh: 1000">
      <label>Note (optional)</label>
      <input id="ctNote" placeholder="contoh: bayar pekerja">
    `, `
      <button class="btn ghost" id="ctCancel">Cancel</button>
      <button class="btn" id="ctSave">Save</button>
    `);

    $("ctCancel").onclick=closeM;
    $("ctSave").onclick=async ()=>{
      const type=$("ctType").value;
      const amt=Number($("ctAmt").value||0);
      const note=($("ctNote").value||"").trim();
      if(amt<=0) return toast("Amount mesti > 0", false);

      try{
        const before=walletBalance;
        const after = type==="in" ? await walletAdd(amt) : await walletSub(amt);

        const logRef = push(r(`${baseUser(me.uid)}/cashLogs`));
        await set(logRef, {
          vaultId,
          type, amount:amt, note,
          before, after,
          createdAt: Date.now(),
          createdText: nowStr()
        });

        closeM();
        toast(`Cash ${type.toUpperCase()} saved. Wallet: RM ${money(after)}`, true);
      }catch(err){
        toast(err?.message||String(err), false);
      }
    };
  }

  // ===== Buy =====
  function buyModal(vaultId){
    openM("Buy (Pembelian)", `
      <label>Category</label>
      <select id="bCat">
        <option value="baby">Bayi Babi</option>
        <option value="feed">Pakan Babi</option>
        <option value="other">Other</option>
      </select>

      <div class="two">
        <div>
          <label>Qty (ekor / unit)</label>
          <input id="bQty" type="number" inputmode="numeric" placeholder="contoh: 10">
        </div>
        <div>
          <label>Price per unit (RM)</label>
          <input id="bPrice" type="number" inputmode="decimal" placeholder="contoh: 350">
        </div>
      </div>

      <label>Total (RM)</label>
      <input id="bTotal" readonly placeholder="auto kira">

      <label>Note (optional)</label>
      <input id="bNote" placeholder="contoh: supplier A">

      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        Kalau wallet tak cukup, total akan jadi <b style="color:var(--bad)">merah</b>.
      </div>
    `, `
      <button class="btn ghost" id="bCancel">Cancel</button>
      <button class="btn" id="bSave">Save</button>
    `);

    const calc=()=>{
      const qty=Number($("bQty").value||0);
      const price=Number($("bPrice").value||0);
      const total=qty*price;
      $("bTotal").value = total ? total.toFixed(2) : "";
      const ok = total<=walletBalance;
      $("bTotal").style.borderColor = ok ? "var(--stroke)" : "rgba(255,77,77,.75)";
      $("bTotal").style.boxShadow = ok ? "none" : "0 0 0 3px rgba(255,77,77,.18)";
    };
    $("bQty").oninput=calc; $("bPrice").oninput=calc;

    $("bCancel").onclick=closeM;
    $("bSave").onclick=async ()=>{
      const cat=$("bCat").value;
      const qty=Number($("bQty").value||0);
      const price=Number($("bPrice").value||0);
      const total=Number($("bTotal").value||0);
      const note=($("bNote").value||"").trim();
      if(qty<=0||price<=0) return toast("Qty & price mesti > 0", false);
      if(total<=0) return toast("Total invalid.", false);
      if(total>walletBalance) return toast("Wallet tak cukup.", false);

      try{
        const before=walletBalance;
        const after=await walletSub(total);

        // save item
        const itemRef = push(r(`${baseUser(me.uid)}/vaultItems/${vaultId}`));
        await set(itemRef, {
          type:"buy",
          cat, qty, price, total, note,
          createdAt: Date.now(),
          createdText: nowStr()
        });

        // update vault summary
        await runTransaction(r(`${baseUser(me.uid)}/vaults/${vaultId}/buyTotal`), (cur)=> Number(cur||0)+total);
        await update(r(`${baseUser(me.uid)}/vaults/${vaultId}`), { updatedAt: Date.now(), updatedText: nowStr() });

        closeM();
        toast(`Buy saved. Wallet: RM ${money(after)}`, true);
      }catch(err){
        toast(err?.message||String(err), false);
      }
    };
  }

  // ===== Sell =====
  function sellModal(vaultId){
    openM("Sell (Jual)", `
      <div class="two">
        <div>
          <label>Price per Kg (RM)</label>
          <input id="sPriceKg" type="number" inputmode="decimal" placeholder="contoh: 12.50">
        </div>
        <div>
          <label>Total Kg</label>
          <input id="sKg" type="number" inputmode="decimal" placeholder="contoh: 300">
        </div>
      </div>

      <div class="two">
        <div>
          <label>Total Ekor</label>
          <input id="sHead" type="number" inputmode="numeric" placeholder="contoh: 20">
        </div>
        <div>
          <label>Total Hasil (RM)</label>
          <input id="sTotal" readonly placeholder="auto kira">
        </div>
      </div>

      <label>Note (optional)</label>
      <input id="sNote" placeholder="contoh: pasar / customer">
    `, `
      <button class="btn ghost" id="sCancel">Cancel</button>
      <button class="btn" id="sSave">Save</button>
    `);

    const calc=()=>{
      const p=Number($("sPriceKg").value||0);
      const kg=Number($("sKg").value||0);
      const total=p*kg;
      $("sTotal").value = total ? total.toFixed(2) : "";
    };
    $("sPriceKg").oninput=calc; $("sKg").oninput=calc;

    $("sCancel").onclick=closeM;
    $("sSave").onclick=async ()=>{
      const priceKg=Number($("sPriceKg").value||0);
      const kg=Number($("sKg").value||0);
      const head=Number($("sHead").value||0);
      const total=Number($("sTotal").value||0);
      const note=($("sNote").value||"").trim();
      if(priceKg<=0||kg<=0) return toast("Price/kg & kg mesti > 0", false);
      if(total<=0) return toast("Total invalid.", false);

      try{
        const before=walletBalance;
        const after=await walletAdd(total);

        const itemRef = push(r(`${baseUser(me.uid)}/vaultItems/${vaultId}`));
        await set(itemRef, {
          type:"sell",
          priceKg, kg, head, total, note,
          createdAt: Date.now(),
          createdText: nowStr()
        });

        await runTransaction(r(`${baseUser(me.uid)}/vaults/${vaultId}/sellTotal`), (cur)=> Number(cur||0)+total);
        await runTransaction(r(`${baseUser(me.uid)}/vaults/${vaultId}/sellKg`), (cur)=> Number(cur||0)+kg);
        await runTransaction(r(`${baseUser(me.uid)}/vaults/${vaultId}/sellHead`), (cur)=> Number(cur||0)+head);
        await update(r(`${baseUser(me.uid)}/vaults/${vaultId}`), { updatedAt: Date.now(), updatedText: nowStr() });

        closeM();
        toast(`Sell saved. Wallet: RM ${money(after)}`, true);
      }catch(err){
        toast(err?.message||String(err), false);
      }
    };
  }

  // ===== Closing (move to history + move items) =====
  async function closeVault(vaultId){
    const vSnap = await get(r(`${baseUser(me.uid)}/vaults/${vaultId}`));
    if(!vSnap.exists()) return toast("Vault not found.", false);

    const vault = vSnap.val();

    // read items once
    const itemsSnap = await get(r(`${baseUser(me.uid)}/vaultItems/${vaultId}`));
    const items = itemsSnap.exists() ? itemsSnap.val() : {};

    const closedText = nowStr();
    const updatesObj = {};

    // write history summary
    updatesObj[`${baseUser(me.uid)}/history/${vaultId}`] = {
      ...vault,
      status:"closed",
      closedAt: Date.now(),
      closedText
    };

    // move items to historyItems
    updatesObj[`${baseUser(me.uid)}/historyItems/${vaultId}`] = items;

    // remove open vault + open items
    updatesObj[`${baseUser(me.uid)}/vaults/${vaultId}`] = null;
    updatesObj[`${baseUser(me.uid)}/vaultItems/${vaultId}`] = null;

    await update(r("/"), updatesObj);
    toast("Vault closed & moved to history.", true);
  }

  // ===== Render =====
  function vaultCard(v){
    const id=v.id;
    const d=v;

    const profit = Number(d.sellTotal||0) - Number(d.buyTotal||0);
    const salesPositive = profit>=0 ? profit : Math.abs(profit);

    return `
      <div class="vault">
        <div class="vaultHead">
          <div>
            <div class="vaultTitle">${esc(d.title||"Untitled")}</div>
            <div class="meta">Created: ${esc(d.createdText||"-")} ‚Ä¢ Updated: ${esc(d.updatedText||"-")}</div>
          </div>
          <div class="vaultBtns">
            <button class="btn small ghost" data-act="cash" data-id="${id}">Cash Transfer</button>
            <button class="btn small ghost" data-act="buy" data-id="${id}">Buy</button>
            <button class="btn small ghost" data-act="sell" data-id="${id}">Sell</button>
            <button class="btn small warn" data-act="close" data-id="${id}">Closing</button>
          </div>
        </div>

        <div class="vaultBody">
          <div class="two" style="margin-bottom:10px">
            <div class="pill" style="justify-content:space-between;width:100%">
              <span>Buy Total</span><b>RM ${money(d.buyTotal||0)}</b>
            </div>
            <div class="pill" style="justify-content:space-between;width:100%">
              <span>Sell Total</span><b>RM ${money(d.sellTotal||0)}</b>
            </div>
          </div>

          <div class="two" style="margin-bottom:10px">
            <div class="pill" style="justify-content:space-between;width:100%">
              <span>Total Kg Sold</span><b>${Number(d.sellKg||0).toFixed(2)}</b>
            </div>
            <div class="pill" style="justify-content:space-between;width:100%">
              <span>Total Ekor Sold</span><b>${Number(d.sellHead||0).toFixed(0)}</b>
            </div>
          </div>

          <div class="two" style="margin-bottom:12px">
            <div class="pill ${profit<0?"bad":"good"}" style="justify-content:space-between;width:100%">
              <span>Profit (boleh negatif)</span>
              <b class="${profit<0?"neg":"pos"}">${profit<0?"-":""}RM ${money(Math.abs(profit))}</b>
            </div>
            <div class="pill ${profit<0?"bad":"good"}" style="justify-content:space-between;width:100%">
              <span>${profit<0?"Sales (Loss positive)":"Sales (Keuntungan)"}</span>
              <b class="${profit<0?"neg":"pos"}">RM ${money(salesPositive)}</b>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width:110px">Type</th>
                <th>Detail</th>
                <th style="width:160px" class="right">Amount (RM)</th>
                <th style="width:180px">Date/Time</th>
              </tr>
            </thead>
            <tbody id="rows-${id}">
              <tr><td colspan="4" style="color:var(--muted)">Loading items‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderItems(vaultId, itemsObj){
    const rows = document.getElementById(`rows-${vaultId}`);
    if(!rows) return;

    const arr = Object.entries(itemsObj||{}).map(([id,v])=>({id,...v}));
    arr.sort((a,b)=>Number(b.createdAt||0)-Number(a.createdAt||0));

    if(!arr.length){
      rows.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">No items yet.</td></tr>`;
      return;
    }

    const typePill = (t)=>{
      if(t==="buy") return `<span class="pill warn">BUY</span>`;
      if(t==="sell") return `<span class="pill good">SELL</span>`;
      return `<span class="pill">ITEM</span>`;
    };

    rows.innerHTML = arr.map(it=>{
      if(it.type==="buy"){
        const cat = it.cat==="baby"?"Bayi Babi":it.cat==="feed"?"Pakan Babi":"Other";
        const detail = `<b>${esc(cat)}</b> ‚Ä¢ qty: ${Number(it.qty||0)} ‚Ä¢ price: RM ${money(it.price||0)}${it.note?`<div style="color:var(--muted);font-size:12px;margin-top:4px">${esc(it.note)}</div>`:""}`;
        return `
          <tr>
            <td>${typePill("buy")}</td>
            <td>${detail}</td>
            <td class="right"><b>RM ${money(it.total||0)}</b></td>
            <td style="color:var(--muted)">${esc(it.createdText||"-")}</td>
          </tr>
        `;
      }else{
        const detail = `<b>Sell</b> ‚Ä¢ ${Number(it.kg||0).toFixed(2)} kg ‚Ä¢ ${Number(it.head||0).toFixed(0)} ekor ‚Ä¢ RM ${money(it.priceKg||0)}/kg${it.note?`<div style="color:var(--muted);font-size:12px;margin-top:4px">${esc(it.note)}</div>`:""}`;
        return `
          <tr>
            <td>${typePill("sell")}</td>
            <td>${detail}</td>
            <td class="right"><b>RM ${money(it.total||0)}</b></td>
            <td style="color:var(--muted)">${esc(it.createdText||"-")}</td>
          </tr>
        `;
      }
    }).join("");
  }

  function listenVaultItems(vaultId){
    if(itemsUnsub[vaultId]) return;
    itemsUnsub[vaultId]=true;

    onValue(r(`${baseUser(me.uid)}/vaultItems/${vaultId}`), (snap)=>{
      renderItems(vaultId, snap.val()||{});
    });
  }

  function listenVaults(uid){
    onValue(r(`${baseUser(uid)}/vaults`), (snap)=>{
      const obj = snap.val()||{};
      vaultsCache = obj;

      const arr = Object.values(obj);
      arr.sort((a,b)=>Number(b.createdAt||0)-Number(a.createdAt||0));

      const list=$("vaultList");
      if(!arr.length){
        list.innerHTML = `
          <div class="vault" style="padding:14px">
            <div class="pill warn" style="width:max-content">No vault yet</div>
            <div style="margin-top:10px;color:var(--muted)">Klik <b>Open New Vault</b> untuk create vault pertama.</div>
          </div>
        `;
        return;
      }

      list.innerHTML = arr.map(vaultCard).join("");
      arr.forEach(v=>listenVaultItems(v.id));
    });
  }

  // actions
  $("vaultList").addEventListener("click", (e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const act=b.dataset.act, id=b.dataset.id;

    if(act==="cash") return cashTransferModal(id);
    if(act==="buy") return buyModal(id);
    if(act==="sell") return sellModal(id);
    if(act==="close"){
      openM("Closing Vault", `
        <div style="color:var(--muted);line-height:1.5">
          Bila closing, vault akan dipindah ke History dan items akan dipindah juga.<br>
          Confirm closing vault ini?
        </div>
      `, `
        <button class="btn ghost" id="cNo">Cancel</button>
        <button class="btn warn" id="cYes">Yes, Closing</button>
      `);
      $("cNo").onclick=closeM;
      $("cYes").onclick=async ()=>{
        closeM();
        await closeVault(id);
      };
    }
  });

  // header buttons
  $("btnWallet").onclick = walletModal;
  $("btnAddPoint").onclick = addPointModal;
  $("btnNewVault").onclick = newVaultModal;
  $("btnLogout").onclick = async ()=>{ await signOut(auth); location.replace("../login/"); };

onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.replace("../login/"); return; }

  const email = user.email||"";
  const username = email.includes("@") ? email.split("@")[0] : (user.displayName||"user");

  me = { uid:user.uid, email, username };

  // ‚úÖ cepatkan UI dulu
  setHeader();
  listenWallet(me.uid);
  listenVaults(me.uid);

  // ‚úÖ parallel background
  const pAdmin   = readAdminFlag(me.uid);
  const pProfile = ensureProfile(me.uid, username);

  pAdmin.then((flag)=>{
    isAdmin = !!flag;
    setHeader(); // update roleLine + hide/show addpoint
  }).catch(()=>{});

  pProfile.catch(()=>{});
});
</script>
</body>
</html>
