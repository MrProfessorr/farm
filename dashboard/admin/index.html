<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Farm Vault Admin</title>
  <style>
    :root{
      --btn:#1668dc; --btnH:#3c89e8; --btnA:#1554ad;
      --bg:#070a16; --panel:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.12);
      --txt:#eaf0ff; --muted:rgba(234,240,255,.72);
      --ok:#20c997; --bad:#ff4d4d; --warn:#ffcc55;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt); background:
        radial-gradient(900px 600px at 20% 10%, rgba(22,104,220,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(60,137,232,.16), transparent 60%),
        linear-gradient(180deg, #050712, #000 60%, #070a16);
      min-height:100vh;
    }
    header{
      height:64px; position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 16px;
      background:rgba(0,0,0,.35);
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.6px}
    .dot{width:10px;height:10px;border-radius:99px;background:var(--btn);box-shadow:0 0 18px rgba(22,104,220,.65)}
    .rightHead{display:flex; align-items:center; gap:10px}
    .btn{
      height:40px; border:none; border-radius:12px; cursor:pointer;
      background:var(--btn); color:#fff; font-weight:800;
      padding:0 12px; display:inline-flex; align-items:center; gap:8px;
      transition:.15s transform,.15s background;
      user-select:none;
    }
    .btn:hover{background:var(--btnH); transform: translateY(-1px)}
    .btn:active{background:var(--btnA); transform: translateY(0)}
    .btn.ghost{background:transparent; border:1px solid var(--stroke); color:var(--txt)}
    .btn.ghost:hover{border-color:rgba(22,104,220,.65)}
    .btn.small{height:34px; border-radius:10px; padding:0 10px; font-size:13px}
    .btn.danger{background:#d94848}
    .btn.danger:hover{background:#ff5a5a}
    .btn.warn{background:#b8860b}
    .btn.warn:hover{background:#d1a62a}
    .chip{
      height:34px; display:inline-flex; align-items:center; gap:8px;
      padding:0 10px; border:1px solid var(--stroke); border-radius:999px;
      background:rgba(0,0,0,.25); color:var(--muted); font-size:13px;
    }
    .wrap{max-width:1180px; margin:14px auto; padding:0 14px}
    .topRow{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      flex-wrap:wrap;
    }
    .actionsRight{
      display:flex; flex-direction:column; gap:10px; align-items:flex-end;
    }
    .actionsRight .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .panel{
      border:1px solid var(--stroke);
      background:var(--panel);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .tabs{
      display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
    }
    .tab{
      height:34px; padding:0 12px; border-radius:999px;
      border:1px solid var(--stroke); background:transparent; color:var(--muted);
      cursor:pointer; font-weight:800;
    }
    .tab.active{background:rgba(22,104,220,.18); color:var(--txt); border-color:rgba(22,104,220,.5)}
    .content{padding:12px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
    .vault{
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      overflow:hidden;
    }
    .vaultHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-bottom:1px solid var(--stroke);
    }
    .vaultTitle{font-weight:900}
    .vaultMeta{font-size:12px; color:var(--muted); margin-top:2px}
    .vaultBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .excel{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
    }
    .excel thead th{
      position:sticky; top:64px; z-index:2;
      background:rgba(0,0,0,.55);
      border-bottom:1px solid var(--stroke);
      padding:10px 10px;
      text-align:left;
      color:var(--muted);
      backdrop-filter: blur(10px);
    }
    .excel tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:9px 10px;
      vertical-align:top;
    }
    .excel tbody tr:hover td{background:rgba(255,255,255,.03)}
    .num{text-align:right; font-variant-numeric: tabular-nums}
    .neg{color:var(--bad); font-weight:900}
    .pos{color:var(--ok); font-weight:900}
    .muted{color:var(--muted)}
    .footRow{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;
      padding:10px 12px; border-top:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .box{
      border:1px solid var(--stroke); background:rgba(0,0,0,.18);
      border-radius:12px; padding:8px 10px; min-width:170px;
    }
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .kpi .box .v{font-size:18px; font-weight:900; margin-top:2px}
    /* Modal */
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center; z-index:999;
      padding:16px;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(620px, 100%);
      border:1px solid var(--stroke);
      background:rgba(10,14,26,.92);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .mHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px; border-bottom:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
    }
    .mTitle{font-weight:900}
    .mClose{
      width:34px; height:34px; border-radius:10px; border:1px solid var(--stroke);
      background:transparent; color:var(--txt); cursor:pointer;
    }
    .mBody{padding:12px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select{
      width:100%; height:42px; border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      padding:0 10px;
      outline:none;
    }
    input:focus,select:focus{border-color:rgba(22,104,220,.7); box-shadow:0 0 0 3px rgba(22,104,220,.18)}
    .mFoot{
      display:flex; justify-content:flex-end; gap:10px; padding:12px;
      border-top:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
    }
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:640px){ .row2{grid-template-columns:1fr} }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.68); border:1px solid var(--stroke);
      padding:10px 12px; border-radius:12px; display:none; gap:10px; align-items:center;
      backdrop-filter: blur(10px); z-index:1000;
    }
    .toast.show{display:flex}
    .hide{display:none !important}
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> FARM VAULT <span class="muted" style="font-weight:800">ADMIN</span></div>

    <div class="rightHead">
      <button class="btn ghost" id="btnWallet">üí∞ Wallet</button>
      <button class="btn" id="btnUser">üë§ <span id="navUsername">Loading...</span></button>
    </div>
  </header>

  <div class="wrap">
    <div class="topRow">
      <div class="chip">
        <span>Balance:</span> <b id="balanceText">RM 0.00</b>
        <span class="muted" id="roleText" style="margin-left:8px"></span>
      </div>

      <div class="actionsRight">
        <div class="row">
          <button class="btn ghost" id="btnAddPoint">‚ûï Add Point</button>
          <button class="btn" id="btnNewVault">üìÅ Open New Vault</button>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="open">Open Vaults</button>
        <button class="tab" data-tab="history">History</button>
      </div>
      <div class="content">
        <div id="tabOpen"></div>
        <div id="tabHistory" class="hide"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="mTitle">Modal</div>
        <button class="mClose" id="mClose">‚úï</button>
      </div>
      <div class="mBody" id="mBody"></div>
      <div class="mFoot" id="mFoot"></div>
    </div>
  </div>

  <div class="toast" id="toast"><span id="toastMsg"></span></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getDatabase, ref, get, set, update, push, remove, onValue, runTransaction,
      serverTimestamp, query, orderByChild
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // ================== Firebase Config (TUKAR INI) ==================
const firebaseConfig = {
  apiKey: "AIzaSyCXGxdJOEbcotIXRWyDGHNNCbcmFev-qZY",
  authDomain: "farm-a9071.firebaseapp.com",
  databaseURL: "https://farm-a9071-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "farm-a9071",
  storageBucket: "farm-a9071.firebasestorage.app",
  messagingSenderId: "979250293394",
  appId: "1:979250293394:web:af419dd2b325017a41944b"
};
    // ================================================================

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const $ = (id)=>document.getElementById(id);
    const money = (n)=>`RM ${Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;
    const nowISO = ()=> new Date().toISOString();

    function toast(msg){
      $("toastMsg").textContent = msg;
      $("toast").classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> $("toast").classList.remove("show"), 2200);
    }

    // ======= Modal helpers =======
    function openModal(title, bodyHTML, footButtonsHTML){
      $("mTitle").textContent = title;
      $("mBody").innerHTML = bodyHTML;
      $("mFoot").innerHTML = footButtonsHTML || "";
      $("backdrop").classList.add("show");
    }
    function closeModal(){ $("backdrop").classList.remove("show"); }
    $("mClose").addEventListener("click", closeModal);
    $("backdrop").addEventListener("click", (e)=>{ if(e.target === $("backdrop")) closeModal(); });

    // ======= State =======
    let currentUser = null;
    let profile = null;
    let isAdmin = false;
    let walletBalance = 0;

    function setRoleUI(){
      $("roleText").textContent = isAdmin ? "‚Ä¢ ADMIN" : "‚Ä¢ USER";
      $("btnAddPoint").classList.toggle("hide", !isAdmin);
    }

    async function loadProfile(uid){
      const p = await get(ref(db, `users/${uid}/profile`));
      profile = p.exists() ? p.val() : { username: "User" };
      $("navUsername").textContent = profile.username || "User";
    }

    async function loadAdminFlag(uid){
      // Admin ditentukan oleh node: admins/{uid} = true
      const a = await get(ref(db, `admins/${uid}`));
      isAdmin = !!(a.exists() && a.val() === true);
      setRoleUI();
    }

    function watchWallet(uid){
      onValue(ref(db, `wallets/${uid}/balance`), (snap)=>{
        walletBalance = snap.exists() ? Number(snap.val()||0) : 0;
        $("balanceText").textContent = money(walletBalance);
        $("balanceText").className = walletBalance < 0 ? "neg" : "";
      });
    }

    // ======= Wallet ops (admin only for Add Point) =======
    async function walletAdjust(uid, type, amount, note){
      amount = Number(amount||0);
      if(!(amount > 0)) throw new Error("Amount invalid");
      const delta = (type === "IN") ? amount : -amount;
      const txRef = push(ref(db, `walletTx/${uid}`));
      const tx = { type, amount, delta, note: note||"", createdAt: serverTimestamp(), createdAtISO: nowISO() };

      // atomic update balance
      await runTransaction(ref(db, `wallets/${uid}/balance`), (cur)=>{
        cur = Number(cur||0);
        return cur + delta;
      });

      await set(txRef, tx);
      await update(ref(db, `wallets/${uid}`), { updatedAt: serverTimestamp(), updatedAtISO: nowISO() });
    }

    // ======= Vault model =======
    // vaults/{uid}/{vaultId}: { title, status:'open'|'closed', createdAt, updatedAt, buyTotal, sellTotal, sellKg, sellEkor }
    // vaultTx/{uid}/{vaultId}/{txId}: { kind:'cash'|'buy'|'sell', ... , createdAt }
    function vaultRoot(uid){ return ref(db, `vaults/${uid}`); }
    function vaultTxRoot(uid, vaultId){ return ref(db, `vaultTx/${uid}/${vaultId}`); }

    async function createVault(uid, title){
      const vRef = push(vaultRoot(uid));
      const v = {
        title: title || "Untitled",
        status: "open",
        createdAt: serverTimestamp(),
        createdAtISO: nowISO(),
        updatedAt: serverTimestamp(),
        updatedAtISO: nowISO(),
        buyTotal: 0,
        sellTotal: 0,
        sellKg: 0,
        sellEkor: 0
      };
      await set(vRef, v);
      toast("Vault created ‚úÖ");
    }

    async function vaultCash(uid, vaultId, type, amount){
      amount = Number(amount||0);
      if(!(amount > 0)) throw new Error("Amount invalid");
      const delta = (type === "CASHIN") ? amount : -amount;

      // update wallet balance
      await runTransaction(ref(db, `wallets/${uid}/balance`), (cur)=> Number(cur||0) + delta);

      const txRef = push(vaultTxRoot(uid, vaultId));
      await set(txRef, {
        kind: "cash",
        type, amount, delta,
        createdAt: serverTimestamp(),
        createdAtISO: nowISO()
      });

      await update(ref(db, `vaults/${uid}/${vaultId}`), {
        updatedAt: serverTimestamp(),
        updatedAtISO: nowISO()
      });

      toast("Cash transfer saved ‚úÖ");
    }

    async function vaultBuy(uid, vaultId, category, ekor, pricePer, total){
      ekor = Number(ekor||0);
      pricePer = Number(pricePer||0);
      total = Number(total||0);
      if(!(total > 0)) throw new Error("Total invalid");

      // spend wallet
      await runTransaction(ref(db, `wallets/${uid}/balance`), (cur)=> Number(cur||0) - total);

      const txRef = push(vaultTxRoot(uid, vaultId));
      await set(txRef, {
        kind:"buy",
        category,
        ekor,
        pricePer,
        total,
        createdAt: serverTimestamp(),
        createdAtISO: nowISO()
      });

      // add buyTotal in vault
      await runTransaction(ref(db, `vaults/${uid}/${vaultId}/buyTotal`), (cur)=> Number(cur||0) + total);
      await update(ref(db, `vaults/${uid}/${vaultId}`), { updatedAt: serverTimestamp(), updatedAtISO: nowISO() });

      toast("Buy saved ‚úÖ");
    }

    async function vaultSell(uid, vaultId, pricePerKg, totalKg, totalEkor){
      pricePerKg = Number(pricePerKg||0);
      totalKg = Number(totalKg||0);
      totalEkor = Number(totalEkor||0);
      if(!(pricePerKg > 0) || !(totalKg > 0)) throw new Error("Sell input invalid");

      const total = pricePerKg * totalKg;

      // add wallet
      await runTransaction(ref(db, `wallets/${uid}/balance`), (cur)=> Number(cur||0) + total);

      const txRef = push(vaultTxRoot(uid, vaultId));
      await set(txRef, {
        kind:"sell",
        pricePerKg, totalKg, totalEkor,
        total,
        createdAt: serverTimestamp(),
        createdAtISO: nowISO()
      });

      // aggregate sell stats
      await runTransaction(ref(db, `vaults/${uid}/${vaultId}/sellTotal`), (cur)=> Number(cur||0) + total);
      await runTransaction(ref(db, `vaults/${uid}/${vaultId}/sellKg`), (cur)=> Number(cur||0) + totalKg);
      await runTransaction(ref(db, `vaults/${uid}/${vaultId}/sellEkor`), (cur)=> Number(cur||0) + totalEkor);

      await update(ref(db, `vaults/${uid}/${vaultId}`), { updatedAt: serverTimestamp(), updatedAtISO: nowISO() });
      toast("Sell saved ‚úÖ");
    }

    async function closeVault(uid, vaultId){
      await update(ref(db, `vaults/${uid}/${vaultId}`), {
        status:"closed",
        updatedAt: serverTimestamp(),
        updatedAtISO: nowISO(),
        closedAt: serverTimestamp(),
        closedAtISO: nowISO()
      });
      toast("Vault closed ‚úÖ");
    }

    // Edit / Delete tx (only admin for safety)
    async function deleteVaultTx(uid, vaultId, txId, tx){
      // rollback wallet + vault aggregates based on tx kind
      if(tx.kind === "cash"){
        const delta = Number(tx.delta||0);
        // rollback wallet
        await runTransaction(ref(db, `wallets/${uid}/balance`), (cur)=> Number(cur||0) - delta);
      }
      if(tx.kind === "buy"){
        const total = Number(tx.total||0);
        await runTransaction(ref(db, `wallets/${uid}/balance`), (cur)=> Number(cur||0) + total);
        await runTransaction(ref(db, `vaults/${uid}/${vaultId}/buyTotal`), (cur)=> Number(cur||0) - total);
      }
      if(tx.kind === "sell"){
        const total = Number(tx.total||0);
        await runTransaction(ref(db, `wallets/${uid}/balance`), (cur)=> Number(cur||0) - total);
        await runTransaction(ref(db, `vaults/${uid}/${vaultId}/sellTotal`), (cur)=> Number(cur||0) - total);
        await runTransaction(ref(db, `vaults/${uid}/${vaultId}/sellKg`), (cur)=> Number(cur||0) - Number(tx.totalKg||0));
        await runTransaction(ref(db, `vaults/${uid}/${vaultId}/sellEkor`), (cur)=> Number(cur||0) - Number(tx.totalEkor||0));
      }

      await remove(ref(db, `vaultTx/${uid}/${vaultId}/${txId}`));
      await update(ref(db, `vaults/${uid}/${vaultId}`), { updatedAt: serverTimestamp(), updatedAtISO: nowISO() });
      toast("Deleted ‚úÖ");
    }

    // ======= UI Render =======
    function tabSwitch(which){
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === which);
      });
      $("tabOpen").classList.toggle("hide", which !== "open");
      $("tabHistory").classList.toggle("hide", which !== "history");
    }
    document.querySelectorAll(".tab").forEach(b=> b.addEventListener("click", ()=> tabSwitch(b.dataset.tab)));

    function vaultCardHTML(vId, v){
      const buyTotal = Number(v.buyTotal||0);
      const sellTotal = Number(v.sellTotal||0);
      const profit = sellTotal - buyTotal;              // profit boleh negatif
      const profitAbs = Math.abs(profit);

      const profitClass = profit < 0 ? "neg" : "pos";
      const profitSign = profit < 0 ? "-" : "";

      const created = v.createdAtISO ? new Date(v.createdAtISO).toLocaleString() : "-";
      const updated = v.updatedAtISO ? new Date(v.updatedAtISO).toLocaleString() : "-";

      return `
        <div class="vault" data-vid="${vId}">
          <div class="vaultHead">
            <div>
              <div class="vaultTitle">${escapeHtml(v.title || "Untitled")} ${v.status==="closed" ? '<span class="muted">(Closed)</span>' : ''}</div>
              <div class="vaultMeta">Created: ${created} ‚Ä¢ Updated: ${updated}</div>
            </div>
            <div class="vaultBtns">
              <button class="btn small ghost" data-act="cash" ${v.status==="closed" ? "disabled" : ""}>Cash Transfer</button>
              <button class="btn small ghost" data-act="buy"  ${v.status==="closed" ? "disabled" : ""}>Buy</button>
              <button class="btn small ghost" data-act="sell" ${v.status==="closed" ? "disabled" : ""}>Sell</button>
              <button class="btn small warn" data-act="close" ${v.status==="closed" ? "disabled" : ""}>Closing</button>
            </div>
          </div>

          <div class="footRow">
            <div class="kpi">
              <div class="box"><div class="t">Total Buy</div><div class="v">${money(buyTotal)}</div></div>
              <div class="box"><div class="t">Total Sell</div><div class="v">${money(sellTotal)}</div></div>
              <div class="box"><div class="t">Total Kg</div><div class="v">${Number(v.sellKg||0).toLocaleString()}</div></div>
              <div class="box"><div class="t">Total Ekor</div><div class="v">${Number(v.sellEkor||0).toLocaleString()}</div></div>
              <div class="box">
                <div class="t">Profit / Loss</div>
                <div class="v ${profitClass}">${profitSign}${money(profitAbs)}</div>
              </div>
            </div>
          </div>

          <div style="padding:12px">
            <table class="excel">
              <thead>
                <tr>
                  <th style="width:140px">Date/Time</th>
                  <th style="width:120px">Type</th>
                  <th>Detail</th>
                  <th class="num" style="width:140px">Amount</th>
                  <th style="width:150px">Actions</th>
                </tr>
              </thead>
              <tbody data-txbody="${vId}">
                <tr><td colspan="5" class="muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    function txRowHTML(vId, txId, tx){
      const dt = tx.createdAtISO ? new Date(tx.createdAtISO).toLocaleString() : "-";
      let type = tx.kind;
      let detail = "";
      let amt = 0;

      if(tx.kind === "cash"){
        type = tx.type === "CASHIN" ? "Cash In" : "Cash Out";
        detail = `Wallet ${tx.type === "CASHIN" ? "IN" : "OUT"}`;
        amt = Number(tx.amount||0);
        if(tx.type === "CASHOUT") amt = -amt;
      }
      if(tx.kind === "buy"){
        type = `Buy (${tx.category||"other"})`;
        detail = `Ekor: ${Number(tx.ekor||0)} ‚Ä¢ Price/Ekor: ${money(tx.pricePer||0)}`;
        amt = -Number(tx.total||0);
      }
      if(tx.kind === "sell"){
        type = "Sell";
        detail = `Price/Kg: ${money(tx.pricePerKg||0)} ‚Ä¢ Kg: ${Number(tx.totalKg||0)} ‚Ä¢ Ekor: ${Number(tx.totalEkor||0)}`;
        amt = Number(tx.total||0);
      }

      const amtClass = amt < 0 ? "neg" : (amt > 0 ? "pos" : "");
      const actionButtons = isAdmin
        ? `<button class="btn small ghost" data-act="del" data-vid="${vId}" data-txid="${txId}">Delete</button>`
        : `<span class="muted">No access</span>`;

      return `
        <tr>
          <td class="muted">${dt}</td>
          <td>${escapeHtml(type)}</td>
          <td class="muted">${escapeHtml(detail)}</td>
          <td class="num ${amtClass}">${money(Math.abs(amt))}${amt<0?" -":""}</td>
          <td>${actionButtons}</td>
        </tr>
      `;
    }

    function renderOpenVaults(uid){
      const openWrap = $("tabOpen");
      onValue(query(ref(db, `vaults/${uid}`), orderByChild("updatedAtISO")), (snap)=>{
        const all = snap.exists() ? snap.val() : {};
        // sort newest updatedAtISO desc
        const arr = Object.entries(all).map(([id,v])=>({id, v}));
        arr.sort((a,b)=> String(b.v.updatedAtISO||"").localeCompare(String(a.v.updatedAtISO||"")));
        const openArr = arr.filter(x=> (x.v.status||"open")==="open");

        if(openArr.length === 0){
          openWrap.innerHTML = `<div class="muted">No open vault yet. Click ‚ÄúOpen New Vault‚Äù.</div>`;
          return;
        }

        openWrap.innerHTML = openArr.map(x=> vaultCardHTML(x.id, x.v)).join("");

        // attach actions + watch tx for each vault
        openArr.forEach(({id})=>{
          const body = document.querySelector(`[data-txbody="${id}"]`);
          onValue(ref(db, `vaultTx/${uid}/${id}`), (txSnap)=>{
            const txAll = txSnap.exists() ? txSnap.val() : {};
            const txArr = Object.entries(txAll).map(([tid,t])=>({tid, t}));
            txArr.sort((a,b)=> String(b.t.createdAtISO||"").localeCompare(String(a.t.createdAtISO||"")));
            body.innerHTML = txArr.length
              ? txArr.map(x=> txRowHTML(id, x.tid, x.t)).join("")
              : `<tr><td colspan="5" class="muted">No transaction yet.</td></tr>`;
          });
        });
      });
    }

    function renderHistory(uid){
      const histWrap = $("tabHistory");
      onValue(query(ref(db, `vaults/${uid}`), orderByChild("updatedAtISO")), (snap)=>{
        const all = snap.exists() ? snap.val() : {};
        const arr = Object.entries(all).map(([id,v])=>({id,v}));
        arr.sort((a,b)=> String(b.v.updatedAtISO||"").localeCompare(String(a.v.updatedAtISO||"")));
        const closed = arr.filter(x=> (x.v.status||"open")==="closed");

        if(closed.length === 0){
          histWrap.innerHTML = `<div class="muted">No history yet.</div>`;
          return;
        }

        histWrap.innerHTML = closed.map(({id,v})=>{
          const created = v.createdAtISO ? new Date(v.createdAtISO).toLocaleString() : "-";
          const closedAt = v.closedAtISO ? new Date(v.closedAtISO).toLocaleString() : "-";
          const buyTotal = Number(v.buyTotal||0);
          const sellTotal = Number(v.sellTotal||0);
          const profit = sellTotal - buyTotal;
          const profitClass = profit < 0 ? "neg" : "pos";
          const titleEdit = isAdmin
            ? `<button class="btn small ghost" data-act="editTitle" data-vid="${id}">Edit</button>`
            : ``;

          return `
            <div class="vault" style="margin-bottom:12px">
              <div class="vaultHead">
                <div>
                  <div class="vaultTitle">${escapeHtml(v.title||"Untitled")} <span class="muted">(Closed)</span></div>
                  <div class="vaultMeta">Created: ${created} ‚Ä¢ Closed: ${closedAt}</div>
                </div>
                <div class="vaultBtns">
                  ${titleEdit}
                </div>
              </div>
              <div class="footRow">
                <div class="kpi">
                  <div class="box"><div class="t">Total Buy</div><div class="v">${money(buyTotal)}</div></div>
                  <div class="box"><div class="t">Total Sell</div><div class="v">${money(sellTotal)}</div></div>
                  <div class="box"><div class="t">Profit / Loss</div><div class="v ${profitClass}">${money(Math.abs(profit))}${profit<0?" -":""}</div></div>
                </div>
              </div>
            </div>
          `;
        }).join("");
      });
    }

    // ======= Header actions =======
    $("btnUser").addEventListener("click", ()=>{
      openModal(
        "Account",
        `<div class="muted">Logged in as <b>${escapeHtml(profile?.username||"User")}</b></div>`,
        `<button class="btn ghost" id="mCancel">Close</button>
         <button class="btn danger" id="mLogout">Logout</button>`
      );
      $("mCancel").onclick = closeModal;
      $("mLogout").onclick = async ()=>{
        await signOut(auth);
        location.replace("../login/");
      };
    });

    $("btnWallet").addEventListener("click", async ()=>{
      openModal(
        "Wallet Balance",
        `<div class="kpi">
           <div class="box" style="min-width:100%"><div class="t">Current Balance</div><div class="v">${money(walletBalance)}</div></div>
         </div>
         <div class="muted" style="margin-top:10px">Balance berubah ikut Add Point / Cash Transfer / Buy / Sell.</div>`,
        `<button class="btn ghost" id="mOk">OK</button>`
      );
      $("mOk").onclick = closeModal;
    });

    $("btnAddPoint").addEventListener("click", ()=>{
      if(!isAdmin) return toast("No access");
      openModal(
        "Add Point (Wallet Adjust)",
        `
          <label>Type</label>
          <select id="apType">
            <option value="IN">IN (Tambah modal)</option>
            <option value="OUT">OUT (Tolak modal)</option>
          </select>

          <div class="row2">
            <div>
              <label>Amount</label>
              <input id="apAmount" type="number" min="0" step="0.01" placeholder="100000"/>
            </div>
            <div>
              <label>Note (optional)</label>
              <input id="apNote" placeholder="modal awal / adjustment"/>
            </div>
          </div>
        `,
        `<button class="btn ghost" id="apCancel">Cancel</button>
         <button class="btn" id="apSave">Save</button>`
      );
      $("apCancel").onclick = closeModal;
      $("apSave").onclick = async ()=>{
        try{
          await walletAdjust(currentUser.uid, $("apType").value, $("apAmount").value, $("apNote").value);
          closeModal();
        }catch(e){ toast(e?.message || "Failed"); }
      };
    });

    $("btnNewVault").addEventListener("click", ()=>{
      openModal(
        "Open New Vault",
        `
          <label>Title</label>
          <input id="vTitle" placeholder="Feb 2026 / Batch A / Bulan 2"/>
          <div class="muted" style="margin-top:8px">Title boleh bulan/nama/angka.</div>
        `,
        `<button class="btn ghost" id="vCancel">Cancel</button>
         <button class="btn" id="vCreate">Create</button>`
      );
      $("vCancel").onclick = closeModal;
      $("vCreate").onclick = async ()=>{
        const t = $("vTitle").value.trim();
        if(t.length < 1) return toast("Title required");
        await createVault(currentUser.uid, t);
        closeModal();
      };
    });

    // Delegated vault actions
    document.addEventListener("click", async (e)=>{
      const vaultEl = e.target.closest(".vault");
      if(!vaultEl) return;

      const vid = vaultEl.getAttribute("data-vid");
      const actBtn = e.target.closest("button[data-act]");
      if(!actBtn) return;

      const act = actBtn.dataset.act;
      if(!vid) return;

      if(act === "cash"){
        openModal(
          "Cash Transfer",
          `
            <label>Type</label>
            <select id="cType">
              <option value="CASHIN">Cash In (Tambah wallet)</option>
              <option value="CASHOUT">Cash Out (Tolak wallet)</option>
            </select>
            <label>Amount</label>
            <input id="cAmount" type="number" min="0" step="0.01" placeholder="1000"/>
          `,
          `<button class="btn ghost" id="cCancel">Cancel</button>
           <button class="btn" id="cSave">Save</button>`
        );
        $("cCancel").onclick = closeModal;
        $("cSave").onclick = async ()=>{
          try{
            await vaultCash(currentUser.uid, vid, $("cType").value, $("cAmount").value);
            closeModal();
          }catch(err){ toast(err?.message || "Failed"); }
        };
      }

      if(act === "buy"){
        openModal(
          "Buy",
          `
            <label>Category</label>
            <select id="bCat">
              <option value="bayi babi">Bayi Babi</option>
              <option value="pakan babi">Pakan Babi</option>
              <option value="other">Other</option>
            </select>

            <div class="row2">
              <div>
                <label>Total Ekor (optional)</label>
                <input id="bEkor" type="number" min="0" step="1" placeholder="10"/>
              </div>
              <div>
                <label>Harga per-ekor (optional)</label>
                <input id="bPrice" type="number" min="0" step="0.01" placeholder="200"/>
              </div>
            </div>

            <label>Total Harga</label>
            <input id="bTotal" type="number" min="0" step="0.01" placeholder="2000"/>
            <div class="muted" id="bHint" style="margin-top:8px"></div>
          `,
          `<button class="btn ghost" id="bCancel">Cancel</button>
           <button class="btn" id="bSave">Save</button>`
        );
        const bTotal = $("bTotal");
        const hint = $("bHint");
        function check(){
          const total = Number(bTotal.value||0);
          if(total > walletBalance){
            bTotal.style.borderColor = "rgba(255,77,77,.8)";
            hint.innerHTML = `<span class="neg">Modal tak cukup.</span> Balance sekarang: <b>${money(walletBalance)}</b>`;
          }else{
            bTotal.style.borderColor = "var(--stroke)";
            hint.innerHTML = `Balance sekarang: <b>${money(walletBalance)}</b>`;
          }
        }
        bTotal.addEventListener("input", check);
        check();

        $("bCancel").onclick = closeModal;
        $("bSave").onclick = async ()=>{
          try{
            const total = Number($("bTotal").value||0);
            if(total > walletBalance) return toast("Modal tak cukup");
            await vaultBuy(currentUser.uid, vid, $("bCat").value, $("bEkor").value, $("bPrice").value, $("bTotal").value);
            closeModal();
          }catch(err){ toast(err?.message || "Failed"); }
        };
      }

      if(act === "sell"){
        openModal(
          "Sell",
          `
            <div class="row2">
              <div>
                <label>Harga per-Kg</label>
                <input id="sPrice" type="number" min="0" step="0.01" placeholder="12.5"/>
              </div>
              <div>
                <label>Total Kg</label>
                <input id="sKg" type="number" min="0" step="0.01" placeholder="100"/>
              </div>
            </div>
            <div class="row2">
              <div>
                <label>Total Ekor</label>
                <input id="sEkor" type="number" min="0" step="1" placeholder="10"/>
              </div>
              <div>
                <label>Total Hasil (auto)</label>
                <input id="sTotal" disabled/>
              </div>
            </div>
          `,
          `<button class="btn ghost" id="sCancel">Cancel</button>
           <button class="btn" id="sSave">Save</button>`
        );
        const sPrice = $("sPrice"), sKg = $("sKg"), sTotal = $("sTotal");
        function calc(){
          const total = Number(sPrice.value||0) * Number(sKg.value||0);
          sTotal.value = money(total);
        }
        sPrice.addEventListener("input", calc);
        sKg.addEventListener("input", calc);
        calc();

        $("sCancel").onclick = closeModal;
        $("sSave").onclick = async ()=>{
          try{
            await vaultSell(currentUser.uid, vid, sPrice.value, sKg.value, $("sEkor").value);
            closeModal();
          }catch(err){ toast(err?.message || "Failed"); }
        };
      }

      if(act === "close"){
        openModal(
          "Closing Vault",
          `<div class="muted">Bila closing, vault akan masuk History (tak boleh tambah transaction lagi).</div>`,
          `<button class="btn ghost" id="clCancel">Cancel</button>
           <button class="btn warn" id="clOk">Close Vault</button>`
        );
        $("clCancel").onclick = closeModal;
        $("clOk").onclick = async ()=>{
          await closeVault(currentUser.uid, vid);
          closeModal();
        };
      }

      if(act === "del"){
        if(!isAdmin) return toast("No access");
        const txId = actBtn.dataset.txid;
        // get tx data first
        const txSnap = await get(ref(db, `vaultTx/${currentUser.uid}/${vid}/${txId}`));
        if(!txSnap.exists()) return;
        const tx = txSnap.val();

        openModal(
          "Delete Transaction",
          `<div class="muted">Confirm delete? Sistem akan rollback balance & totals.</div>`,
          `<button class="btn ghost" id="dCancel">Cancel</button>
           <button class="btn danger" id="dOk">Delete</button>`
        );
        $("dCancel").onclick = closeModal;
        $("dOk").onclick = async ()=>{
          await deleteVaultTx(currentUser.uid, vid, txId, tx);
          closeModal();
        };
      }
    });

    // History edit title (admin only)
    document.addEventListener("click", async (e)=>{
      const b = e.target.closest("button[data-act='editTitle']");
      if(!b) return;
      if(!isAdmin) return toast("No access");
      const vid = b.dataset.vid;

      const vSnap = await get(ref(db, `vaults/${currentUser.uid}/${vid}`));
      if(!vSnap.exists()) return;
      const v = vSnap.val();

      openModal(
        "Edit Vault Title",
        `<label>Title</label><input id="etTitle" value="${escapeHtml(v.title||"")}"/>`,
        `<button class="btn ghost" id="etCancel">Cancel</button>
         <button class="btn" id="etSave">Save</button>`
      );
      $("etCancel").onclick = closeModal;
      $("etSave").onclick = async ()=>{
        const t = $("etTitle").value.trim();
        if(!t) return toast("Title required");
        await update(ref(db, `vaults/${currentUser.uid}/${vid}`), { title:t, updatedAt: serverTimestamp(), updatedAtISO: nowISO() });
        toast("Updated ‚úÖ");
        closeModal();
      };
    });

    // ======= Auth boot =======
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.replace("../login/");
        return;
      }
      currentUser = user;
      await loadProfile(user.uid);
      await loadAdminFlag(user.uid);
      watchWallet(user.uid);

      renderOpenVaults(user.uid);
      renderHistory(user.uid);
    });
  </script>
</body>
</html>
